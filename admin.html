<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Dainty v3</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    *{-webkit-tap-highlight-color:transparent;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;margin:0;background:#f5f5f5}
    input,select,button,textarea{font-size:16px!important}
    .spin{animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .fade{animation:fade .2s ease-in}
    @keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .card{background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,.08);overflow:hidden}
    .btn{border:none;border-radius:10px;padding:12px 20px;font-weight:600;cursor:pointer;transition:all .2s}
    .btn-p{background:linear-gradient(135deg,#dc2626,#b91c1c);color:#fff}
    .btn-s{background:#f3f4f6;color:#374151}
    .btn-sm{padding:8px 12px;font-size:13px}
    .inp{width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:12px;background:#fff}
    .inp:focus{outline:none;border-color:#b91c1c;box-shadow:0 0 0 3px rgba(185,28,28,.1)}
    .lbl{font-size:12px;color:#6b7280;font-weight:500;display:block;margin-bottom:4px}
    .tbl-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
    .low{background:#dcfce7;color:#166534}
    .high{background:#fee2e2;color:#991b1b}
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useCallback,useMemo}=React;

async function api(url,action,params={}){
  if(!url)throw new Error('API URL not set');
  const u=new URL(url);
  u.searchParams.set('action',action);
  Object.entries(params).forEach(([k,v])=>{if(v!=null)u.searchParams.set(k,typeof v==='object'?JSON.stringify(v):v)});
  const r=await fetch(u.toString());
  const d=await r.json();
  if(d.error)throw new Error(d.error);
  return d;
}

const fmt=n=>'â‚±'+(parseFloat(n)||0).toLocaleString('en-PH',{minimumFractionDigits:2,maximumFractionDigits:2});
const fmtDate=d=>{
  if(!d)return'-';
  let date;
  if(typeof d==='string'&&d.includes('T')){
    date=new Date(d);
  }else if(typeof d==='string'&&d.match(/^\d{4}-\d{2}-\d{2}$/)){
    date=new Date(d+'T00:00:00');
  }else{
    date=new Date(d);
  }
  if(isNaN(date.getTime()))return'-';
  return date.toLocaleDateString('en-PH',{month:'short',day:'numeric',year:'numeric'});
};
const fmtPrice=(p,u)=>{
  if(!p||p===0)return'-';
  let dp=p,du='/'+u;
  if(u==='g'){dp=p*1000;du='/kg'}
  else if(u==='ml'){dp=p*1000;du='/L'}
  return dp.toFixed(2)+du;
};

const downloadCSV=(data,name)=>{
  if(!data?.length)return;
  const h=Object.keys(data[0]);
  const csv=[h.join(','),...data.map(r=>h.map(k=>{let v=r[k]??'';if(typeof v==='string'&&(v.includes(',')||v.includes('"')))v='"'+v.replace(/"/g,'""')+'"';return v}).join(','))].join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=name+'_'+new Date().toISOString().split('T')[0]+'.csv';a.click();
  URL.revokeObjectURL(url);
};

function App(){
  const HARDCODED_API_URL = 'https://script.google.com/macros/s/AKfycbxqSdXxqCna9TvELBaN-SBR-4xTIFU8duQF3KYBq14UTjJBF_ORGUWYZZy86pH-59Iv0Q/exec';
  const[apiUrl,setApiUrl]=useState(HARDCODED_API_URL||localStorage.getItem('dainty_api')||'');
  const[authenticated,setAuthenticated]=useState(!!localStorage.getItem('dainty_admin_auth'));
  const[password,setPassword]=useState('');
  const[loginError,setLoginError]=useState('');
  const[loggingIn,setLoggingIn]=useState(false);
  const[ready,setReady]=useState(!!HARDCODED_API_URL||!!localStorage.getItem('dainty_api'));
  const[tab,setTab]=useState('dashboard');
  const[branch,setBranch]=useState(localStorage.getItem('dainty_branch')||'All');
  const[loading,setLoading]=useState(false);
  const[toast,setToast]=useState(null);
  const[settings,setSettings]=useState({});
  const[branches,setBranches]=useState([]);
  const[ingredients,setIngredients]=useState([]);
  const[dishes,setDishes]=useState([]);
  const[dishCats,setDishCats]=useState([]);
  const[ingCats,setIngCats]=useState([]);
  const[purchases,setPurchases]=useState([]);
  const[expenses,setExpenses]=useState([]);
  const[rowCounts,setRowCounts]=useState({total:0,percentUsed:0,status:'normal',counts:{}});

  const showToast=(msg,type='success')=>{setToast({msg,type});setTimeout(()=>setToast(null),3000)};
  const saveUrl=()=>{localStorage.setItem('dainty_api',apiUrl);setReady(true)};
  useEffect(()=>{if(branch)localStorage.setItem('dainty_branch',branch)},[branch]);

  const login=async()=>{
    if(!password){setLoginError('Enter password');return}
    setLoggingIn(true);setLoginError('');
    try{
      const r=await api(apiUrl,'verifyBranchPassword',{branchCode:'ADMIN',password});
      if(r.success){
        localStorage.setItem('dainty_admin_auth',password);
        setAuthenticated(true);
        loadAll();
      }else{
        setLoginError(r.error||'Invalid password');
      }
    }catch(e){setLoginError(e.message)}
    finally{setLoggingIn(false)}
  };

  const logout=()=>{
    localStorage.removeItem('dainty_admin_auth');
    setAuthenticated(false);
    setPassword('');
  };
  useEffect(()=>{if(branch)localStorage.setItem('dainty_branch',branch)},[branch]);

  const loadAll=useCallback(async()=>{
    if(!apiUrl)return;
    setLoading(true);
    try{
      const[s,b,i,d,dc,ic,rc]=await Promise.all([
        api(apiUrl,'getSettings'),api(apiUrl,'getBranches'),api(apiUrl,'getIngredients'),
        api(apiUrl,'getDishes'),api(apiUrl,'getDishCategories'),api(apiUrl,'getIngredientCategories'),api(apiUrl,'getRowCounts')
      ]);
      setSettings(s.settings||{});setBranches(b.branches||[]);setIngredients(i.ingredients||[]);
      setDishes(d.dishes||[]);setDishCats(dc.categories||[]);setIngCats(ic.categories||[]);setRowCounts(rc);
    }catch(e){showToast(e.message,'error')}
    finally{setLoading(false)}
  },[apiUrl]);

  const loadTx=useCallback(async()=>{
    if(!apiUrl)return;
    try{
      const br=branch==='All'?'':branch;
      const[p,e]=await Promise.all([api(apiUrl,'getPurchases',{branch:br,days:30}),api(apiUrl,'getExpenses',{branch:br,days:30})]);
      setPurchases(p.purchases||[]);setExpenses(e.expenses||[]);
    }catch(e){console.error(e)}
  },[apiUrl,branch]);

  useEffect(()=>{if(ready&&authenticated)loadAll()},[ready,authenticated,loadAll]);
  useEffect(()=>{if(ready&&authenticated)loadTx()},[ready,authenticated,branch,loadTx]);

  // Login screen
  if(!authenticated)return(
    <div className="min-h-screen flex items-center justify-center p-4" style={{background:'linear-gradient(135deg,#b91c1c,#7f1d1d)'}}>
      <div className="card p-8 max-w-sm w-full fade">
        <div className="text-center mb-6">
          <div className="text-6xl mb-4">ğŸ‘‘</div>
          <h1 className="text-2xl font-bold text-gray-800">Admin Login</h1>
          <p className="text-gray-500 text-sm mt-1">Dainty Restaurant System</p>
        </div>
        {loginError&&<div className="mb-4 p-3 rounded-lg bg-red-100 text-red-700 text-sm">{loginError}</div>}
        <div className="mb-4">
          <label className="lbl">Password</label>
          <input type="password" value={password} onChange={e=>setPassword(e.target.value)} onKeyDown={e=>e.key==='Enter'&&login()} placeholder="Enter admin password" className="inp"/>
        </div>
        <button onClick={login} disabled={loggingIn} className="btn btn-p w-full">{loggingIn?'Verifying...':'Login'}</button>
      </div>
    </div>
  );

  if(!ready)return(
    <div className="min-h-screen flex items-center justify-center p-4" style={{background:'linear-gradient(135deg,#b91c1c,#7f1d1d)'}}>
      <div className="card p-8 max-w-md w-full fade">
        <div className="text-center mb-6">
          <div className="text-6xl mb-4">ğŸœ</div>
          <h1 className="text-2xl font-bold text-gray-800">Dainty Restaurant System</h1>
          <p className="text-gray-500 text-sm mt-1">Cloud-based management v3</p>
        </div>
        <div className="mb-4">
          <label className="lbl">Google Apps Script URL</label>
          <input value={apiUrl} onChange={e=>setApiUrl(e.target.value)} placeholder="https://script.google.com/macros/s/.../exec" className="inp"/>
        </div>
        <button onClick={saveUrl} disabled={!apiUrl} className="btn btn-p w-full" style={{opacity:apiUrl?1:.5}}>Connect</button>
        <div className="mt-6 p-4 bg-amber-50 rounded-xl text-sm">
          <p className="font-semibold text-amber-800 mb-2">ğŸ“‹ Setup:</p>
          <ol className="text-amber-700 space-y-1 pl-4 list-decimal text-xs">
            <li>Create new Google Sheet</li>
            <li>Extensions â†’ Apps Script</li>
            <li>Paste script code</li>
            <li>Run <code className="bg-amber-200 px-1 rounded">setupSheets</code></li>
            <li>Deploy â†’ Web App</li>
            <li>Copy URL here</li>
          </ol>
        </div>
      </div>
    </div>
  );

  return(
    <div className="min-h-screen bg-gray-100 pb-4">
      {toast&&<div className="fixed top-4 left-1/2 -translate-x-1/2 z-50 px-6 py-3 rounded-xl shadow-lg text-white font-medium fade" style={{background:toast.type==='success'?'#10b981':'#ef4444'}}>{toast.msg}</div>}
      
      <header className="sticky top-0 z-40" style={{background:'linear-gradient(135deg,#dc2626,#991b1b)'}}>
        <div className="p-4 text-white">
          <div className="flex justify-between items-center mb-3">
            <div className="flex items-center gap-2">
              <span className="text-2xl">ğŸœ</span>
              <div><h1 className="text-lg font-bold leading-tight">Dainty System</h1><p className="text-xs opacity-75">v3 Cloud</p></div>
            </div>
            <div className="flex items-center gap-2">
              {loading&&<div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full spin"/>}
              <button onClick={()=>{loadAll();loadTx()}} className="p-2 rounded-lg hover:bg-white/20">ğŸ”„</button>
              <button onClick={logout} className="p-2 rounded-lg hover:bg-white/20" title="Logout">ğŸšª</button>
            </div>
          </div>
          <select value={branch} onChange={e=>setBranch(e.target.value)} className="w-full rounded-lg p-3 text-sm font-medium" style={{background:'rgba(255,255,255,.15)',color:'white',border:'1px solid rgba(255,255,255,.3)'}}>
            <option value="All" style={{color:'#1f2937'}}>â­ All Branches</option>
            {branches.map(b=><option key={b.BranchCode} value={b.BranchName} style={{color:'#1f2937'}}>{b.BranchName}</option>)}
          </select>
        </div>
      </header>

      <nav className="bg-white border-b sticky top-[124px] z-30 flex overflow-x-auto">
        {[{id:'dashboard',icon:'ğŸ“Š',l:'Dashboard'},{id:'ai',icon:'ğŸ¤–',l:'AI'},{id:'purchases',icon:'ğŸ›’',l:'Purchases'},{id:'expenses',icon:'ğŸ’°',l:'Expenses'},{id:'ingredients',icon:'ğŸ¥¬',l:'Ingredients'},{id:'dishes',icon:'ğŸ³',l:'Dishes'},{id:'costing',icon:'ğŸ’µ',l:'Costing'},{id:'reports',icon:'ğŸ“ˆ',l:'Reports'},{id:'settings',icon:'âš™ï¸',l:'Settings'}].map(t=>
          <button key={t.id} onClick={()=>setTab(t.id)} className={`flex-none px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 ${tab===t.id?'bg-red-50 text-red-700 border-red-600':'bg-white text-gray-500 border-transparent'}`}>{t.icon} {t.l}</button>
        )}
      </nav>

      {rowCounts.status!=='normal'&&<div className={`mx-4 mt-4 p-3 rounded-xl text-sm font-medium ${rowCounts.status==='critical'?'bg-red-100 text-red-800':'bg-amber-100 text-amber-800'}`}>
        {rowCounts.status==='critical'?'ğŸ”´':'âš ï¸'} Database at {rowCounts.percentUsed}% ({rowCounts.total.toLocaleString()} rows). <button onClick={()=>setTab('settings')} className="underline ml-1">Archive â†’</button>
      </div>}

      <main className="p-4">
        {tab==='dashboard'&&<Dashboard purchases={purchases} expenses={expenses} dishes={dishes} rowCounts={rowCounts} setTab={setTab} branch={branch}/>}
        {tab==='ai'&&<AIAssistant apiUrl={apiUrl} purchases={purchases} expenses={expenses} ingredients={ingredients} dishes={dishes} showToast={showToast}/>}
        {tab==='purchases'&&<Purchases apiUrl={apiUrl} branch={branch} branches={branches} settings={settings} purchases={purchases} showToast={showToast} loadTx={loadTx}/>}
        {tab==='expenses'&&<Expenses apiUrl={apiUrl} branch={branch} branches={branches} settings={settings} expenses={expenses} showToast={showToast} loadTx={loadTx}/>}
        {tab==='ingredients'&&<Ingredients apiUrl={apiUrl} ingredients={ingredients} ingCats={ingCats} settings={settings} purchases={purchases} dishes={dishes} showToast={showToast} loadAll={loadAll}/>}
        {tab==='dishes'&&<Dishes apiUrl={apiUrl} dishes={dishes} dishCats={dishCats} ingredients={ingredients} purchases={purchases} showToast={showToast} loadAll={loadAll}/>}
        {tab==='costing'&&<Costing apiUrl={apiUrl} dishes={dishes} branches={branches} branch={branch} settings={settings} showToast={showToast}/>}
        {tab==='reports'&&<Reports apiUrl={apiUrl} branches={branches} branch={branch} purchases={purchases} expenses={expenses} dishes={dishes} showToast={showToast}/>}
        {tab==='settings'&&<Settings apiUrl={apiUrl} setApiUrl={setApiUrl} setReady={setReady} settings={settings} branches={branches} rowCounts={rowCounts} showToast={showToast} loadAll={loadAll}/>}
      </main>
    </div>
  );
}

function Dashboard({purchases,expenses,dishes,rowCounts,setTab}){
  // Use local date, not UTC
  const todayDate=new Date();
  const today=todayDate.getFullYear()+'-'+String(todayDate.getMonth()+1).padStart(2,'0')+'-'+String(todayDate.getDate()).padStart(2,'0');
  
  // Helper to normalize date to YYYY-MM-DD
  const normalizeDate=(d)=>{
    if(!d)return '';
    if(typeof d==='string'){
      return d.split('T')[0];
    }
    if(d instanceof Date || (d && d.getFullYear)){
      return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
    }
    return String(d).split('T')[0];
  };
  
  const tp=purchases.filter(p=>normalizeDate(p.PurchaseDate)===today);
  const te=expenses.filter(e=>normalizeDate(e.Date)===today);
  const tpT=tp.reduce((s,p)=>s+(parseFloat(p.Price)||0),0);
  const teT=te.reduce((s,e)=>s+(parseFloat(e.Amount)||0),0);
  
  // This month stats
  const monthStart=new Date(todayDate.getFullYear(),todayDate.getMonth(),1);
  const mp=purchases.filter(p=>new Date(p.PurchaseDate)>=monthStart);
  const me=expenses.filter(e=>new Date(e.Date)>=monthStart);
  const mpT=mp.reduce((s,p)=>s+(parseFloat(p.Price)||0),0);
  const meT=me.reduce((s,e)=>s+(parseFloat(e.Amount)||0),0);
  
  // Selected item for detail modal
  const[selectedItem,setSelectedItem]=useState(null);
  
  // Combine today's activity
  const todayActivity=[
    ...tp.map(p=>({...p,_type:'purchase'})),
    ...te.map(e=>({...e,_type:'expense'}))
  ];

  return(
    <div className="space-y-4 fade">
      {/* Detail Modal */}
      {selectedItem&&<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={()=>setSelectedItem(null)}>
        <div className="bg-white rounded-2xl p-4 max-w-md w-full fade max-h-[90vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-lg font-bold text-gray-800">{selectedItem._type==='purchase'?'ğŸ›’ Purchase Details':'ğŸ’° Expense Details'}</h3>
            <button onClick={()=>setSelectedItem(null)} className="text-2xl text-gray-400">âœ•</button>
          </div>
          
          {selectedItem._type==='purchase'?(
            <div className="space-y-3">
              <div className="p-3 bg-red-50 rounded-xl">
                <p className="text-xs text-gray-500 mb-1">Item</p>
                <p className="text-lg font-bold text-red-800">{selectedItem.ItemName}</p>
              </div>
              <div className="grid grid-cols-2 gap-3">
                <div className="p-3 bg-gray-50 rounded-xl">
                  <p className="text-xs text-gray-500 mb-1">Total Price</p>
                  <p className="text-xl font-bold text-red-700">{fmt(selectedItem.Price)}</p>
                </div>
                <div className="p-3 bg-gray-50 rounded-xl">
                  <p className="text-xs text-gray-500 mb-1">Quantity</p>
                  <p className="text-xl font-bold text-gray-800">{selectedItem.Qty} {selectedItem.ContainerType||selectedItem.Unit}</p>
                </div>
              </div>
              <div className="p-3 bg-blue-50 rounded-xl">
                <p className="text-xs text-gray-500 mb-1">Price per {selectedItem.ContainerType||selectedItem.Unit||'unit'}</p>
                <p className="text-lg font-bold text-blue-700">â‚±{((parseFloat(selectedItem.Price)||0)/(parseFloat(selectedItem.Qty)||1)).toFixed(2)} / {selectedItem.ContainerType||selectedItem.Unit||'unit'}</p>
              </div>
              <div className="grid grid-cols-2 gap-3">
                <div className="p-3 bg-gray-50 rounded-xl">
                  <p className="text-xs text-gray-500 mb-1">ğŸ“… Date</p>
                  <p className="font-medium text-gray-800">{fmtDate(selectedItem.PurchaseDate)}</p>
                </div>
                <div className="p-3 bg-gray-50 rounded-xl">
                  <p className="text-xs text-gray-500 mb-1">ğŸª Branch</p>
                  <p className="font-medium text-gray-800">{selectedItem.BranchCode||'-'}</p>
                </div>
              </div>
              <div className="grid grid-cols-2 gap-3">
                <div className="p-3 bg-gray-50 rounded-xl">
                  <p className="text-xs text-gray-500 mb-1">ğŸ“¦ Category</p>
                  <p className="font-medium text-gray-800">{selectedItem.Category||'-'}</p>
                </div>
                <div className="p-3 bg-gray-50 rounded-xl">
                  <p className="text-xs text-gray-500 mb-1">ğŸšš Supplier</p>
                  <p className="font-medium text-gray-800">{selectedItem.Supplier||'-'}</p>
                </div>
              </div>
            </div>
          ):(
            <div className="space-y-3">
              <div className="p-3 bg-amber-50 rounded-xl">
                <p className="text-xs text-gray-500 mb-1">Description</p>
                <p className="text-lg font-bold text-amber-800">{selectedItem.Description}</p>
              </div>
              <div className="p-3 bg-gray-50 rounded-xl">
                <p className="text-xs text-gray-500 mb-1">Amount</p>
                <p className="text-2xl font-bold text-amber-600">{fmt(selectedItem.Amount)}</p>
              </div>
              <div className="grid grid-cols-2 gap-3">
                <div className="p-3 bg-gray-50 rounded-xl">
                  <p className="text-xs text-gray-500 mb-1">ğŸ“… Date</p>
                  <p className="font-medium text-gray-800">{fmtDate(selectedItem.Date)}</p>
                </div>
                <div className="p-3 bg-gray-50 rounded-xl">
                  <p className="text-xs text-gray-500 mb-1">ğŸª Branch</p>
                  <p className="font-medium text-gray-800">{selectedItem.BranchCode||'-'}</p>
                </div>
              </div>
              <div className="grid grid-cols-2 gap-3">
                <div className="p-3 bg-gray-50 rounded-xl">
                  <p className="text-xs text-gray-500 mb-1">ğŸ“¦ Category</p>
                  <p className="font-medium text-gray-800">{selectedItem.Category||'-'}</p>
                </div>
                <div className="p-3 bg-gray-50 rounded-xl">
                  <p className="text-xs text-gray-500 mb-1">ğŸ¢ Vendor</p>
                  <p className="font-medium text-gray-800">{selectedItem.Vendor||'-'}</p>
                </div>
              </div>
              <div className="p-3 bg-gray-50 rounded-xl">
                <p className="text-xs text-gray-500 mb-1">ğŸ’³ Payment Method</p>
                <p className="font-medium text-gray-800">{selectedItem.PayMethod||'-'}</p>
              </div>
            </div>
          )}
          
          <button onClick={()=>setSelectedItem(null)} className="btn btn-p w-full mt-4">Close</button>
        </div>
      </div>}
      
      <div className="flex items-center justify-between">
        <h2 className="text-lg font-bold text-gray-800">ğŸ“Š Dashboard</h2>
        <span className="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">ğŸ’¾ {(rowCounts.total||0).toLocaleString()} rows ({rowCounts.percentUsed||0}%)</span>
      </div>
      
      {/* Today's Stats - Clickable */}
      <div className="grid grid-cols-2 gap-3">
        <div onClick={()=>setTab('purchases')} className="card p-4 cursor-pointer hover:scale-[1.02] transition-transform active:scale-[0.98]" style={{background:'linear-gradient(135deg,#dc2626,#b91c1c)'}}>
          <p className="text-white/80 text-xs">Today's Purchases</p>
          <p className="text-white text-2xl font-bold mt-1">{fmt(tpT)}</p>
          <p className="text-white/60 text-xs mt-1">{tp.length} items â€¢ Tap to view â†’</p>
        </div>
        <div onClick={()=>setTab('expenses')} className="card p-4 cursor-pointer hover:scale-[1.02] transition-transform active:scale-[0.98]" style={{background:'linear-gradient(135deg,#f59e0b,#d97706)'}}>
          <p className="text-white/80 text-xs">Today's Expenses</p>
          <p className="text-white text-2xl font-bold mt-1">{fmt(teT)}</p>
          <p className="text-white/60 text-xs mt-1">{te.length} items â€¢ Tap to view â†’</p>
        </div>
      </div>
      
      {/* This Month Summary */}
      <div className="card p-4">
        <h3 className="font-semibold text-gray-700 mb-3">ğŸ“… This Month</h3>
        <div className="grid grid-cols-2 gap-4">
          <div className="p-3 bg-red-50 rounded-xl">
            <p className="text-xs text-gray-500">Purchases</p>
            <p className="text-xl font-bold text-red-600">{fmt(mpT)}</p>
            <p className="text-xs text-gray-400">{mp.length} transactions</p>
          </div>
          <div className="p-3 bg-amber-50 rounded-xl">
            <p className="text-xs text-gray-500">Expenses</p>
            <p className="text-xl font-bold text-amber-600">{fmt(meT)}</p>
            <p className="text-xs text-gray-400">{me.length} transactions</p>
          </div>
        </div>
      </div>
      
      {/* Overview Stats */}
      <div className="card p-4">
        <h3 className="font-semibold text-gray-700 mb-3">ğŸ“ˆ Total Records (30 days)</h3>
        <div className="grid grid-cols-3 gap-3">
          <div onClick={()=>setTab('purchases')} className="text-center p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition">
            <p className="text-2xl font-bold text-gray-800">{purchases.length}</p>
            <p className="text-xs text-gray-500">Purchases</p>
          </div>
          <div onClick={()=>setTab('expenses')} className="text-center p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition">
            <p className="text-2xl font-bold text-gray-800">{expenses.length}</p>
            <p className="text-xs text-gray-500">Expenses</p>
          </div>
          <div onClick={()=>setTab('dishes')} className="text-center p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition">
            <p className="text-2xl font-bold text-gray-800">{dishes.length}</p>
            <p className="text-xs text-gray-500">Dishes</p>
          </div>
        </div>
      </div>
      
      {/* Today's Activity - Expanded & Clickable */}
      <div className="card">
        <div className="p-4 border-b bg-gray-50">
          <div className="flex justify-between items-center">
            <h3 className="font-semibold text-gray-700">ğŸ• Today's Activity</h3>
            <span className="text-xs text-gray-500">{todayActivity.length} items</span>
          </div>
        </div>
        <div className="max-h-[400px] overflow-y-auto">
          {todayActivity.length===0?<p className="p-8 text-center text-gray-400">No activity today</p>:
            todayActivity.map((item,i)=>(
              <div key={item.UniqueID||i} onClick={()=>setSelectedItem(item)} className="p-4 border-b flex items-center gap-3 cursor-pointer hover:bg-gray-50 active:bg-gray-100 transition">
                <span className="text-2xl">{item._type==='purchase'?'ğŸ›’':'ğŸ’°'}</span>
                <div className="flex-1 min-w-0">
                  <p className="font-medium text-sm truncate">{item._type==='purchase'?item.ItemName:item.Description}</p>
                  <p className="text-xs text-gray-500">
                    {item._type==='purchase'
                      ?`${item.Qty} ${item.ContainerType||item.Unit} â€¢ ${item.Category||'No category'} â€¢ ${item.BranchCode}`
                      :`${item.Category} â€¢ ${item.BranchCode}`
                    }
                  </p>
                </div>
                <div className="text-right">
                  <span className="font-bold text-sm" style={{color:item._type==='purchase'?'#dc2626':'#d97706'}}>{fmt(item._type==='purchase'?item.Price:item.Amount)}</span>
                </div>
                <span className="text-gray-400">â€º</span>
              </div>
            ))
          }
        </div>
      </div>
    </div>
  );
}

// ===== AI ASSISTANT =====
function AIAssistant({apiUrl,purchases,expenses,ingredients,dishes,showToast}){
  const[aiTab,setAiTab]=useState('chat');
  const[question,setQuestion]=useState('');
  const[chatHistory,setChatHistory]=useState([]);
  const[loading,setLoading]=useState(false);
  const[insights,setInsights]=useState(null);
  const[priceAlerts,setPriceAlerts]=useState(null);
  const[alertThreshold,setAlertThreshold]=useState(15);
  
  const askQuestion=async()=>{
    if(!question.trim())return;
    setLoading(true);
    const q=question;
    setQuestion('');
    setChatHistory(prev=>[...prev,{role:'user',text:q}]);
    
    try{
      const r=await api(apiUrl,'askAI',{question:q});
      if(r.error){
        setChatHistory(prev=>[...prev,{role:'ai',text:'âŒ Error: '+r.error}]);
      }else{
        setChatHistory(prev=>[...prev,{role:'ai',text:r.answer}]);
      }
    }catch(e){
      setChatHistory(prev=>[...prev,{role:'ai',text:'âŒ Error: '+e.message}]);
    }finally{
      setLoading(false);
    }
  };
  
  const loadInsights=async()=>{
    setLoading(true);
    setInsights(null);
    try{
      const r=await api(apiUrl,'generateInsights',{});
      if(r.error){
        showToast(r.error,'error');
      }else{
        // Handle both response formats (insights directly or nested in data)
        const insightsData = r.insights || r.data?.insights || r.data || [];
        setInsights(Array.isArray(insightsData) ? insightsData : []);
      }
    }catch(e){
      showToast(e.message,'error');
    }finally{
      setLoading(false);
    }
  };
  
  const loadPriceAlerts=async()=>{
    setLoading(true);
    setPriceAlerts(null);
    try{
      const r=await api(apiUrl,'getPriceAlerts',{threshold:alertThreshold});
      if(r.error){
        showToast(r.error,'error');
      }else{
        setPriceAlerts(r);
      }
    }catch(e){
      showToast(e.message,'error');
    }finally{
      setLoading(false);
    }
  };
  
  const sampleQuestions=[
    "What did we spend on meat this month?",
    "Which branch has the highest expenses?",
    "Compare this month vs last month spending",
    "What are our top 5 purchased ingredients?",
    "Show me seafood price trends",
    "Which supplier do we use most?"
  ];
  
  const fmt=n=>n?'â‚±'+parseFloat(n).toLocaleString(undefined,{maximumFractionDigits:0}):'â‚±0';
  
  return(
    <div className="space-y-4">
      {/* AI Tab Selector */}
      <div className="flex gap-2 bg-gray-100 p-1 rounded-xl">
        <button onClick={()=>setAiTab('chat')} className={`flex-1 py-2 px-4 rounded-lg font-medium transition ${aiTab==='chat'?'bg-white shadow text-purple-700':'text-gray-600'}`}>ğŸ’¬ Ask AI</button>
        <button onClick={()=>setAiTab('insights')} className={`flex-1 py-2 px-4 rounded-lg font-medium transition ${aiTab==='insights'?'bg-white shadow text-purple-700':'text-gray-600'}`}>ğŸ“Š Insights</button>
        <button onClick={()=>setAiTab('alerts')} className={`flex-1 py-2 px-4 rounded-lg font-medium transition ${aiTab==='alerts'?'bg-white shadow text-purple-700':'text-gray-600'}`}>ğŸ”” Price Alerts</button>
      </div>
      
      {/* Chat Tab */}
      {aiTab==='chat'&&<div className="space-y-4">
        <div className="card p-4">
          <h3 className="font-bold text-lg mb-2">ğŸ’¬ Ask About Your Data</h3>
          <p className="text-sm text-gray-500 mb-4">Ask any question about purchases, expenses, ingredients, or business performance.</p>
          
          {/* Sample Questions */}
          <div className="flex flex-wrap gap-2 mb-4">
            {sampleQuestions.map((sq,i)=>(
              <button key={i} onClick={()=>setQuestion(sq)} className="text-xs bg-purple-50 text-purple-700 px-3 py-1 rounded-full hover:bg-purple-100">{sq}</button>
            ))}
          </div>
          
          {/* Chat Input */}
          <div className="flex gap-2">
            <input value={question} onChange={e=>setQuestion(e.target.value)} onKeyDown={e=>e.key==='Enter'&&askQuestion()} placeholder="Type your question..." className="inp flex-1" disabled={loading}/>
            <button onClick={askQuestion} disabled={loading||!question.trim()} className="btn btn-p px-6">{loading?'...':'Ask'}</button>
          </div>
        </div>
        
        {/* Chat History */}
        {chatHistory.length>0&&<div className="card p-4 space-y-3 max-h-96 overflow-y-auto">
          {chatHistory.map((msg,i)=>(
            <div key={i} className={`p-3 rounded-xl ${msg.role==='user'?'bg-purple-100 ml-8':'bg-gray-100 mr-8'}`}>
              <p className="text-xs text-gray-500 mb-1">{msg.role==='user'?'You':'ğŸ¤– AI'}</p>
              <p className="text-sm whitespace-pre-wrap">{msg.text}</p>
            </div>
          ))}
          {loading&&<div className="p-3 rounded-xl bg-gray-100 mr-8">
            <p className="text-xs text-gray-500 mb-1">ğŸ¤– AI</p>
            <div className="flex items-center gap-2"><div className="w-4 h-4 border-2 border-gray-300 border-t-purple-600 rounded-full spin"/>Thinking...</div>
          </div>}
        </div>}
      </div>}
      
      {/* Insights Tab */}
      {aiTab==='insights'&&<div className="space-y-4">
        <div className="card p-4">
          <div className="flex justify-between items-center mb-4">
            <div>
              <h3 className="font-bold text-lg">ğŸ“Š Smart Insights</h3>
              <p className="text-sm text-gray-500">AI-generated analysis of your business data</p>
            </div>
            <button onClick={loadInsights} disabled={loading} className="btn btn-p">{loading?'Analyzing...':'ğŸ”„ Generate'}</button>
          </div>
          
          {loading&&<div className="text-center py-8">
            <div className="w-12 h-12 border-4 border-purple-200 border-t-purple-600 rounded-full spin mx-auto mb-3"/>
            <p className="text-gray-500">AI is analyzing your data...</p>
            <p className="text-xs text-gray-400">This may take 10-15 seconds</p>
          </div>}
          
          {!loading&&insights&&insights.length>0&&<div className="space-y-3">
            {insights.map((ins,i)=>(
              <div key={i} className={`p-4 rounded-xl border-l-4 ${ins.type==='alert'?'bg-red-50 border-red-500':ins.type==='warning'?'bg-amber-50 border-amber-500':ins.type==='success'?'bg-green-50 border-green-500':'bg-blue-50 border-blue-500'}`}>
                <div className="flex items-start gap-3">
                  <span className="text-2xl">{ins.icon}</span>
                  <div>
                    <p className="font-semibold">{ins.title}</p>
                    <p className="text-sm text-gray-600 mt-1">{ins.detail}</p>
                  </div>
                </div>
              </div>
            ))}
          </div>}
          
          {!loading&&!insights&&<div className="text-center py-8 text-gray-400">
            <p className="text-4xl mb-2">ğŸ“Š</p>
            <p>Click "Generate" to get AI-powered insights</p>
          </div>}
        </div>
      </div>}
      
      {/* Forecast Tab */}
      {aiTab==='alerts'&&<div className="space-y-4">
        <div className="card p-4">
          <div className="flex justify-between items-center mb-4">
            <div>
              <h3 className="font-bold text-lg">ğŸ”” Price Alerts</h3>
              <p className="text-sm text-gray-500">Detect unusual price changes vs historical average</p>
            </div>
            <div className="flex items-center gap-2">
              <select value={alertThreshold} onChange={e=>setAlertThreshold(parseInt(e.target.value))} className="inp w-auto">
                <option value={10}>Â±10% change</option>
                <option value={15}>Â±15% change</option>
                <option value={20}>Â±20% change</option>
                <option value={25}>Â±25% change</option>
              </select>
              <button onClick={loadPriceAlerts} disabled={loading} className="btn btn-p">{loading?'...':'ğŸ” Check Prices'}</button>
            </div>
          </div>
          
          {loading&&<div className="text-center py-8">
            <div className="w-12 h-12 border-4 border-purple-200 border-t-purple-600 rounded-full spin mx-auto mb-3"/>
            <p className="text-gray-500">Analyzing price history...</p>
          </div>}
          
          {!loading&&priceAlerts&&<div className="space-y-4">
            {/* Summary */}
            <div className="grid grid-cols-3 gap-3">
              <div className="bg-gray-100 rounded-xl p-3 text-center">
                <p className="text-2xl font-bold">{priceAlerts.totalChecked}</p>
                <p className="text-xs text-gray-500">Items Checked</p>
              </div>
              <div className="bg-red-100 rounded-xl p-3 text-center">
                <p className="text-2xl font-bold text-red-600">{priceAlerts.alerts?.filter(a=>a.type==='high').length||0}</p>
                <p className="text-xs text-red-600">Price Increases</p>
              </div>
              <div className="bg-green-100 rounded-xl p-3 text-center">
                <p className="text-2xl font-bold text-green-600">{priceAlerts.alerts?.filter(a=>a.type==='low').length||0}</p>
                <p className="text-xs text-green-600">Price Decreases</p>
              </div>
            </div>
            
            {/* Alerts List */}
            {priceAlerts.alerts&&priceAlerts.alerts.length>0?<div className="card overflow-hidden">
              <div className="p-3 bg-gray-50 border-b font-semibold text-sm flex">
                <span className="flex-1">Item</span>
                <span className="w-24 text-right">Avg Price</span>
                <span className="w-24 text-right">Recent</span>
                <span className="w-20 text-center">Change</span>
              </div>
              <div className="max-h-96 overflow-y-auto">
                {priceAlerts.alerts.map((alert,i)=>(
                  <div key={i} className={`p-3 border-b flex items-center text-sm ${alert.type==='high'?'bg-red-50':'bg-green-50'}`}>
                    <div className="flex-1">
                      <p className="font-medium">{alert.name}</p>
                      <p className="text-xs text-gray-500">{alert.category} â€¢ {alert.supplier||'Unknown'} â€¢ {alert.branch}</p>
                      <p className="text-xs text-gray-400">{alert.date}</p>
                    </div>
                    <span className="w-24 text-right text-gray-600">â‚±{alert.avgPrice?.toFixed(2)}/{alert.unit}</span>
                    <span className={`w-24 text-right font-bold ${alert.type==='high'?'text-red-600':'text-green-600'}`}>â‚±{alert.recentPrice?.toFixed(2)}</span>
                    <span className={`w-20 text-center text-xs px-2 py-1 rounded-full font-bold ${alert.type==='high'?'bg-red-200 text-red-800':'bg-green-200 text-green-800'}`}>
                      {alert.type==='high'?'â†‘':'â†“'}{Math.abs(alert.pctChange).toFixed(0)}%
                    </span>
                  </div>
                ))}
              </div>
            </div>:<div className="text-center py-8 text-green-600">
              <p className="text-4xl mb-2">âœ…</p>
              <p className="font-medium">No price anomalies detected!</p>
              <p className="text-sm text-gray-500">All recent purchases are within normal range</p>
            </div>}
          </div>}
          
          {!loading&&!priceAlerts&&<div className="text-center py-8 text-gray-400">
            <p className="text-4xl mb-2">ğŸ””</p>
            <p>Click "Check Prices" to detect anomalies</p>
            <p className="text-sm mt-2">Compares last 7 days vs 60-day average</p>
          </div>}
        </div>
      </div>}
    </div>
  );
}

function Purchases({apiUrl,branch,branches,settings,purchases,showToast,loadTx}){
  const[show,setShow]=useState(false);
  const[saving,setSaving]=useState(false);
  const[selBr,setSelBr]=useState(branch==='All'?(branches[0]?.BranchName||''):branch);
  const[form,setForm]=useState({PurchaseDate:new Date().toISOString().split('T')[0],Supplier:'',items:[{ItemName:'',Qty:'',Unit:'kg',Price:''}]});
  const[filterCat,setFilterCat]=useState('All');
  const[search,setSearch]=useState('');
  const[sortBy,setSortBy]=useState('date');
  const[sortDir,setSortDir]=useState('desc');
  const[selectedPurchase,setSelectedPurchase]=useState(null);
  const[editMode,setEditMode]=useState(false);
  const[editForm,setEditForm]=useState({});
  useEffect(()=>{if(branch!=='All')setSelBr(branch)},[branch]);

  const addItem=()=>setForm({...form,items:[...form.items,{ItemName:'',Qty:'',Unit:'kg',Price:''}]});
  const rmItem=i=>form.items.length>1&&setForm({...form,items:form.items.filter((_,idx)=>idx!==i)});
  const upItem=(i,f,v)=>{const items=[...form.items];items[i]={...items[i],[f]:v};setForm({...form,items})};

  const submit=async()=>{
    const valid=form.items.filter(i=>i.ItemName&&i.Qty&&i.Price);
    if(!valid.length){showToast('Add items','error');return}
    if(!selBr){showToast('Select branch','error');return}
    setSaving(true);
    try{
      await api(apiUrl,'addPurchases',{data:valid.map(i=>({...i,Branch:selBr,PurchaseDate:form.PurchaseDate,Supplier:form.Supplier}))});
      showToast(`Added ${valid.length} items!`);
      setForm({PurchaseDate:form.PurchaseDate,Supplier:form.Supplier,items:[{ItemName:'',Qty:'',Unit:'kg',Price:''}]});
      setShow(false);loadTx();
    }catch(e){showToast(e.message,'error')}finally{setSaving(false)}
  };

  const startEdit=()=>{
    setEditForm({
      ItemName:selectedPurchase.ItemName||'',
      Qty:selectedPurchase.Qty||'',
      Unit:selectedPurchase.Unit||'kg',
      Container:selectedPurchase.ContainerType||selectedPurchase.Container||'',
      Price:selectedPurchase.Price||'',
      Supplier:selectedPurchase.Supplier||'',
      PurchaseDate:selectedPurchase.PurchaseDate?selectedPurchase.PurchaseDate.split('T')[0]:''
    });
    setEditMode(true);
  };

  const saveEdit=async()=>{
    if(!editForm.ItemName||!editForm.Qty||!editForm.Price){showToast('Fill required fields','error');return}
    setSaving(true);
    try{
      await api(apiUrl,'updatePurchase',{
        uniqueId:selectedPurchase.UniqueID,
        data:editForm
      });
      showToast('Updated!');
      setEditMode(false);
      setSelectedPurchase(null);
      loadTx();
    }catch(e){showToast(e.message,'error')}finally{setSaving(false)}
  };

  const deletePurchase=async()=>{
    if(!confirm('Delete this purchase? This cannot be undone.'))return;
    setSaving(true);
    try{
      await api(apiUrl,'deletePurchase',{uniqueId:selectedPurchase.UniqueID});
      showToast('Deleted!');
      setSelectedPurchase(null);
      loadTx();
    }catch(e){showToast(e.message,'error')}finally{setSaving(false)}
  };

  const total=form.items.reduce((s,i)=>s+(parseFloat(i.Price)||0),0);
  const units=(settings.Units||'kg,g,L,ml,pcs,bottle,pack,can,box,bag,bundle,dozen').split(',');
  
  // Get unique categories
  const categories=['All',...new Set(purchases.map(p=>p.Category).filter(Boolean))];
  
  // Filter and sort - compute fresh on every render
  const getFiltered=()=>{
    let result=purchases.slice();
    if(filterCat!=='All')result=result.filter(p=>p.Category===filterCat);
    if(search.trim()!=='')result=result.filter(p=>p.ItemName&&p.ItemName.toLowerCase().indexOf(search.toLowerCase().trim())!==-1);
    result.sort((a,b)=>{
      let cmp=0;
      if(sortBy==='date')cmp=new Date(a.PurchaseDate)-new Date(b.PurchaseDate);
      else if(sortBy==='price')cmp=(parseFloat(a.Price)||0)-(parseFloat(b.Price)||0);
      else if(sortBy==='item')cmp=(a.ItemName||'').localeCompare(b.ItemName||'');
      return sortDir==='desc'?-cmp:cmp;
    });
    return result;
  };
  const filtered=getFiltered();

  return(
    <div className="space-y-4 fade">
      {/* Purchase Detail Modal */}
      {selectedPurchase&&<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={()=>{setSelectedPurchase(null);setEditMode(false)}}>
        <div className="bg-white rounded-2xl p-4 max-w-md w-full fade max-h-[90vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-lg font-bold text-gray-800">{editMode?'âœï¸ Edit Purchase':'ğŸ›’ Purchase Details'}</h3>
            <button onClick={()=>{setSelectedPurchase(null);setEditMode(false)}} className="text-2xl text-gray-400">âœ•</button>
          </div>
          
          {editMode?(
            <div className="space-y-3">
              <div>
                <label className="lbl">Item Name *</label>
                <input value={editForm.ItemName} onChange={e=>setEditForm({...editForm,ItemName:e.target.value})} className="inp"/>
              </div>
              <div className="grid grid-cols-2 gap-2">
                <div>
                  <label className="lbl">Qty *</label>
                  <input type="number" value={editForm.Qty} onChange={e=>setEditForm({...editForm,Qty:e.target.value})} className="inp" step="0.01"/>
                </div>
                <div>
                  <label className="lbl">Container</label>
                  <select value={editForm.Container} onChange={e=>setEditForm({...editForm,Container:e.target.value})} className="inp">
                    <option value="">-- None --</option>
                    <option value="Bottle">Bottle</option>
                    <option value="Bag">Bag</option>
                    <option value="Box">Box</option>
                    <option value="Can">Can</option>
                    <option value="Pack">Pack</option>
                    <option value="Bundle">Bundle</option>
                    <option value="Sack">Sack</option>
                    <option value="Tray">Tray</option>
                    <option value="Piece">Piece</option>
                  </select>
                </div>
              </div>
              <div className="grid grid-cols-2 gap-2">
                <div>
                  <label className="lbl">Base Unit</label>
                  <select value={editForm.Unit} onChange={e=>setEditForm({...editForm,Unit:e.target.value})} className="inp">
                    {units.map(u=><option key={u} value={u.trim()}>{u.trim()}</option>)}
                  </select>
                </div>
                <div>
                  <label className="lbl">Total Price *</label>
                  <input type="number" value={editForm.Price} onChange={e=>setEditForm({...editForm,Price:e.target.value})} className="inp" step="0.01"/>
                </div>
              </div>
              <div>
                <label className="lbl">Supplier</label>
                <input value={editForm.Supplier} onChange={e=>setEditForm({...editForm,Supplier:e.target.value})} className="inp"/>
              </div>
              <div>
                <label className="lbl">Date</label>
                <input type="date" value={editForm.PurchaseDate} onChange={e=>setEditForm({...editForm,PurchaseDate:e.target.value})} className="inp"/>
              </div>
              <div className="flex gap-2 pt-2">
                <button onClick={()=>setEditMode(false)} className="btn btn-s flex-1">Cancel</button>
                <button onClick={saveEdit} disabled={saving} className="btn btn-p flex-1">{saving?'Saving...':'ğŸ’¾ Save'}</button>
              </div>
            </div>
          ):(
            <div className="space-y-3">
              {/* Item Name */}
              <div className="p-3 bg-red-50 rounded-xl">
                <p className="text-xs text-gray-500 mb-1">Item</p>
                <p className="text-lg font-bold text-red-800">{selectedPurchase.ItemName}</p>
              </div>
              
              {/* Get container with fallbacks */}
              {(()=>{
                const container=selectedPurchase.ContainerType||selectedPurchase.Container||selectedPurchase.container||'';
                const displayUnit=container||selectedPurchase.Unit||'unit';
                return <>
                  {/* Price & Quantity */}
                  <div className="grid grid-cols-2 gap-3">
                    <div className="p-3 bg-gray-50 rounded-xl">
                      <p className="text-xs text-gray-500 mb-1">Total Price</p>
                      <p className="text-xl font-bold text-red-700">{fmt(selectedPurchase.Price)}</p>
                    </div>
                    <div className="p-3 bg-gray-50 rounded-xl">
                      <p className="text-xs text-gray-500 mb-1">Quantity</p>
                      <p className="text-xl font-bold text-gray-800">{selectedPurchase.Qty} {displayUnit}</p>
                    </div>
                  </div>
                  
                  {/* Price Per Unit (actual) */}
                  <div className="p-3 bg-blue-50 rounded-xl">
                    <p className="text-xs text-gray-500 mb-1">Price per {displayUnit}</p>
                    <p className="text-lg font-bold text-blue-700">â‚±{((parseFloat(selectedPurchase.Price)||0)/(parseFloat(selectedPurchase.Qty)||1)).toFixed(2)} / {displayUnit}</p>
                  </div>
                </>;
              })()}
              
              {/* Computed Unit Price (per gram/ml) */}
              {selectedPurchase.UnitPrice&&<div className="p-3 bg-green-50 rounded-xl">
                <p className="text-xs text-gray-500 mb-1">Computed Price (for costing)</p>
                <p className="text-lg font-bold text-green-700">â‚±{(parseFloat(selectedPurchase.UnitPrice)||0).toFixed(4)} / {selectedPurchase.BaseUnit||'g'}</p>
              </div>}
              
              {/* Details Grid */}
              <div className="grid grid-cols-2 gap-3">
                <div className="p-3 bg-gray-50 rounded-xl">
                  <p className="text-xs text-gray-500 mb-1">ğŸ“… Date</p>
                  <p className="font-medium text-gray-800">{fmtDate(selectedPurchase.PurchaseDate)}</p>
                </div>
                <div className="p-3 bg-gray-50 rounded-xl">
                  <p className="text-xs text-gray-500 mb-1">ğŸª Branch</p>
                  <p className="font-medium text-gray-800">{selectedPurchase.BranchCode||selectedPurchase.Branch||'-'}</p>
                </div>
              </div>
              
              <div className="grid grid-cols-2 gap-3">
                <div className="p-3 bg-gray-50 rounded-xl">
                  <p className="text-xs text-gray-500 mb-1">ğŸ“¦ Category</p>
                  <p className="font-medium text-gray-800">{selectedPurchase.Category||'-'}</p>
                </div>
                <div className="p-3 bg-gray-50 rounded-xl">
                  <p className="text-xs text-gray-500 mb-1">ğŸ“¦ Container</p>
                  <p className="font-medium text-gray-800">{selectedPurchase.ContainerType||selectedPurchase.Container||'-'}</p>
                </div>
              </div>
              
              <div className="grid grid-cols-2 gap-3">
                <div className="p-3 bg-gray-50 rounded-xl">
                  <p className="text-xs text-gray-500 mb-1">ğŸšš Supplier</p>
                  <p className="font-medium text-gray-800">{selectedPurchase.Supplier||'-'}</p>
                </div>
                <div className="p-3 bg-gray-50 rounded-xl">
                  <p className="text-xs text-gray-500 mb-1">ğŸ“ Base Unit</p>
                  <p className="font-medium text-gray-800">{selectedPurchase.Unit||'-'}</p>
                </div>
              </div>
              
              {/* SKU Info */}
              {selectedPurchase.MasterSKU&&<div className="p-3 bg-purple-50 rounded-xl">
                <p className="text-xs text-gray-500 mb-1">ğŸ”‘ SKU</p>
                <p className="font-mono text-sm text-purple-800">{selectedPurchase.MasterSKU}</p>
              </div>}
              
              {/* UniqueID */}
              <div className="p-3 bg-gray-100 rounded-xl">
                <p className="text-xs text-gray-500 mb-1">ID</p>
                <p className="font-mono text-xs text-gray-600 break-all">{selectedPurchase.UniqueID||'-'}</p>
              </div>
              
              {/* Action Buttons */}
              <div className="flex gap-2 pt-2">
                <button onClick={deletePurchase} disabled={saving} className="btn bg-gray-200 text-gray-700 flex-1">ğŸ—‘ï¸ Delete</button>
                <button onClick={startEdit} className="btn btn-s flex-1">âœï¸ Edit</button>
                <button onClick={()=>setSelectedPurchase(null)} className="btn btn-p flex-1">Close</button>
              </div>
            </div>
          )}
        </div>
      </div>}
      
      <div className="flex justify-between items-center">
        <h2 className="text-lg font-bold text-gray-800">ğŸ›’ Purchases</h2>
        <div className="flex gap-2">
          <button onClick={()=>downloadCSV(purchases,'purchases')} className="btn btn-s btn-sm">ğŸ“¥</button>
          <button onClick={()=>setShow(!show)} className="btn btn-p btn-sm">{show?'âœ•':'+ New'}</button>
        </div>
      </div>

      {show&&<div className="card p-4 fade space-y-3">
        <div className="grid grid-cols-2 gap-3">
          <div><label className="lbl">Date</label><input type="date" value={form.PurchaseDate} onChange={e=>setForm({...form,PurchaseDate:e.target.value})} className="inp"/></div>
          <div><label className="lbl">Branch</label><select value={selBr} onChange={e=>setSelBr(e.target.value)} className="inp">{branches.map(b=><option key={b.BranchCode} value={b.BranchName}>{b.BranchName}</option>)}</select></div>
        </div>
        <div><label className="lbl">Supplier</label><input value={form.Supplier} onChange={e=>setForm({...form,Supplier:e.target.value})} className="inp" placeholder="Supplier"/></div>
        <div className="flex justify-between items-center pt-2"><span className="font-semibold text-gray-700">Items ({form.items.length})</span><button onClick={addItem} className="btn btn-s btn-sm">+ Item</button></div>
        {form.items.map((item,i)=>
          <div key={i} className="p-3 bg-gray-50 rounded-xl space-y-2">
            <div className="flex justify-between items-center"><span className="text-xs text-gray-500 font-medium">#{i+1}</span>{form.items.length>1&&<button onClick={()=>rmItem(i)} className="text-red-500 text-sm font-bold">âœ•</button>}</div>
            <input value={item.ItemName} onChange={e=>upItem(i,'ItemName',e.target.value)} className="inp" placeholder="Item name *"/>
            <div className="grid grid-cols-3 gap-2">
              <input type="number" value={item.Qty} onChange={e=>upItem(i,'Qty',e.target.value)} className="inp" placeholder="Qty *" step="0.01"/>
              <select value={item.Unit} onChange={e=>upItem(i,'Unit',e.target.value)} className="inp">{units.map(u=><option key={u} value={u.trim()}>{u.trim()}</option>)}</select>
              <input type="number" value={item.Price} onChange={e=>upItem(i,'Price',e.target.value)} className="inp" placeholder="â‚± *" step="0.01"/>
            </div>
          </div>
        )}
        {total>0&&<div className="p-3 bg-red-50 rounded-xl flex justify-between items-center"><span className="font-medium text-red-800">Total:</span><span className="text-2xl font-bold text-red-700">{fmt(total)}</span></div>}
        <button onClick={submit} disabled={saving} className="btn btn-p w-full">{saving?'Saving...':'Save Purchase'}</button>
      </div>}

      <div className="card">
        <div className="p-3 border-b bg-gray-50">
          <div className="flex justify-between items-center mb-2">
            <span className="font-semibold text-gray-700">Recent (30 days)</span>
            <span className="text-sm text-gray-500">{filtered.length} items</span>
          </div>
          <div className="mb-2">
            <input value={search} onChange={e=>setSearch(e.target.value)} className="inp" placeholder="ğŸ” Search ingredient..."/>
          </div>
          <div className="flex gap-2 flex-wrap">
            <select value={filterCat} onChange={e=>setFilterCat(e.target.value)} className="text-sm border rounded-lg px-2 py-1 bg-white">
              {categories.map(c=><option key={c} value={c}>{c==='All'?'All Categories':c}</option>)}
            </select>
            <select value={sortBy} onChange={e=>setSortBy(e.target.value)} className="text-sm border rounded-lg px-2 py-1 bg-white">
              <option value="date">Sort: Date</option>
              <option value="price">Sort: Price</option>
              <option value="item">Sort: Item</option>
            </select>
            <button onClick={()=>setSortDir(sortDir==='desc'?'asc':'desc')} className="text-sm border rounded-lg px-2 py-1 bg-white">{sortDir==='desc'?'â†“':'â†‘'}</button>
          </div>
        </div>
        <div className="max-h-96 overflow-y-auto" key={search+filterCat+sortBy+sortDir}>
          {filtered.length===0?<p className="p-8 text-center text-gray-400">No purchases</p>:
            filtered.slice(0,50).map((p,idx)=>{
              const container=p.ContainerType||p.Container||p.container||'';
              const displayUnit=container||p.Unit||'';
              return <div key={p.UniqueID+'_'+idx} onClick={()=>setSelectedPurchase(p)} className="p-3 border-b flex items-center cursor-pointer hover:bg-gray-50 active:bg-gray-100 transition"><div className="flex-1 min-w-0"><p className="font-medium text-sm">{p.ItemName}</p><p className="text-xs text-gray-500">{p.Qty} {displayUnit} â€¢ {p.Category||'No category'} â€¢ {p.BranchCode}</p><p className="text-xs text-green-600 font-medium">â‚±{(parseFloat(p.UnitPrice)||0).toFixed(4)}/{p.BaseUnit||'g'}</p><p className="text-xs text-gray-400">{fmtDate(p.PurchaseDate)}</p></div><span className="font-bold text-red-700">{fmt(p.Price)}</span><span className="ml-2 text-gray-400">â€º</span></div>
            })}
        </div>
      </div>
    </div>
  );
}

function Expenses({apiUrl,branch,branches,settings,expenses,showToast,loadTx}){
  const[show,setShow]=useState(false);
  const[saving,setSaving]=useState(false);
  const[selBr,setSelBr]=useState(branch==='All'?(branches[0]?.BranchName||''):branch);
  const[form,setForm]=useState({Date:new Date().toISOString().split('T')[0],Category:'Utilities',Vendor:'',PayMethod:'Cash',Amount:'',Description:''});
  const[viewPhoto,setViewPhoto]=useState(null);
  const[filterCat,setFilterCat]=useState('All');
  const[search,setSearch]=useState('');
  const[sortBy,setSortBy]=useState('date');
  const[sortDir,setSortDir]=useState('desc');
  const[selectedExpense,setSelectedExpense]=useState(null);
  const[editMode,setEditMode]=useState(false);
  const[editForm,setEditForm]=useState({});
  useEffect(()=>{if(branch!=='All')setSelBr(branch)},[branch]);

  const submit=async()=>{
    if(!form.Description||!form.Amount){showToast('Fill required','error');return}
    if(!selBr){showToast('Select branch','error');return}
    setSaving(true);
    try{
      await api(apiUrl,'addExpense',{data:{...form,Branch:selBr}});
      showToast('Added!');setForm({...form,Vendor:'',Amount:'',Description:''});setShow(false);loadTx();
    }catch(e){showToast(e.message,'error')}finally{setSaving(false)}
  };

  const startEdit=()=>{
    setEditForm({
      Description:selectedExpense.Description||'',
      Amount:selectedExpense.Amount||'',
      Category:selectedExpense.Category||'Utilities',
      Vendor:selectedExpense.Vendor||'',
      PayMethod:selectedExpense.PayMethod||'Cash',
      Date:selectedExpense.Date?String(selectedExpense.Date).split('T')[0]:''
    });
    setEditMode(true);
  };

  const saveEdit=async()=>{
    if(!editForm.Description||!editForm.Amount){showToast('Fill required fields','error');return}
    setSaving(true);
    try{
      await api(apiUrl,'updateExpense',{
        uniqueId:selectedExpense.UniqueID,
        data:editForm
      });
      showToast('Updated!');
      setEditMode(false);
      setSelectedExpense(null);
      loadTx();
    }catch(e){showToast(e.message,'error')}finally{setSaving(false)}
  };

  const deleteExpense=async()=>{
    if(!confirm('Delete this expense? This cannot be undone.'))return;
    setSaving(true);
    try{
      await api(apiUrl,'deleteExpense',{uniqueId:selectedExpense.UniqueID});
      showToast('Deleted!');
      setSelectedExpense(null);
      loadTx();
    }catch(e){showToast(e.message,'error')}finally{setSaving(false)}
  };

  const cats=(settings.ExpenseCategories||'Utilities,Supplies,Maintenance,Transportation,Labor,Marketing,Rent,Other').split(',');
  const pays=(settings.PaymentMethods||'Cash,GCash').split(',');
  
  // Get unique categories for filter
  const categories=['All',...new Set(expenses.map(e=>e.Category).filter(Boolean))];
  
  // Filter and sort - compute fresh on every render
  const getFiltered=()=>{
    let result=expenses.slice();
    if(filterCat!=='All')result=result.filter(e=>e.Category===filterCat);
    if(search.trim()!=='')result=result.filter(e=>(e.Description&&e.Description.toLowerCase().indexOf(search.toLowerCase().trim())!==-1)||(e.Vendor&&e.Vendor.toLowerCase().indexOf(search.toLowerCase().trim())!==-1));
    result.sort((a,b)=>{
      let cmp=0;
      if(sortBy==='date')cmp=new Date(a.Date)-new Date(b.Date);
      else if(sortBy==='amount')cmp=(parseFloat(a.Amount)||0)-(parseFloat(b.Amount)||0);
      else if(sortBy==='desc')cmp=(a.Description||'').localeCompare(b.Description||'');
      return sortDir==='desc'?-cmp:cmp;
    });
    return result;
  };
  const filtered=getFiltered();

  return(
    <div className="space-y-4 fade">
      {/* Photo Viewer */}
      {viewPhoto&&<div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4" onClick={()=>setViewPhoto(null)}><div className="max-w-lg w-full"><img src={viewPhoto} alt="Receipt" className="w-full rounded-lg"/><p className="text-center text-white mt-2 text-sm">Tap to close</p></div></div>}
      
      {/* Expense Detail Modal */}
      {selectedExpense&&<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={()=>{setSelectedExpense(null);setEditMode(false)}}>
        <div className="bg-white rounded-2xl p-4 max-w-md w-full fade max-h-[90vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-lg font-bold text-gray-800">{editMode?'âœï¸ Edit Expense':'ğŸ’° Expense Details'}</h3>
            <button onClick={()=>{setSelectedExpense(null);setEditMode(false)}} className="text-2xl text-gray-400">âœ•</button>
          </div>
          
          {editMode?(
            <div className="space-y-3">
              <div>
                <label className="lbl">Description *</label>
                <input value={editForm.Description} onChange={e=>setEditForm({...editForm,Description:e.target.value})} className="inp"/>
              </div>
              <div className="grid grid-cols-2 gap-2">
                <div>
                  <label className="lbl">Amount *</label>
                  <input type="number" value={editForm.Amount} onChange={e=>setEditForm({...editForm,Amount:e.target.value})} className="inp" step="0.01"/>
                </div>
                <div>
                  <label className="lbl">Category</label>
                  <select value={editForm.Category} onChange={e=>setEditForm({...editForm,Category:e.target.value})} className="inp">
                    {cats.map(c=><option key={c} value={c.trim()}>{c.trim()}</option>)}
                  </select>
                </div>
              </div>
              <div className="grid grid-cols-2 gap-2">
                <div>
                  <label className="lbl">Vendor</label>
                  <input value={editForm.Vendor} onChange={e=>setEditForm({...editForm,Vendor:e.target.value})} className="inp"/>
                </div>
                <div>
                  <label className="lbl">Payment Method</label>
                  <select value={editForm.PayMethod} onChange={e=>setEditForm({...editForm,PayMethod:e.target.value})} className="inp">
                    {pays.map(m=><option key={m} value={m.trim()}>{m.trim()}</option>)}
                  </select>
                </div>
              </div>
              <div>
                <label className="lbl">Date</label>
                <input type="date" value={editForm.Date} onChange={e=>setEditForm({...editForm,Date:e.target.value})} className="inp"/>
              </div>
              <div className="flex gap-2 pt-2">
                <button onClick={()=>setEditMode(false)} className="btn btn-s flex-1">Cancel</button>
                <button onClick={saveEdit} disabled={saving} className="btn btn-p flex-1">{saving?'Saving...':'ğŸ’¾ Save'}</button>
              </div>
            </div>
          ):(
            <div className="space-y-3">
              {/* Description */}
              <div className="p-3 bg-amber-50 rounded-xl">
                <p className="text-xs text-gray-500 mb-1">Description</p>
                <p className="text-lg font-bold text-amber-800">{selectedExpense.Description}</p>
              </div>
              
              {/* Amount */}
              <div className="p-3 bg-gray-50 rounded-xl">
                <p className="text-xs text-gray-500 mb-1">Amount</p>
                <p className="text-2xl font-bold text-amber-600">{fmt(selectedExpense.Amount)}</p>
              </div>
              
              {/* Details Grid */}
              <div className="grid grid-cols-2 gap-3">
                <div className="p-3 bg-gray-50 rounded-xl">
                  <p className="text-xs text-gray-500 mb-1">ğŸ“… Date</p>
                  <p className="font-medium text-gray-800">{fmtDate(selectedExpense.Date)}</p>
                </div>
                <div className="p-3 bg-gray-50 rounded-xl">
                  <p className="text-xs text-gray-500 mb-1">ğŸª Branch</p>
                  <p className="font-medium text-gray-800">{selectedExpense.BranchCode||selectedExpense.Branch||'-'}</p>
                </div>
              </div>
              
              <div className="grid grid-cols-2 gap-3">
                <div className="p-3 bg-gray-50 rounded-xl">
                  <p className="text-xs text-gray-500 mb-1">ğŸ“¦ Category</p>
                  <p className="font-medium text-gray-800">{selectedExpense.Category||'-'}</p>
                </div>
                <div className="p-3 bg-gray-50 rounded-xl">
                  <p className="text-xs text-gray-500 mb-1">ğŸ¢ Vendor</p>
                  <p className="font-medium text-gray-800">{selectedExpense.Vendor||'-'}</p>
                </div>
              </div>
              
              <div className="grid grid-cols-2 gap-3">
                <div className="p-3 bg-gray-50 rounded-xl">
                  <p className="text-xs text-gray-500 mb-1">ğŸ’³ Payment Method</p>
                  <p className="font-medium text-gray-800">{selectedExpense.PayMethod||'-'}</p>
                </div>
                <div className="p-3 bg-gray-50 rounded-xl">
                  <p className="text-xs text-gray-500 mb-1">ğŸ“ Reference</p>
                  <p className="font-medium text-gray-800">{selectedExpense.Reference||'-'}</p>
                </div>
              </div>
              
              {/* Receipt Photo */}
              {selectedExpense.ReceiptPhoto&&<div className="p-3 bg-gray-50 rounded-xl">
                <p className="text-xs text-gray-500 mb-2">ğŸ§¾ Receipt Photo</p>
                <img src={selectedExpense.ReceiptPhoto} alt="Receipt" className="w-full rounded-lg cursor-pointer" onClick={()=>setViewPhoto(selectedExpense.ReceiptPhoto)}/>
              </div>}
              
              {/* UniqueID */}
              <div className="p-3 bg-gray-100 rounded-xl">
                <p className="text-xs text-gray-500 mb-1">ID</p>
                <p className="font-mono text-xs text-gray-600 break-all">{selectedExpense.UniqueID||'-'}</p>
              </div>
              
              {/* Action Buttons */}
              <div className="flex gap-2 pt-2">
                <button onClick={deleteExpense} disabled={saving} className="btn bg-gray-200 text-gray-700 flex-1">ğŸ—‘ï¸ Delete</button>
                <button onClick={startEdit} className="btn btn-s flex-1">âœï¸ Edit</button>
                <button onClick={()=>setSelectedExpense(null)} className="btn btn-p flex-1">Close</button>
              </div>
            </div>
          )}
        </div>
      </div>}
      
      <div className="flex justify-between items-center">
        <h2 className="text-lg font-bold text-gray-800">ğŸ’° Expenses</h2>
        <div className="flex gap-2">
          <button onClick={()=>downloadCSV(expenses,'expenses')} className="btn btn-s btn-sm">ğŸ“¥</button>
          <button onClick={()=>setShow(!show)} className="btn btn-p btn-sm">{show?'âœ•':'+ New'}</button>
        </div>
      </div>

      {show&&<div className="card p-4 fade space-y-3">
        <div className="grid grid-cols-2 gap-3">
          <div><label className="lbl">Date</label><input type="date" value={form.Date} onChange={e=>setForm({...form,Date:e.target.value})} className="inp"/></div>
          <div><label className="lbl">Branch</label><select value={selBr} onChange={e=>setSelBr(e.target.value)} className="inp">{branches.map(b=><option key={b.BranchCode} value={b.BranchName}>{b.BranchName}</option>)}</select></div>
        </div>
        <div className="grid grid-cols-2 gap-3">
          <div><label className="lbl">Category</label><select value={form.Category} onChange={e=>setForm({...form,Category:e.target.value})} className="inp">{cats.map(c=><option key={c} value={c.trim()}>{c.trim()}</option>)}</select></div>
          <div><label className="lbl">Payment</label><select value={form.PayMethod} onChange={e=>setForm({...form,PayMethod:e.target.value})} className="inp">{pays.map(m=><option key={m} value={m.trim()}>{m.trim()}</option>)}</select></div>
        </div>
        <div><label className="lbl">Description *</label><input value={form.Description} onChange={e=>setForm({...form,Description:e.target.value})} className="inp" placeholder="What for?"/></div>
        <div><label className="lbl">Vendor</label><input value={form.Vendor} onChange={e=>setForm({...form,Vendor:e.target.value})} className="inp"/></div>
        <div><label className="lbl">Amount *</label><input type="number" value={form.Amount} onChange={e=>setForm({...form,Amount:e.target.value})} className="inp text-xl font-bold" placeholder="â‚± 0.00" step="0.01"/></div>
        <button onClick={submit} disabled={saving} className="btn btn-p w-full">{saving?'Saving...':'Add Expense'}</button>
      </div>}

      <div className="card">
        <div className="p-3 border-b bg-gray-50">
          <div className="flex justify-between items-center mb-2">
            <span className="font-semibold text-gray-700">Recent (30 days)</span>
            <span className="text-sm text-gray-500">{filtered.length} items</span>
          </div>
          <div className="mb-2">
            <input value={search} onChange={e=>setSearch(e.target.value)} className="inp" placeholder="ğŸ” Search description or vendor..."/>
          </div>
          <div className="flex gap-2 flex-wrap">
            <select value={filterCat} onChange={e=>setFilterCat(e.target.value)} className="text-sm border rounded-lg px-2 py-1 bg-white">
              {categories.map(c=><option key={c} value={c}>{c==='All'?'All Categories':c}</option>)}
            </select>
            <select value={sortBy} onChange={e=>setSortBy(e.target.value)} className="text-sm border rounded-lg px-2 py-1 bg-white">
              <option value="date">Sort: Date</option>
              <option value="amount">Sort: Amount</option>
              <option value="desc">Sort: Description</option>
            </select>
            <button onClick={()=>setSortDir(sortDir==='desc'?'asc':'desc')} className="text-sm border rounded-lg px-2 py-1 bg-white">{sortDir==='desc'?'â†“':'â†‘'}</button>
          </div>
        </div>
        <div className="max-h-96 overflow-y-auto" key={search+filterCat+sortBy+sortDir}>
          {filtered.length===0?<p className="p-8 text-center text-gray-400">No expenses</p>:
            filtered.slice(0,50).map((e,idx)=><div key={e.UniqueID+'_'+idx} onClick={()=>setSelectedExpense(e)} className="p-3 border-b flex items-center cursor-pointer hover:bg-gray-50 active:bg-gray-100 transition">{e.ReceiptPhoto&&<div className="w-10 h-10 rounded-lg overflow-hidden mr-3 flex-shrink-0 bg-gray-200"><img src={e.ReceiptPhoto} alt="" className="w-full h-full object-cover"/></div>}<div className="flex-1 min-w-0"><p className="font-medium text-sm">{e.Description}</p><p className="text-xs text-gray-500">{e.Category} â€¢ {e.BranchCode}</p><p className="text-xs text-gray-400">{fmtDate(e.Date)}</p></div><span className="font-bold text-amber-600">{fmt(e.Amount)}</span><span className="ml-2 text-gray-400">â€º</span></div>)}
        </div>
      </div>
    </div>
  );
}

function Ingredients({apiUrl,ingredients,ingCats,settings,purchases,dishes,showToast,loadAll}){
  const[show,setShow]=useState(false);
  const[edit,setEdit]=useState(null);
  const[viewIng,setViewIng]=useState(null);
  const[showTools,setShowTools]=useState(false);
  const[toolTab,setToolTab]=useState('market');
  const[inactiveDays,setInactiveDays]=useState(30);
  const[saving,setSaving]=useState(false);
  const[search,setSearch]=useState('');
  const[form,setForm]=useState({Name:'',Unit:'g',Category:'Other',YieldPercent:100,ContainerType:'',ContainerSize:'',ContainerUnit:'kg',MarketPrice:''});

  const add=async()=>{
    if(!form.Name){showToast('Enter name','error');return}
    setSaving(true);
    try{await api(apiUrl,'addIngredient',{data:form});showToast('Added!');setForm({Name:'',Unit:'g',Category:'Other',YieldPercent:100,ContainerType:'',ContainerSize:'',ContainerUnit:'kg',MarketPrice:''});setShow(false);loadAll();}
    catch(e){showToast(e.message,'error')}finally{setSaving(false)}
  };
  const del=async sku=>{if(!confirm('Delete?'))return;try{await api(apiUrl,'deleteIngredient',{sku});showToast('Deleted');loadAll();}catch(e){showToast(e.message,'error')}};
  const saveEdit=async()=>{if(!edit)return;setSaving(true);try{await api(apiUrl,'updateIngredient',{sku:edit.MasterSKU,data:JSON.stringify({Name:edit.Name,Unit:edit.Unit,Category:edit.Category,YieldPercent:edit.YieldPercent,ContainerType:edit.ContainerType,ContainerSize:edit.ContainerSize,ContainerUnit:edit.ContainerUnit,MarketPrice:edit.MarketPrice})});showToast('Saved!');setEdit(null);loadAll()}catch(e){showToast(e.message,'error')}finally{setSaving(false)}};

  const filtered=ingredients.filter(i=>i.Name?.toLowerCase().includes(search.toLowerCase()));
  const units=(settings.Units||'g,kg,ml,L,pcs').split(',');
  const containerTypes=['', ...(settings.ContainerTypes||'Sack,Bottle,Can,Box,Pack,Drum,Bag,Tray,Gallon,Piece').split(',').map(s=>s.trim())];
  const containerUnits=(settings.ContainerUnits||'kg,g,L,ml,pcs').split(',').map(s=>s.trim());

  // Get price info for each ingredient from purchases
  const getPriceInfo=(sku)=>{
    const ingPurchases=(purchases||[]).filter(p=>String(p.MasterSKU)===String(sku)&&p.UnitPrice&&parseFloat(p.UnitPrice)>0);
    if(ingPurchases.length===0)return null;
    const prices=ingPurchases.map(p=>parseFloat(p.UnitPrice));
    return{
      avgPrice:prices.reduce((a,b)=>a+b,0)/prices.length,
      minPrice:Math.min(...prices),
      maxPrice:Math.max(...prices),
      count:ingPurchases.length,
      lastDate:ingPurchases.sort((a,b)=>new Date(b.PurchaseDate)-new Date(a.PurchaseDate))[0]?.PurchaseDate
    };
  };

  // Ingredients without market price
  const needMarketPrice=ingredients.filter(ing=>{
    const hasPrice=getPriceInfo(ing.MasterSKU);
    const hasMarket=parseFloat(ing.MarketPrice)>0;
    return !hasPrice&&!hasMarket;
  });

  // Inactive analysis
  const today=new Date();
  const inactiveItems=ingredients.map(ing=>{
    const priceInfo=getPriceInfo(ing.MasterSKU);
    const lastPurchase=priceInfo?.lastDate?new Date(priceInfo.lastDate+'T00:00:00'):null;
    const daysSince=lastPurchase?Math.floor((today-lastPurchase)/(1000*60*60*24)):999;
    return{...ing,lastPurchase:priceInfo?.lastDate,daysSince,hasPrice:!!priceInfo};
  }).filter(ing=>ing.daysSince>=inactiveDays||!ing.hasPrice).sort((a,b)=>b.daysSince-a.daysSince);

  // Bulk market price entry
  const[bulkIdx,setBulkIdx]=useState(0);
  const[bulkPrice,setBulkPrice]=useState('');
  const currentBulk=needMarketPrice[bulkIdx];
  
  const saveBulkPrice=async()=>{
    if(!currentBulk||!bulkPrice)return;
    setSaving(true);
    try{
      const result=await api(apiUrl,'updateIngredient',{sku:currentBulk.MasterSKU,data:JSON.stringify({MarketPrice:parseFloat(bulkPrice)})});
      console.log('Save result:',result);
      showToast(`Saved ${currentBulk.Name}!`);
      setBulkPrice('');
      setBulkIdx(0); // Reset to start
      await loadAll(); // Refresh data to update needMarketPrice list
    }catch(e){console.error(e);showToast(e.message,'error')}finally{setSaving(false)}
  };
  
  const skipBulk=()=>{
    setBulkPrice('');
    if(bulkIdx<needMarketPrice.length-1){
      setBulkIdx(bulkIdx+1);
    }else{
      setBulkIdx(0);
      showToast('Reached end of list');
    }
  };

  // Mark items inactive
  const markInactive=async(items)=>{
    if(items.length===0)return;
    if(!confirm(`Mark ${items.length} items as inactive?`))return;
    setSaving(true);
    try{
      for(const item of items){
        await api(apiUrl,'updateIngredient',{sku:item.MasterSKU,data:JSON.stringify({Active:'No'})});
      }
      showToast(`Marked ${items.length} inactive!`);
      loadAll();
    }catch(e){showToast(e.message,'error')}finally{setSaving(false)}
  };

  return(
    <div className="space-y-4 fade">
      {viewIng&&<IngredientDetail ing={viewIng} purchases={purchases} dishes={dishes} onClose={()=>setViewIng(null)} onEdit={()=>{setViewIng(null);setEdit({...viewIng})}}/>}
      
      {/* Tools Modal */}
      {showTools&&<div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center">
        <div className="bg-white w-full max-w-lg max-h-[90vh] rounded-t-2xl sm:rounded-2xl overflow-hidden flex flex-col fade">
          <div className="p-4 border-b flex justify-between items-center bg-gradient-to-r from-purple-600 to-purple-700 text-white">
            <h3 className="font-bold text-lg">ğŸ› ï¸ Ingredient Tools</h3>
            <button onClick={()=>setShowTools(false)} className="text-2xl text-white/80">âœ•</button>
          </div>
          
          <div className="flex border-b">
            <button onClick={()=>setToolTab('market')} className={`flex-1 p-3 text-sm font-medium ${toolTab==='market'?'border-b-2 border-purple-600 text-purple-600':'text-gray-500'}`}>ğŸ’° Auto Market Prices</button>
            <button onClick={()=>setToolTab('inactive')} className={`flex-1 p-3 text-sm font-medium ${toolTab==='inactive'?'border-b-2 border-purple-600 text-purple-600':'text-gray-500'}`}>ğŸ’¤ Inactive Items</button>
          </div>
          
          <div className="flex-1 overflow-y-auto p-4">
            {toolTab==='market'&&<div className="space-y-4">
              <div className="p-3 bg-amber-50 rounded-xl">
                <p className="text-sm font-semibold text-amber-700">ğŸ’° Bulk Market Price Entry</p>
                <p className="text-xs text-amber-600 mt-1">Quickly add market prices for ingredients without purchase data. Search Google for prices and enter them one by one.</p>
              </div>
              
              <div className="p-3 bg-gray-50 rounded-xl">
                <p className="text-sm text-gray-600"><span className="font-bold text-lg text-red-600">{needMarketPrice.length}</span> ingredients need market prices</p>
              </div>
              
              {needMarketPrice.length===0?<div className="text-center py-8"><p className="text-green-600 font-semibold">âœ… All ingredients have prices!</p></div>:
              <div className="space-y-3">
                <div className="p-4 border-2 border-amber-200 rounded-xl bg-amber-50">
                  <div className="flex justify-between items-start mb-2">
                    <div>
                      <p className="font-bold text-lg">{currentBulk?.Name}</p>
                      <p className="text-sm text-gray-500">{currentBulk?.Category} â€¢ Base unit: {currentBulk?.Unit}</p>
                    </div>
                    <span className="text-xs bg-gray-200 px-2 py-1 rounded-full">{bulkIdx+1}/{needMarketPrice.length}</span>
                  </div>
                  
                  <button onClick={()=>window.open(`https://www.google.com/search?q=price+of+${encodeURIComponent(currentBulk?.Name||'')}+per+${currentBulk?.Unit||'kg'}+Philippines+wholesale`,'_blank')} className="btn btn-s w-full text-sm mb-3">ğŸ” Search Google for Price</button>
                  
                  <div className="flex gap-2">
                    <div className="flex-1">
                      <input type="number" value={bulkPrice} onChange={e=>setBulkPrice(e.target.value)} className="inp" placeholder={`â‚± per ${currentBulk?.Unit||'g'}`} step="0.0001"/>
                    </div>
                  </div>
                  
                  <div className="flex gap-2 mt-3">
                    <button onClick={saveBulkPrice} disabled={saving||!bulkPrice} className="btn btn-p flex-1">{saving?'Saving...':'âœ… Save & Next'}</button>
                    <button onClick={skipBulk} className="btn btn-s flex-1">â­ï¸ Skip</button>
                  </div>
                </div>
                
                <p className="text-xs text-gray-400 text-center">Tip: Search Google, find the price per unit, then enter it above</p>
              </div>}
            </div>}
            
            {toolTab==='inactive'&&<div className="space-y-4">
              <div className="p-3 bg-blue-50 rounded-xl">
                <p className="text-sm font-semibold text-blue-700">ğŸ’¤ Find Unused Ingredients</p>
                <p className="text-xs text-blue-600 mt-1">Identify ingredients not purchased recently to keep your list clean.</p>
              </div>
              
              <div>
                <label className="lbl">Not purchased in last:</label>
                <select value={inactiveDays} onChange={e=>setInactiveDays(parseInt(e.target.value))} className="inp">
                  <option value="7">7 days</option>
                  <option value="14">14 days</option>
                  <option value="30">30 days</option>
                  <option value="60">60 days</option>
                  <option value="90">90 days</option>
                  <option value="180">6 months</option>
                  <option value="365">1 year</option>
                </select>
              </div>
              
              <div className="p-3 bg-gray-50 rounded-xl">
                <p className="text-sm text-gray-600"><span className="font-bold text-lg text-amber-600">{inactiveItems.length}</span> inactive ingredients found</p>
              </div>
              
              {inactiveItems.length>0&&<>
                <div className="max-h-64 overflow-y-auto space-y-2">
                  {inactiveItems.slice(0,20).map(item=><div key={item.MasterSKU} className="p-2 border rounded-lg flex justify-between items-center">
                    <div>
                      <p className="font-medium text-sm">{item.Name}</p>
                      <p className="text-xs text-gray-500">{item.lastPurchase?`Last: ${item.lastPurchase} (${item.daysSince} days ago)`:'Never purchased'}</p>
                    </div>
                    <span className={`text-xs px-2 py-1 rounded-full ${item.daysSince>90?'bg-red-100 text-red-700':item.daysSince>30?'bg-amber-100 text-amber-700':'bg-gray-100 text-gray-600'}`}>{item.daysSince>365?'1y+':item.daysSince+'d'}</span>
                  </div>)}
                  {inactiveItems.length>20&&<p className="text-xs text-gray-400 text-center">+{inactiveItems.length-20} more</p>}
                </div>
                <button onClick={()=>markInactive(inactiveItems)} disabled={saving} className="btn w-full bg-amber-500 text-white">{saving?'Marking...':'ğŸ’¤ Mark All as Inactive'}</button>
              </>}
            </div>}
          </div>
        </div>
      </div>}
      
      {edit&&<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={()=>setEdit(null)}>
        <div className="bg-white rounded-2xl p-4 max-w-md w-full fade max-h-[90vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
          <div className="flex justify-between items-center mb-4">
            <h3 className="font-bold text-lg">âœï¸ Edit Ingredient</h3>
            <button onClick={()=>setEdit(null)} className="text-2xl text-gray-400">âœ•</button>
          </div>
          <div className="space-y-3">
            <div><label className="lbl">Name</label><input value={edit.Name} onChange={e=>setEdit({...edit,Name:e.target.value})} className="inp"/></div>
            <div className="grid grid-cols-2 gap-3">
              <div><label className="lbl">Base Unit (for recipes)</label><select value={edit.Unit||'g'} onChange={e=>setEdit({...edit,Unit:e.target.value})} className="inp">{[...new Set([edit.Unit,...units.map(u=>u.trim())])].filter(Boolean).map(u=><option key={u} value={u}>{u}</option>)}</select></div>
              <div><label className="lbl">Yield %</label><input type="number" value={edit.YieldPercent||100} onChange={e=>setEdit({...edit,YieldPercent:e.target.value})} className="inp"/></div>
            </div>
            <div><label className="lbl">Category</label><select value={edit.Category||''} onChange={e=>setEdit({...edit,Category:e.target.value})} className="inp">{[...new Set([edit.Category,...ingCats.map(c=>c.Category)])].filter(Boolean).map(c=><option key={c} value={c}>{c}</option>)}</select></div>
            
            <div className="p-3 bg-blue-50 rounded-xl">
              <p className="text-sm font-semibold text-blue-700 mb-2">ğŸ“¦ Default Container (optional)</p>
              <p className="text-xs text-blue-600 mb-2">Pre-fills when staff enters purchases</p>
              <div className="grid grid-cols-3 gap-2">
                <div><label className="text-xs text-blue-600">Type</label><select value={edit.ContainerType||''} onChange={e=>setEdit({...edit,ContainerType:e.target.value})} className="inp text-sm">{containerTypes.map(c=><option key={c} value={c}>{c||'(none)'}</option>)}</select></div>
                <div><label className="text-xs text-blue-600">Size</label><input type="number" value={edit.ContainerSize||''} onChange={e=>setEdit({...edit,ContainerSize:e.target.value})} className="inp text-sm" placeholder="25" step="0.1"/></div>
                <div><label className="text-xs text-blue-600">Unit</label><select value={edit.ContainerUnit||'kg'} onChange={e=>setEdit({...edit,ContainerUnit:e.target.value})} className="inp text-sm">{containerUnits.map(u=><option key={u} value={u}>{u}</option>)}</select></div>
              </div>
            </div>
            
            <div className="p-3 bg-amber-50 rounded-xl">
              <p className="text-sm font-semibold text-amber-700 mb-2">ğŸ’° Market Price (fallback)</p>
              <p className="text-xs text-amber-600 mb-2">Used when no purchase data exists for costing</p>
              <div className="flex gap-2">
                <div className="flex-1">
                  <input type="number" value={edit.MarketPrice||''} onChange={e=>setEdit({...edit,MarketPrice:e.target.value})} className="inp text-sm" placeholder={`â‚± per ${edit.Unit||'g'}`} step="0.0001"/>
                </div>
                <button type="button" onClick={()=>window.open(`https://www.google.com/search?q=price+of+${encodeURIComponent(edit.Name)}+per+${edit.Unit||'kg'}+Philippines`,'_blank')} className="btn btn-s text-xs px-3">ğŸ” Search</button>
              </div>
            </div>
            
            <button onClick={saveEdit} disabled={saving} className="btn btn-p w-full">{saving?'Saving...':'ğŸ’¾ Save Changes'}</button>
          </div>
          <p className="text-xs text-gray-400 text-center mt-3">SKU: {edit.MasterSKU}</p>
        </div>
      </div>}

      <div className="flex justify-between items-center">
        <h2 className="text-lg font-bold text-gray-800">ğŸ¥¬ Ingredients</h2>
        <div className="flex gap-2">
          <button onClick={()=>setShowTools(true)} className="btn text-xs px-3 bg-purple-100 text-purple-700">ğŸ› ï¸ Tools</button>
          <button onClick={()=>downloadCSV(ingredients,'ingredients')} className="btn btn-s btn-sm">ğŸ“¥</button>
          <button onClick={()=>setShow(!show)} className="btn btn-p btn-sm">{show?'âœ•':'+ Add'}</button>
        </div>
      </div>

      {show&&<div className="card p-4 fade space-y-3">
        <div><label className="lbl">Name *</label><input value={form.Name} onChange={e=>setForm({...form,Name:e.target.value})} className="inp" placeholder="e.g., Chicken Thigh"/></div>
        <div className="grid grid-cols-2 gap-3">
          <div><label className="lbl">Base Unit</label><select value={form.Unit} onChange={e=>setForm({...form,Unit:e.target.value})} className="inp">{units.map(u=><option key={u} value={u.trim()}>{u.trim()}</option>)}</select></div>
          <div><label className="lbl">Yield %</label><input type="number" value={form.YieldPercent} onChange={e=>setForm({...form,YieldPercent:e.target.value})} className="inp"/></div>
        </div>
        <div><label className="lbl">Category</label><select value={form.Category||''} onChange={e=>setForm({...form,Category:e.target.value})} className="inp">{ingCats.map(c=><option key={c.Category} value={c.Category}>{c.Category}</option>)}</select></div>
        
        <div className="p-3 bg-blue-50 rounded-xl">
          <p className="text-sm font-semibold text-blue-700 mb-2">ğŸ“¦ Default Container (optional)</p>
          <div className="grid grid-cols-3 gap-2">
            <div><label className="text-xs text-blue-600">Type</label><select value={form.ContainerType} onChange={e=>setForm({...form,ContainerType:e.target.value})} className="inp text-sm">{containerTypes.map(c=><option key={c} value={c}>{c||'(none)'}</option>)}</select></div>
            <div><label className="text-xs text-blue-600">Size</label><input type="number" value={form.ContainerSize} onChange={e=>setForm({...form,ContainerSize:e.target.value})} className="inp text-sm" placeholder="25" step="0.1"/></div>
            <div><label className="text-xs text-blue-600">Unit</label><select value={form.ContainerUnit||'kg'} onChange={e=>setForm({...form,ContainerUnit:e.target.value})} className="inp text-sm">{containerUnits.map(u=><option key={u} value={u}>{u}</option>)}</select></div>
          </div>
        </div>
        
        <div className="p-3 bg-amber-50 rounded-xl">
          <p className="text-sm font-semibold text-amber-700 mb-2">ğŸ’° Market Price (optional)</p>
          <p className="text-xs text-amber-600 mb-2">Fallback price when no purchase data exists</p>
          <div className="flex gap-2">
            <div className="flex-1">
              <input type="number" value={form.MarketPrice||''} onChange={e=>setForm({...form,MarketPrice:e.target.value})} className="inp text-sm" placeholder={`â‚± per ${form.Unit||'g'}`} step="0.0001"/>
            </div>
            <button type="button" onClick={()=>form.Name&&window.open(`https://www.google.com/search?q=price+of+${encodeURIComponent(form.Name)}+per+${form.Unit||'kg'}+Philippines`,'_blank')} className="btn btn-s text-xs px-3" disabled={!form.Name}>ğŸ” Search</button>
          </div>
        </div>
        
        <button onClick={add} disabled={saving} className="btn btn-p w-full">{saving?'Saving...':'Add'}</button>
      </div>}

      <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="ğŸ” Search..." className="inp"/>
      <div className="card">
        <div className="p-3 border-b bg-gray-50"><span className="font-semibold text-gray-700">{filtered.length} ingredients</span></div>
        <div className="max-h-96 overflow-y-auto">
          {filtered.length===0?<p className="p-8 text-center text-gray-400">None</p>:
            filtered.map(ing=>{
              const priceInfo=getPriceInfo(ing.MasterSKU);
              const hasMarketPrice=parseFloat(ing.MarketPrice)>0;
              return(
                <div key={ing.MasterSKU} className="p-3 border-b flex items-center">
                  <button onClick={()=>setViewIng(ing)} className="flex-1 text-left">
                    <p className="font-medium">{ing.Name}</p>
                    <p className="text-xs text-gray-500">
                      SKU: {ing.MasterSKU} â€¢ {ing.Unit} â€¢ {ing.Category}
                      {priceInfo?<span className="text-green-600"> â€¢ â‚±{priceInfo.avgPrice.toFixed(4)}/{ing.Unit}</span>:
                        hasMarketPrice?<span className="text-amber-600"> â€¢ â‚±{parseFloat(ing.MarketPrice).toFixed(4)}/{ing.Unit} âš ï¸</span>:
                        <span className="text-red-400"> â€¢ No price</span>}
                    </p>
                  </button>
                  <button onClick={()=>setEdit({...ing})} className="text-blue-500 p-2">âœï¸</button>
                  <button onClick={()=>del(ing.MasterSKU)} className="text-red-500 p-2">ğŸ—‘ï¸</button>
                </div>
              );
            })}
        </div>
      </div>
    </div>
  );
}

// Ingredient Detail View
function IngredientDetail({ing,purchases,dishes,onClose,onEdit}){
  // Get all purchases for this ingredient
  const ingPurchases=(purchases||[]).filter(p=>String(p.MasterSKU)===String(ing.MasterSKU)).sort((a,b)=>new Date(b.PurchaseDate)-new Date(a.PurchaseDate));
  
  // Price stats
  const validPurchases=ingPurchases.filter(p=>p.UnitPrice&&parseFloat(p.UnitPrice)>0);
  const prices=validPurchases.map(p=>parseFloat(p.UnitPrice));
  const avgPrice=prices.length>0?prices.reduce((a,b)=>a+b,0)/prices.length:0;
  const minPrice=prices.length>0?Math.min(...prices):0;
  const maxPrice=prices.length>0?Math.max(...prices):0;
  const totalQty=ingPurchases.reduce((s,p)=>s+(parseFloat(p.Qty)||0),0);
  const totalSpent=ingPurchases.reduce((s,p)=>s+(parseFloat(p.Price)||0),0);
  
  // Group by branch
  const byBranch={};
  validPurchases.forEach(p=>{
    const bc=p.BranchCode||'?';
    if(!byBranch[bc])byBranch[bc]={prices:[],count:0};
    byBranch[bc].prices.push(parseFloat(p.UnitPrice));
    byBranch[bc].count++;
  });
  
  // Find dishes using this ingredient
  const usedInDishes=(dishes||[]).filter(d=>d.recipeLines?.some(l=>String(l.MasterSKU)===String(ing.MasterSKU)));
  
  return(
    <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center">
      <div className="bg-white w-full max-w-lg max-h-[90vh] rounded-t-2xl sm:rounded-2xl overflow-hidden flex flex-col fade">
        <div className="p-4 border-b flex justify-between items-center bg-gradient-to-r from-green-600 to-green-700 text-white">
          <div>
            <h3 className="font-bold text-lg">{ing.Name}</h3>
            <p className="text-xs text-green-200">SKU: {ing.MasterSKU} â€¢ {ing.Category}</p>
          </div>
          <button onClick={onClose} className="text-2xl text-white/80 hover:text-white">âœ•</button>
        </div>

        <div className="flex-1 overflow-y-auto">
          {/* Price Summary */}
          <div className="p-4 bg-gray-50 border-b">
            {avgPrice>0?<>
              <div className="grid grid-cols-3 gap-3 text-center">
                <div>
                  <p className="text-xs text-gray-500">Avg Price</p>
                  <p className="text-lg font-bold text-green-600">â‚±{avgPrice.toFixed(4)}</p>
                  <p className="text-xs text-gray-400">per {ing.Unit}</p>
                </div>
                <div>
                  <p className="text-xs text-gray-500">Min</p>
                  <p className="text-lg font-bold text-blue-600">â‚±{minPrice.toFixed(4)}</p>
                </div>
                <div>
                  <p className="text-xs text-gray-500">Max</p>
                  <p className="text-lg font-bold text-red-600">â‚±{maxPrice.toFixed(4)}</p>
                </div>
              </div>
              <div className="grid grid-cols-2 gap-3 mt-3 text-center">
                <div className="p-2 bg-white rounded-lg">
                  <p className="text-xs text-gray-500">Total Purchased</p>
                  <p className="font-bold text-gray-800">{totalQty.toLocaleString()} {ing.Unit}</p>
                </div>
                <div className="p-2 bg-white rounded-lg">
                  <p className="text-xs text-gray-500">Total Spent</p>
                  <p className="font-bold text-red-600">{fmt(totalSpent)}</p>
                </div>
              </div>
            </>:ing.MarketPrice?<div className="text-center">
              <p className="text-xs text-amber-600 mb-2">âš ï¸ No purchase data - using market price</p>
              <p className="text-2xl font-bold text-amber-600">â‚±{parseFloat(ing.MarketPrice).toFixed(4)}</p>
              <p className="text-xs text-gray-400">per {ing.Unit} (estimated)</p>
            </div>:<div className="text-center py-4">
              <p className="text-gray-400 mb-2">No price data available</p>
              <button onClick={onEdit} className="text-blue-600 text-sm font-medium">+ Add Market Price</button>
            </div>}
          </div>

          {/* Price by Branch */}
          {Object.keys(byBranch).length>0&&<div className="p-4 border-b">
            <h4 className="font-semibold text-gray-700 mb-3">ğŸ“Š Price by Branch</h4>
            <div className="space-y-2">
              {Object.entries(byBranch).map(([bc,data])=>{
                const branchAvg=data.prices.reduce((a,b)=>a+b,0)/data.prices.length;
                return(
                  <div key={bc} className="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                    <div>
                      <p className="font-medium text-sm">{bc}</p>
                      <p className="text-xs text-gray-500">{data.count} purchases</p>
                    </div>
                    <span className={`font-bold ${branchAvg<=avgPrice?'text-green-600':'text-red-600'}`}>â‚±{branchAvg.toFixed(4)}/{ing.Unit}</span>
                  </div>
                );
              })}
            </div>
          </div>}

          {/* Container Info */}
          {ing.ContainerType&&<div className="p-4 border-b">
            <h4 className="font-semibold text-gray-700 mb-2">ğŸ“¦ Default Container</h4>
            <div className="p-3 bg-blue-50 rounded-lg">
              <p className="font-medium text-blue-800">{ing.ContainerType}</p>
              <p className="text-sm text-blue-600">{ing.ContainerSize} {ing.ContainerUnit} per container</p>
            </div>
          </div>}

          {/* Recent Purchases */}
          <div className="p-4 border-b">
            <h4 className="font-semibold text-gray-700 mb-3">ğŸ›’ Recent Purchases ({ingPurchases.length})</h4>
            {ingPurchases.length===0?<p className="text-gray-400 text-sm">No purchases yet</p>:
              <div className="space-y-2 max-h-48 overflow-y-auto">
                {ingPurchases.slice(0,10).map((p,i)=>(
                  <div key={p.UniqueID||i} className="flex items-center justify-between p-2 bg-gray-50 rounded-lg text-sm">
                    <div>
                      <p className="font-medium">{p.Qty} {p.Unit} â€¢ {p.BranchCode}</p>
                      <p className="text-xs text-gray-500">{fmtDate(p.PurchaseDate)}{p.Supplier?` â€¢ ${p.Supplier}`:''}</p>
                    </div>
                    <div className="text-right">
                      <p className="font-bold text-red-600">{fmt(p.Price)}</p>
                      <p className="text-xs text-green-600">â‚±{parseFloat(p.UnitPrice||0).toFixed(4)}/{ing.Unit}</p>
                    </div>
                  </div>
                ))}
              </div>
            }
          </div>

          {/* Market Price Fallback */}
          {ing.MarketPrice&&<div className="p-4 border-b">
            <h4 className="font-semibold text-gray-700 mb-2">ğŸ’° Market Price (Fallback)</h4>
            <div className="p-3 bg-amber-50 rounded-lg">
              <p className="font-bold text-amber-700">â‚±{parseFloat(ing.MarketPrice).toFixed(4)}/{ing.Unit}</p>
              <p className="text-xs text-amber-600 mt-1">Used when no purchase data exists</p>
            </div>
          </div>}

          {/* Details */}
          <div className="p-4">
            <h4 className="font-semibold text-gray-700 mb-2">â„¹ï¸ Details</h4>
            <div className="space-y-1 text-sm">
              <p><span className="text-gray-500">Base Unit:</span> <span className="font-medium">{ing.Unit}</span></p>
              <p><span className="text-gray-500">Yield:</span> <span className="font-medium">{ing.YieldPercent||100}%</span></p>
              <p><span className="text-gray-500">Category:</span> <span className="font-medium">{ing.Category}</span></p>
            </div>
          </div>
        </div>

        <div className="p-4 border-t bg-gray-50">
          <button onClick={onEdit} className="btn btn-s w-full">âœï¸ Edit Ingredient</button>
        </div>
      </div>
    </div>
  );
}

function Dishes({apiUrl,dishes,dishCats,ingredients,purchases,showToast,loadAll}){
  const[show,setShow]=useState(false);
  const[edit,setEdit]=useState(null);
  const[editProc,setEditProc]=useState(null);
  const[viewDish,setViewDish]=useState(null);
  const[procTemplates,setProcTemplates]=useState([]);
  const[saving,setSaving]=useState(false);
  const[search,setSearch]=useState('');
  const[filterCat,setFilterCat]=useState('All');
  const[form,setForm]=useState({Name:'',Category:'Main Dish',SellPrice:'',ServingSize:1});

  useEffect(()=>{if(apiUrl)(async()=>{try{const r=await api(apiUrl,'getProcedureTemplates');setProcTemplates(r.templates||[])}catch(e){console.error(e)}})()},[apiUrl]);

  const add=async()=>{
    if(!form.Name){showToast('Enter name','error');return}
    setSaving(true);
    try{await api(apiUrl,'addDish',{data:form});showToast('Added!');setForm({Name:'',Category:'Main Dish',SellPrice:'',ServingSize:1});setShow(false);loadAll();}
    catch(e){showToast(e.message,'error')}finally{setSaving(false)}
  };
  const del=async mcode=>{if(!confirm('Delete?'))return;try{await api(apiUrl,'deleteDish',{mcode});showToast('Deleted');loadAll();}catch(e){showToast(e.message,'error')}};

  const comboCats=dishCats.filter(c=>c.IsComboType==='Yes').map(c=>c.Category);
  const filtered=dishes.filter(d=>{const ms=d.Name?.toLowerCase().includes(search.toLowerCase());const mc=filterCat==='All'||d.Category===filterCat;return ms&&mc});
  const grouped={};filtered.forEach(d=>{if(!grouped[d.Category])grouped[d.Category]=[];grouped[d.Category].push(d)});

  return(
    <div className="space-y-4 fade">
      {edit&&<RecipeEditor apiUrl={apiUrl} dish={edit} dishes={dishes} ingredients={ingredients} comboCats={comboCats} onClose={()=>setEdit(null)} showToast={showToast}/>}
      {editProc&&<ProcedureEditor apiUrl={apiUrl} dish={editProc} ingredients={ingredients} templates={procTemplates} onClose={()=>setEditProc(null)} showToast={showToast}/>}
      {viewDish&&<DishDetail apiUrl={apiUrl} dish={viewDish} dishes={dishes} ingredients={ingredients} purchases={purchases} onClose={()=>setViewDish(null)} onEditRecipe={()=>{setViewDish(null);setEdit(viewDish)}} onEditSteps={()=>{setViewDish(null);setEditProc(viewDish)}} showToast={showToast}/>}

      <div className="flex justify-between items-center">
        <h2 className="text-lg font-bold text-gray-800">ğŸ³ Dishes</h2>
        <div className="flex gap-2">
          <button onClick={()=>downloadCSV(dishes,'dishes')} className="btn btn-s btn-sm">ğŸ“¥</button>
          <button onClick={()=>setShow(!show)} className="btn btn-p btn-sm">{show?'âœ•':'+ Add'}</button>
        </div>
      </div>

      {show&&<div className="card p-4 fade space-y-3">
        <div><label className="lbl">Name *</label><input value={form.Name} onChange={e=>setForm({...form,Name:e.target.value})} className="inp" placeholder="Dish name"/></div>
        <div className="grid grid-cols-2 gap-3">
          <div><label className="lbl">Category</label><select value={form.Category||''} onChange={e=>setForm({...form,Category:e.target.value})} className="inp">{dishCats.map(c=><option key={c.Category} value={c.Category}>{c.Category}{c.IsComboType==='Yes'?' (Combo)':''}</option>)}</select></div>
          <div><label className="lbl">Sell Price</label><input type="number" value={form.SellPrice} onChange={e=>setForm({...form,SellPrice:e.target.value})} className="inp" placeholder="â‚±"/></div>
        </div>
        <div><label className="lbl">Serving Size</label><input type="number" value={form.ServingSize} onChange={e=>setForm({...form,ServingSize:e.target.value})} className="inp"/></div>
        <button onClick={add} disabled={saving} className="btn btn-p w-full">{saving?'Saving...':'Add Dish'}</button>
      </div>}

      <div className="flex gap-2">
        <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="ğŸ” Search..." className="inp flex-1"/>
        <select value={filterCat} onChange={e=>setFilterCat(e.target.value)} className="inp" style={{width:'auto'}}><option value="All">All</option>{dishCats.map(c=><option key={c.Category} value={c.Category}>{c.Category}</option>)}</select>
      </div>

      <div className="space-y-3">
        {Object.entries(grouped).map(([cat,catDishes])=>
          <div key={cat} className="card">
            <div className="p-3 border-b bg-gray-50 flex items-center gap-2">
              <span className="font-semibold text-gray-700">{cat}</span>
              <span className="text-xs text-gray-500">({catDishes.length})</span>
              {comboCats.includes(cat)&&<span className="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full">Combo</span>}
            </div>
            {catDishes.map(dish=><div key={dish.MCODE} className="p-3 border-b flex items-center">
              <button onClick={()=>setViewDish(dish)} className="flex-1 min-w-0 text-left">
                <p className="font-medium">{dish.Name}</p>
                <p className="text-xs text-gray-500">{dish.MCODE}{dish.SellPrice?` â€¢ ${fmt(dish.SellPrice)}`:''}{dish.Cost?` â€¢ Cost: ${fmt(dish.Cost)}`:''}</p>
              </button>
              <button onClick={()=>setEdit(dish)} className="text-blue-600 px-2 text-xs font-medium">Recipe</button>
              <button onClick={()=>setEditProc(dish)} className="text-purple-600 px-2 text-xs font-medium">Steps</button>
              <button onClick={()=>del(dish.MCODE)} className="text-red-500 p-2">ğŸ—‘ï¸</button>
            </div>)}
          </div>
        )}
        {Object.keys(grouped).length===0&&<p className="text-center text-gray-400 py-8">No dishes</p>}
      </div>
    </div>
  );
}

// Dish Detail View with Costing
function DishDetail({apiUrl,dish,dishes,ingredients,purchases,onClose,onEditRecipe,onEditSteps,showToast}){
  const[lines,setLines]=useState([]);
  const[procedures,setProcedures]=useState([]);
  const[loading,setLoading]=useState(true);

  useEffect(()=>{
    (async()=>{
      setLoading(true);
      try{
        const[recipeRes,procRes]=await Promise.all([
          api(apiUrl,'getRecipeLines',{mcode:dish.MCODE}),
          api(apiUrl,'getProcedures',{mcode:dish.MCODE})
        ]);
        setLines(recipeRes.lines||[]);
        setProcedures(procRes.procedures||[]);
      }catch(e){showToast(e.message,'error')}
      finally{setLoading(false)}
    })();
  },[dish.MCODE,apiUrl]);

  // Build price map from purchases
  const priceMap={};
  (purchases||[]).forEach(p=>{
    const sku=String(p.MasterSKU);
    if(!sku||!p.UnitPrice||parseFloat(p.UnitPrice)<=0)return;
    if(!priceMap[sku])priceMap[sku]={prices:[],name:p.ItemName};
    priceMap[sku].prices.push(parseFloat(p.UnitPrice));
  });
  // Calculate avg for each SKU
  Object.keys(priceMap).forEach(sku=>{
    const prices=priceMap[sku].prices;
    priceMap[sku].avgPrice=prices.reduce((a,b)=>a+b,0)/prices.length;
  });

  // Calculate costs locally - with MarketPrice fallback
  const calcLineCost=(line)=>{
    if(line.IngredientType==='dish'){
      const subDish=dishes.find(d=>d.MCODE===line.ComponentMCODE);
      return {cost:parseFloat(subDish?.Cost)||0,isMarket:false};
    }
    const sku=String(line.MasterSKU);
    const purchasePrice=priceMap[sku]?.avgPrice||0;
    const ing=ingredients.find(i=>String(i.MasterSKU)===sku);
    const marketPrice=parseFloat(ing?.MarketPrice)||0;
    const qty=parseFloat(line.Qty)||0;
    
    if(purchasePrice>0){
      return {cost:qty*purchasePrice,isMarket:false,unitPrice:purchasePrice};
    }else if(marketPrice>0){
      return {cost:qty*marketPrice,isMarket:true,unitPrice:marketPrice};
    }
    return {cost:0,isMarket:false,unitPrice:0};
  };

  const lineResults=lines.map(l=>calcLineCost(l));
  const lineCosts=lineResults.map(r=>r.cost);
  const totalCost=lineCosts.reduce((s,c)=>s+c,0);
  const hasMarketPrices=lineResults.some(r=>r.isMarket);
  const sellPrice=parseFloat(dish.SellPrice)||0;
  const profit=sellPrice-totalCost;
  const margin=sellPrice>0?((profit/sellPrice)*100):0;

  return(
    <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center">
      <div className="bg-white w-full max-w-lg max-h-[90vh] rounded-t-2xl sm:rounded-2xl overflow-hidden flex flex-col fade">
        <div className="p-4 border-b flex justify-between items-center bg-gradient-to-r from-red-600 to-red-700 text-white">
          <div>
            <h3 className="font-bold text-lg">{dish.Name}</h3>
            <p className="text-xs text-red-200">{dish.MCODE} â€¢ {dish.Category}</p>
          </div>
          <button onClick={onClose} className="text-2xl text-white/80 hover:text-white">âœ•</button>
        </div>

        <div className="flex-1 overflow-y-auto">
          {loading?<p className="text-center py-8 text-gray-400">Loading...</p>:<>
            
            {/* Costing Summary */}
            <div className="p-4 bg-gray-50 border-b">
              <div className="grid grid-cols-3 gap-3 text-center">
                <div>
                  <p className="text-xs text-gray-500">Sell Price</p>
                  <p className="text-lg font-bold text-gray-800">{sellPrice>0?fmt(sellPrice):'-'}</p>
                </div>
                <div>
                  <p className="text-xs text-gray-500">Total Cost</p>
                  <p className="text-lg font-bold text-red-600">{totalCost>0?fmt(totalCost):'-'}</p>
                </div>
                <div>
                  <p className="text-xs text-gray-500">Profit</p>
                  <p className={`text-lg font-bold ${profit>=0?'text-green-600':'text-red-600'}`}>
                    {sellPrice>0&&totalCost>0?fmt(profit):'-'}
                  </p>
                </div>
              </div>
              {sellPrice>0&&totalCost>0&&<div className="mt-3">
                <div className="flex justify-between text-xs mb-1">
                  <span className="text-gray-500">Margin</span>
                  <span className={`font-medium ${margin>=30?'text-green-600':margin>=15?'text-amber-600':'text-red-600'}`}>{margin.toFixed(1)}%</span>
                </div>
                <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div className={`h-full ${margin>=30?'bg-green-500':margin>=15?'bg-amber-500':'bg-red-500'}`} style={{width:`${Math.min(Math.max(margin,0),100)}%`}}/>
                </div>
              </div>}
            </div>

            {/* Recipe Ingredients */}
            <div className="p-4 border-b">
              <div className="flex justify-between items-center mb-3">
                <h4 className="font-semibold text-gray-700">ğŸ¥¬ Recipe ({lines.length})</h4>
                <button onClick={onEditRecipe} className="text-blue-600 text-xs font-medium">Edit</button>
              </div>
              {hasMarketPrices&&<p className="text-xs text-amber-600 mb-2 p-2 bg-amber-50 rounded-lg">âš ï¸ Some costs use market price estimates (no purchase data)</p>}
              {lines.length===0?<p className="text-gray-400 text-sm">No ingredients added</p>:
                <div className="space-y-2">
                  {lines.map((line,i)=>{
                    const result=lineResults[i];
                    const sku=String(line.MasterSKU);
                    const ing=ingredients.find(x=>String(x.MasterSKU)===sku);
                    return(
                      <div key={line.RecipeLineID||i} className="flex items-center p-2 rounded-lg" style={{background:result.isMarket?'#fef3c7':line.IngredientType==='dish'?'#f3e8ff':'#f9fafb'}}>
                        <div className="flex-1">
                          <p className="text-sm font-medium">{line.IngredientType==='dish'?'ğŸ³':'ğŸ¥¬'} {line.IngredientName}{result.isMarket?' âš ï¸':''}</p>
                          <p className="text-xs text-gray-500">{line.Qty} {line.Unit}{result.unitPrice>0?` @ â‚±${result.unitPrice.toFixed(4)}/${ing?.Unit||'g'}`:''}{result.isMarket?' (market)':''}</p>
                        </div>
                        <span className={`text-sm font-medium ${result.isMarket?'text-amber-600':'text-red-600'}`}>{result.cost>0?fmt(result.cost):'-'}</span>
                      </div>
                    );
                  })}
                </div>
              }
            </div>

            {/* Cooking Procedure */}
            <div className="p-4">
              <div className="flex justify-between items-center mb-3">
                <h4 className="font-semibold text-gray-700">ğŸ“ Procedure ({procedures.length})</h4>
                <button onClick={onEditSteps} className="text-purple-600 text-xs font-medium">Edit</button>
              </div>
              {procedures.length===0?<p className="text-gray-400 text-sm">No steps added</p>:
                <div className="space-y-2">
                  {procedures.map((step,i)=>(
                    <div key={step.ProcedureID||i} className="flex items-start gap-3 p-2 bg-gray-50 rounded-lg">
                      <span className="w-6 h-6 rounded-full bg-purple-600 text-white text-xs flex items-center justify-center font-bold flex-shrink-0">{i+1}</span>
                      <div>
                        <p className="text-sm font-medium">{step.Action}</p>
                        {step.IngredientName&&<p className="text-xs text-gray-500">â€¢ {step.IngredientName}{step.Qty?` (${step.Qty} ${step.Unit})`:''}</p>}
                        {step.Duration&&<p className="text-xs text-gray-500">â€¢ {step.Duration}</p>}
                        {step.Notes&&<p className="text-xs text-gray-400 italic">{step.Notes}</p>}
                      </div>
                    </div>
                  ))}
                </div>
              }
            </div>
          </>}
        </div>

        <div className="p-4 border-t bg-gray-50 flex gap-2">
          <button onClick={onEditRecipe} className="btn btn-s flex-1">Edit Recipe</button>
          <button onClick={onEditSteps} className="btn flex-1" style={{background:'#9333ea',color:'white'}}>Edit Steps</button>
        </div>
      </div>
    </div>
  );
}

function RecipeEditor({apiUrl,dish,dishes,ingredients,comboCats,onClose,showToast}){
  const[lines,setLines]=useState([]);
  const[loading,setLoading]=useState(true);
  const[saving,setSaving]=useState(false);
  const[picker,setPicker]=useState(null);
  const[pSearch,setPSearch]=useState('');
  const[pickerMode,setPickerMode]=useState('ingredient'); // Toggle state

  const isCombo=comboCats.includes(dish.Category);
  const compDishes=dishes.filter(d=>d.CanBeComponent==='Yes'&&d.MCODE!==dish.MCODE);

  useEffect(()=>{(async()=>{setLoading(true);try{const r=await api(apiUrl,'getRecipeLines',{mcode:dish.MCODE});setLines(r.lines||[])}catch(e){showToast(e.message,'error')}finally{setLoading(false)}})()},[dish.MCODE]);

  const addLine=t=>setLines([...lines,{IngredientType:t,IngredientName:'',MasterSKU:'',ComponentMCODE:'',Qty:'',Unit:t==='dish'?'dish':'g',YieldPercent:100,_t:Date.now()}]);
  const upLine=(i,f,v)=>{const n=[...lines];n[i]={...n[i],[f]:v};setLines(n)};
  const rmLine=i=>setLines(lines.filter((_,idx)=>idx!==i));
  
  const openPicker=(i,defaultType)=>{
    const type=defaultType||(isCombo?'dish':'ingredient');
    setPicker({i});
    setPickerMode(type);
    setPSearch('');
  };
  
  const select=item=>{
    const i=picker.i;
    const n=[...lines];
    if(pickerMode==='ingredient'){
      n[i]={...n[i],IngredientType:'ingredient',IngredientName:item.Name,MasterSKU:item.MasterSKU,ComponentMCODE:'',Unit:item.Unit||'g'};
    }else{
      n[i]={...n[i],IngredientType:'dish',IngredientName:item.Name,MasterSKU:'',ComponentMCODE:item.MCODE,Unit:'dish'};
    }
    setLines(n);
    setPicker(null);
    setPSearch('');
  };
  
  const save=async()=>{const valid=lines.filter(l=>l.IngredientName&&l.Qty);setSaving(true);try{await api(apiUrl,'saveRecipeLines',{mcode:dish.MCODE,lines:valid});showToast('Saved!');onClose()}catch(e){showToast(e.message,'error')}finally{setSaving(false)}};

  const filtIng=ingredients.filter(i=>i.Name?.toLowerCase().includes(pSearch.toLowerCase()));
  const filtDish=compDishes.filter(d=>d.Name?.toLowerCase().includes(pSearch.toLowerCase()));

  return(
    <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center">
      <div className="bg-white w-full max-w-lg max-h-[90vh] rounded-t-2xl sm:rounded-2xl overflow-hidden flex flex-col fade">
        <div className="p-4 border-b flex justify-between items-center bg-gray-50">
          <div><h3 className="font-bold text-lg">{dish.Name}</h3><p className="text-xs text-gray-500">{dish.MCODE} â€¢ {dish.Category}{isCombo?' â€¢ Combo':''}</p></div>
          <button onClick={onClose} className="text-2xl text-gray-400">âœ•</button>
        </div>

        {picker&&<div className="absolute inset-0 bg-white z-10 flex flex-col">
          <div className="p-4 border-b">
            <div className="flex justify-between items-center mb-3"><h4 className="font-semibold">Select {pickerMode==='ingredient'?'Ingredient':'Dish'}</h4><button onClick={()=>setPicker(null)} className="text-xl">âœ•</button></div>
            <input value={pSearch} onChange={e=>setPSearch(e.target.value)} placeholder="ğŸ” Search..." className="inp mb-2" autoFocus/>
            <div className="flex gap-2">
              <button onClick={()=>setPickerMode('ingredient')} className={`flex-1 text-sm py-2 rounded-lg font-medium ${pickerMode==='ingredient'?'bg-green-600 text-white':'bg-gray-100 text-gray-600'}`}>ğŸ¥¬ Ingredients</button>
              <button onClick={()=>setPickerMode('dish')} className={`flex-1 text-sm py-2 rounded-lg font-medium ${pickerMode==='dish'?'bg-purple-600 text-white':'bg-gray-100 text-gray-600'}`} disabled={compDishes.length===0}>ğŸ³ Dishes ({compDishes.length})</button>
            </div>
          </div>
          <div className="flex-1 overflow-y-auto">
            {pickerMode==='ingredient'?
              (filtIng.length===0?<p className="p-6 text-center text-gray-400">No ingredients found</p>:filtIng.slice(0,50).map(i=><button key={i.MasterSKU} onClick={()=>select(i)} className="w-full p-3 border-b text-left hover:bg-gray-50"><span className="font-medium">{i.Name}</span><span className="text-xs text-gray-500 ml-2">[{i.MasterSKU}] {i.Unit}</span></button>))
              :(filtDish.length===0?<p className="p-6 text-center text-gray-400">No component dishes available</p>:filtDish.slice(0,50).map(d=><button key={d.MCODE} onClick={()=>select(d)} className="w-full p-3 border-b text-left hover:bg-gray-50"><span className="font-medium">{d.Name}</span><span className="text-xs text-gray-500 ml-2">[{d.MCODE}] {d.Category}</span></button>))}
          </div>
        </div>}

        <div className="flex-1 overflow-y-auto p-4">
          {loading?<p className="text-center py-8 text-gray-400">Loading...</p>:<>
            <div className="flex gap-2 mb-4">
              <button onClick={()=>addLine('ingredient')} className="btn btn-s flex-1 text-sm">+ Ingredient</button>
              <button onClick={()=>addLine('dish')} className={`flex-1 text-sm px-4 py-2 rounded-lg font-medium ${compDishes.length>0?'bg-purple-100 text-purple-700':'bg-gray-100 text-gray-400'}`} disabled={compDishes.length===0}>+ Dish</button>
            </div>
            {lines.length===0?<p className="text-center py-8 text-gray-400">No ingredients. Add one above.</p>:
              <div className="space-y-3">{lines.map((line,i)=>
                <div key={line.RecipeLineID||line._t} className="p-3 rounded-xl border" style={{background:line.IngredientType==='dish'?'#f3e8ff':'#f9fafb'}}>
                  <div className="flex justify-between items-center mb-2"><span className="text-xs font-medium text-gray-500">{line.IngredientType==='dish'?'ğŸ³ Dish':'ğŸ¥¬ Ingredient'}</span><button onClick={()=>rmLine(i)} className="text-red-500 text-sm">âœ•</button></div>
                  <button onClick={()=>openPicker(i,line.IngredientType)} className="w-full p-2 rounded-lg border bg-white text-left mb-2 text-sm">{line.IngredientName||<span className="text-gray-400">Tap to select...</span>}</button>
                  <div className="grid grid-cols-3 gap-2">
                    <div><label className="text-xs text-gray-500">Qty</label><input type="number" value={line.Qty} onChange={e=>upLine(i,'Qty',e.target.value)} className="inp text-sm p-2" step="0.01"/></div>
                    <div><label className="text-xs text-gray-500">Unit</label><input value={line.Unit} onChange={e=>upLine(i,'Unit',e.target.value)} className="inp text-sm p-2" disabled={line.IngredientType==='dish'}/></div>
                    <div><label className="text-xs text-gray-500">Yield%</label><input type="number" value={line.YieldPercent||100} onChange={e=>upLine(i,'YieldPercent',e.target.value)} className="inp text-sm p-2"/></div>
                  </div>
                </div>
              )}</div>}
          </>}
        </div>
        <div className="p-4 border-t bg-gray-50"><button onClick={save} disabled={saving} className="btn btn-p w-full">{saving?'Saving...':`Save (${lines.filter(l=>l.IngredientName&&l.Qty).length} items)`}</button></div>
      </div>
    </div>
  );
}

function ProcedureEditor({apiUrl,dish,ingredients,templates,onClose,showToast}){
  const[steps,setSteps]=useState([]);
  const[recipeIngs,setRecipeIngs]=useState([]);
  const[loading,setLoading]=useState(true);
  const[saving,setSaving]=useState(false);

  useEffect(()=>{(async()=>{
    setLoading(true);
    try{
      const[procRes,recipeRes]=await Promise.all([
        api(apiUrl,'getProcedures',{mcode:dish.MCODE}),
        api(apiUrl,'getRecipeLines',{mcode:dish.MCODE})
      ]);
      setSteps(procRes.procedures||[]);
      // Get only ingredients from this recipe
      const recipeSkus=new Set((recipeRes.lines||[]).filter(l=>l.MasterSKU).map(l=>String(l.MasterSKU)));
      const filtered=ingredients.filter(ing=>recipeSkus.has(String(ing.MasterSKU)));
      setRecipeIngs(filtered);
    }catch(e){showToast(e.message,'error')}
    finally{setLoading(false)}
  })()},[dish.MCODE,apiUrl,ingredients]);

  const addStep=(template)=>{
    setSteps([...steps,{
      Action:template?.Action||'',
      IngredientName:'',
      MasterSKU:'',
      Qty:'',
      Unit:'',
      Duration:template?.DefaultDuration||'',
      Notes:'',
      _t:Date.now()
    }]);
  };
  const upStep=(i,f,v)=>{const n=[...steps];n[i]={...n[i],[f]:v};setSteps(n)};
  const rmStep=i=>setSteps(steps.filter((_,idx)=>idx!==i));
  const moveStep=(i,dir)=>{
    if((dir===-1&&i===0)||(dir===1&&i===steps.length-1))return;
    const n=[...steps];
    [n[i],n[i+dir]]=[n[i+dir],n[i]];
    setSteps(n);
  };
  const selectIng=(i,ing)=>{
    const n=[...steps];
    n[i]={...n[i],IngredientName:ing.Name,MasterSKU:ing.MasterSKU,Unit:ing.Unit};
    setSteps(n);
  };

  const save=async()=>{
    setSaving(true);
    try{
      await api(apiUrl,'saveProcedures',{mcode:dish.MCODE,steps});
      showToast('Saved!');
      onClose();
    }catch(e){showToast(e.message,'error')}
    finally{setSaving(false)}
  };

  const grouped={Prep:[],Cook:[],Finish:[]};
  templates.forEach(t=>{if(grouped[t.Category])grouped[t.Category].push(t);else grouped.Cook.push(t)});

  return(
    <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center">
      <div className="bg-white w-full max-w-lg max-h-[90vh] rounded-t-2xl sm:rounded-2xl overflow-hidden flex flex-col fade">
        <div className="p-4 border-b flex justify-between items-center bg-purple-50">
          <div><h3 className="font-bold text-lg text-purple-800">ğŸ“ {dish.Name}</h3><p className="text-xs text-purple-600">Cooking Procedure</p></div>
          <button onClick={onClose} className="text-2xl text-gray-400">âœ•</button>
        </div>

        <div className="flex-1 overflow-y-auto p-4">
          {loading?<p className="text-center py-8 text-gray-400">Loading...</p>:<>
            
            {/* Quick Add Templates */}
            <div className="mb-4">
              <p className="text-xs text-gray-500 font-medium mb-2">Quick Add Step:</p>
              <div className="flex flex-wrap gap-1">
                {Object.entries(grouped).map(([cat,tpls])=>
                  tpls.slice(0,4).map(t=>
                    <button key={t.TemplateID} onClick={()=>addStep(t)} className="text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700 hover:bg-purple-200">{t.Action}</button>
                  )
                )}
                <button onClick={()=>addStep(null)} className="text-xs px-2 py-1 rounded-full bg-gray-200 text-gray-600">+ Custom</button>
              </div>
            </div>

            {steps.length===0?<p className="text-center py-8 text-gray-400">No steps yet. Add from templates above.</p>:
              <div className="space-y-3">{steps.map((step,i)=>
                <div key={step.ProcedureID||step._t} className="p-3 rounded-xl border bg-gray-50">
                  <div className="flex justify-between items-center mb-2">
                    <div className="flex items-center gap-2">
                      <span className="w-6 h-6 rounded-full bg-purple-600 text-white text-xs flex items-center justify-center font-bold">{i+1}</span>
                      <div className="flex gap-1">
                        <button onClick={()=>moveStep(i,-1)} disabled={i===0} className="text-gray-400 disabled:opacity-30">â–²</button>
                        <button onClick={()=>moveStep(i,1)} disabled={i===steps.length-1} className="text-gray-400 disabled:opacity-30">â–¼</button>
                      </div>
                    </div>
                    <button onClick={()=>rmStep(i)} className="text-red-500 text-sm font-bold">âœ•</button>
                  </div>
                  
                  <div className="space-y-2">
                    <div>
                      <label className="text-xs text-gray-500">Action</label>
                      <select value={step.Action} onChange={e=>upStep(i,'Action',e.target.value)} className="inp text-sm p-2">
                        <option value="">-- Select or type --</option>
                        {templates.map(t=><option key={t.TemplateID} value={t.Action}>{t.Action}</option>)}
                      </select>
                    </div>
                    
                    <div className="grid grid-cols-2 gap-2">
                      <div>
                        <label className="text-xs text-gray-500">Ingredient (from recipe)</label>
                        <select value={step.MasterSKU||''} onChange={e=>{const ing=recipeIngs.find(x=>String(x.MasterSKU)===e.target.value);if(ing)selectIng(i,ing);else{upStep(i,'IngredientName','');upStep(i,'MasterSKU','');}}} className="inp text-sm p-2">
                          <option value="">-- Optional --</option>
                          {recipeIngs.map(ing=><option key={ing.MasterSKU} value={ing.MasterSKU}>{ing.Name}</option>)}
                        </select>
                      </div>
                      <div>
                        <label className="text-xs text-gray-500">Duration</label>
                        <input value={step.Duration||''} onChange={e=>upStep(i,'Duration',e.target.value)} className="inp text-sm p-2" placeholder="e.g., 5 min"/>
                      </div>
                    </div>
                    
                    <div>
                      <label className="text-xs text-gray-500">Notes</label>
                      <input value={step.Notes||''} onChange={e=>upStep(i,'Notes',e.target.value)} className="inp text-sm p-2" placeholder="Additional details..."/>
                    </div>
                  </div>
                </div>
              )}</div>}
          </>}
        </div>
        
        <div className="p-4 border-t bg-gray-50">
          <button onClick={save} disabled={saving} className="btn w-full text-white" style={{background:'linear-gradient(135deg,#7c3aed,#5b21b6)'}}>
            {saving?'Saving...':`ğŸ’¾ Save Procedure (${steps.length} steps)`}
          </button>
        </div>
      </div>
    </div>
  );
}

function Costing({apiUrl,dishes,branches,branch,settings,showToast}){
  const[sub,setSub]=useState('dishes');
  const[costs,setCosts]=useState([]);
  const[prices,setPrices]=useState([]);
  const[loading,setLoading]=useState(false);
  const[detail,setDetail]=useState(null);
  const[filterCat,setFilterCat]=useState('All');
  const[days,setDays]=useState(parseInt(settings.CostingLookbackDays)||30);
  const[method,setMethod]=useState(settings.CostingMethod||'Highest');
  const[selDish,setSelDish]=useState('');

  const calcSingle=async()=>{if(!selDish){showToast('Select a dish','error');return}setLoading(true);try{const r=await api(apiUrl,'calculateDishCost',{mcode:selDish,days,method,branch:branch==='All'?'':branch});setDetail(r);showToast('Done!')}catch(e){showToast(e.message,'error')}finally{setLoading(false)}};
  const calcAll=async()=>{if(!confirm('Calculate ALL '+dishes.length+' dishes? This may take 1-2 minutes.')){return}setLoading(true);try{const r=await api(apiUrl,'calculateAllDishCosts',{days,method,branch:branch==='All'?'':branch});setCosts(r.costs||[]);showToast('Calculated!')}catch(e){showToast(e.message,'error')}finally{setLoading(false)}};
  const loadPrices=async()=>{setLoading(true);try{const r=await api(apiUrl,'getIngredientPricesByBranch',{days,method});setPrices(r.prices||[]);showToast('Loaded!')}catch(e){showToast(e.message,'error')}finally{setLoading(false)}};
  const viewDetail=async mcode=>{try{const r=await api(apiUrl,'calculateDishCost',{mcode,days,method,branch:branch==='All'?'':branch});setDetail(r)}catch(e){showToast(e.message,'error')}};
  const[priceDetail,setPriceDetail]=useState(null);
  const exportPrices=()=>{const data=prices.map(item=>{const row={ItemName:item.ItemName,Unit:item.Unit,Category:item.Category||'',Avg:item.avgPrice,Min:item.minPrice,Max:item.maxPrice};branches.forEach(b=>{row[b.BranchCode]=item.branchPrices?.[b.BranchCode]??''});return row});downloadCSV(data,'ingredient_prices')};

  const filtCosts=filterCat==='All'?costs:costs.filter(c=>c.category===filterCat);
  const cats=[...new Set(costs.map(c=>c.category))];

  return(
    <div className="space-y-4 fade">
      {detail&&<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl max-w-lg w-full max-h-[85vh] overflow-hidden fade">
          <div className="p-4 border-b flex justify-between items-center"><h3 className="font-bold">{detail.dishName}</h3><button onClick={()=>setDetail(null)} className="text-2xl text-gray-400">âœ•</button></div>
          <div className="p-4 overflow-y-auto" style={{maxHeight:'60vh'}}>
            <div className="grid grid-cols-2 gap-3 mb-4">
              <div className="p-3 bg-green-50 rounded-xl"><p className="text-xs text-green-600">Total Cost</p><p className="text-xl font-bold text-green-700">{fmt(detail.cost)}</p></div>
              <div className="p-3 bg-blue-50 rounded-xl"><p className="text-xs text-blue-600">Cost/Serving</p><p className="text-xl font-bold text-blue-700">{fmt(detail.costPerServing)}</p></div>
              {detail.sellPrice>0&&<><div className="p-3 bg-amber-50 rounded-xl"><p className="text-xs text-amber-600">Sell Price</p><p className="text-xl font-bold text-amber-700">{fmt(detail.sellPrice)}</p></div>
              <div className="p-3 rounded-xl" style={{background:detail.marginPercent>=60?'#dcfce7':detail.marginPercent>=40?'#fef9c3':'#fee2e2'}}><p className="text-xs" style={{color:detail.marginPercent>=60?'#166534':detail.marginPercent>=40?'#854d0e':'#991b1b'}}>Margin</p><p className="text-xl font-bold" style={{color:detail.marginPercent>=60?'#166534':detail.marginPercent>=40?'#854d0e':'#991b1b'}}>{detail.marginPercent}%</p></div></>}
            </div>
            <h4 className="font-semibold mb-2">Breakdown</h4>
            <div className="border rounded-xl overflow-hidden">
              {detail.breakdown?.map((item,i)=><div key={i} className="p-3 border-b flex justify-between items-center" style={{background:item.warning?'#fef2f2':'white'}}><div><p className="font-medium text-sm">{item.ingredientName}</p><p className="text-xs text-gray-500">{item.qty} {item.unit}{item.type==='dish'?' (comp)':''}</p></div><div className="text-right"><p className="font-semibold" style={{color:item.warning?'#dc2626':'#059669'}}>{item.warning?'âš ï¸':fmt(item.cost)}</p>{item.warning&&<p className="text-xs text-red-500">{item.warning}</p>}</div></div>)}
            </div>
          </div>
        </div>
      </div>}

      <h2 className="text-lg font-bold text-gray-800">ğŸ’µ Costing</h2>

      <div className="card p-4">
        <h3 className="font-semibold text-gray-700 mb-3">âš™ï¸ Costing Parameters</h3>
        <div className="grid grid-cols-2 gap-3">
          <div><label className="lbl">Purchase History (Lookback)</label><select value={days} onChange={e=>setDays(parseInt(e.target.value))} className="inp"><option value="7">Last 7 days</option><option value="14">Last 14 days</option><option value="30">Last 30 days</option><option value="60">Last 60 days</option><option value="90">Last 90 days</option></select></div>
          <div><label className="lbl">Price Calculation Method</label><select value={method} onChange={e=>setMethod(e.target.value)} className="inp"><option value="Highest">Highest Price</option><option value="Average">Average Price</option><option value="Latest">Most Recent Price</option></select></div>
        </div>
      </div>

      <div className="flex gap-2">
        <button onClick={()=>setSub('dishes')} className={`btn flex-1 text-sm ${sub==='dishes'?'btn-p':'btn-s'}`}>ğŸ³ Calculate Dish Costs</button>
        <button onClick={()=>setSub('ingredients')} className={`btn flex-1 text-sm ${sub==='ingredients'?'btn-p':'btn-s'}`}>ğŸ“Š Ingredient Prices by Branch</button>
      </div>

      {sub==='dishes'&&<>
        <div className="card p-4 space-y-3">
          <h3 className="font-semibold text-gray-700">âš¡ Quick Cost - Single Dish</h3>
          <p className="text-xs text-gray-500">Calculate cost for one dish based on its recipe ingredients</p>
          <select value={selDish} onChange={e=>setSelDish(e.target.value)} className="inp">
            <option value="">-- Select a dish --</option>
            {dishes.map(d=><option key={d.MCODE} value={d.MCODE}>{d.Name} ({d.MCODE})</option>)}
          </select>
          <button onClick={calcSingle} disabled={loading||!selDish} className="btn btn-p w-full">{loading?'Calculating...':'âš¡ Calculate Selected Dish'}</button>
        </div>

        <div className="card p-4">
          <h3 className="font-semibold text-gray-700 mb-2">ğŸ“Š Batch Calculate - All Dishes</h3>
          <p className="text-xs text-gray-500 mb-3">Calculates costs for all {dishes.length} dishes and updates the database. Takes 1-2 minutes.</p>
          <button onClick={calcAll} disabled={loading} className="btn btn-s w-full">{loading?'Calculating...':'ğŸ”„ Calculate All Dishes & Save'}</button>
        </div>
        {costs.length>0&&<>
          <div className="flex gap-2 overflow-x-auto pb-2">
            <button onClick={()=>setFilterCat('All')} className={`px-3 py-1 rounded-full text-sm whitespace-nowrap ${filterCat==='All'?'bg-red-600 text-white':'bg-gray-200'}`}>All ({costs.length})</button>
            {cats.map(cat=><button key={cat} onClick={()=>setFilterCat(cat)} className={`px-3 py-1 rounded-full text-sm whitespace-nowrap ${filterCat===cat?'bg-red-600 text-white':'bg-gray-200'}`}>{cat}</button>)}
          </div>
          <div className="card tbl-wrap">
            <table className="w-full text-sm">
              <thead><tr className="border-b bg-gray-50"><th className="p-3 text-left">Dish</th><th className="p-3 text-right">Cost</th><th className="p-3 text-right">Sell</th><th className="p-3 text-right">Margin</th></tr></thead>
              <tbody>{filtCosts.map(d=><tr key={d.mcode} className="border-b hover:bg-gray-50 cursor-pointer" onClick={()=>viewDetail(d.mcode)}><td className="p-3"><p className="font-medium">{d.name}</p><p className="text-xs text-gray-500">{d.mcode}</p></td><td className="p-3 text-right font-medium text-green-700">{fmt(d.cost)}</td><td className="p-3 text-right">{d.sellPrice?fmt(d.sellPrice):'-'}</td><td className="p-3 text-right">{d.sellPrice>0?<span className={`font-semibold ${d.marginPercent>=60?'text-green-600':d.marginPercent>=40?'text-amber-600':'text-red-600'}`}>{d.marginPercent}%</span>:'-'}</td></tr>)}</tbody>
            </table>
          </div>
        </>}
      </>}

      {sub==='ingredients'&&<>
        {priceDetail&&<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={()=>setPriceDetail(null)}>
          <div className="bg-white rounded-2xl p-4 max-w-sm w-full fade" onClick={e=>e.stopPropagation()}>
            <div className="flex justify-between items-start mb-3">
              <div><h3 className="font-bold text-lg">{priceDetail.item}</h3><p className="text-sm text-gray-500">{priceDetail.branch}</p></div>
              <button onClick={()=>setPriceDetail(null)} className="text-2xl text-gray-400">âœ•</button>
            </div>
            <div className="space-y-2 text-sm">
              <div className="flex justify-between p-2 bg-gray-50 rounded-lg"><span className="text-gray-600">Unit Price</span><span className="font-bold text-green-700">{priceDetail.price}</span></div>
              <div className="flex justify-between p-2 bg-gray-50 rounded-lg"><span className="text-gray-600">Last Purchase Date</span><span className="font-medium">{priceDetail.lastDate}</span></div>
              <div className="flex justify-between p-2 bg-gray-50 rounded-lg"><span className="text-gray-600">Supplier</span><span className="font-medium">{priceDetail.supplier}</span></div>
              <div className="flex justify-between p-2 bg-gray-50 rounded-lg"><span className="text-gray-600">Total Purchases</span><span className="font-medium">{priceDetail.count}</span></div>
            </div>
          </div>
        </div>}
        <div className="card p-4 mb-3">
          <p className="text-xs text-gray-500">Compare ingredient prices across all branches. Green = lowest price, Red = highest price. Tap any price for purchase details.</p>
        </div>
        <div className="flex gap-2">
          <button onClick={loadPrices} disabled={loading} className="btn btn-p flex-1">{loading?'Loading...':'ğŸ”„ Load Ingredient Prices'}</button>
          {prices.length>0&&<button onClick={exportPrices} className="btn btn-s">ğŸ“¥ Export CSV</button>}
        </div>
        {prices.length>0&&<div className="card tbl-wrap">
          <table className="w-full text-sm">
            <thead><tr className="border-b bg-gray-50"><th className="p-2 text-left sticky left-0 bg-gray-50 z-10">Ingredient</th>{branches.map(b=><th key={b.BranchCode} className="p-2 text-right whitespace-nowrap">{b.BranchCode}</th>)}<th className="p-2 text-right">Avg</th></tr></thead>
            <tbody>{prices.map((item,idx)=><tr key={idx} className="border-b">
              <td className="p-2 sticky left-0 bg-white z-10"><p className="font-medium text-sm">{item.ItemName}</p><p className="text-xs text-gray-400">/{item.Unit}</p></td>
              {branches.map(b=>{const p=item.branchPrices?.[b.BranchCode];const isLow=b.BranchCode===item.lowestBranch;const isHigh=b.BranchCode===item.highestBranch;const det=item.branchDetails?.[b.BranchCode];
                return<td key={b.BranchCode} className={`p-2 text-right ${isLow?'low':isHigh?'high':''} ${det?'cursor-pointer active:bg-gray-100':''}`} onClick={()=>det&&setPriceDetail({item:item.ItemName,branch:b.BranchName,price:fmtPrice(p,item.Unit),lastDate:fmtDate(det.lastDate),supplier:det.lastSupplier||'-',count:det.purchaseCount})}>{p?<span className={det?'underline decoration-dotted':''}>{fmtPrice(p,item.Unit)}</span>:'-'}</td>})}
              <td className="p-2 text-right font-medium">{item.avgPrice?fmtPrice(item.avgPrice,item.Unit):'-'}</td>
            </tr>)}</tbody>
          </table>
          <div className="p-3 bg-gray-50 border-t text-xs text-gray-500"><span className="inline-block px-2 py-1 rounded mr-2 low">ğŸŸ¢ Lowest</span><span className="inline-block px-2 py-1 rounded high">ğŸ”´ Highest</span><span className="ml-4">ğŸ‘† Tap price for details</span></div>
        </div>}
      </>}
    </div>
  );
}

function Reports({apiUrl,branches,branch,purchases,expenses,dishes,showToast}){
  const[sub,setSub]=useState('daily');
  const[dateRange,setDateRange]=useState({start:new Date(Date.now()-30*24*60*60*1000).toISOString().split('T')[0],end:new Date().toISOString().split('T')[0]});
  const[allPurchases,setAllPurchases]=useState([]);
  const[allExpenses,setAllExpenses]=useState([]);
  const[allCosts,setAllCosts]=useState([]);
  const[loading,setLoading]=useState(false);
  const[viewPhoto,setViewPhoto]=useState(null);
  const[invoiceType,setInvoiceType]=useState('purchases'); // 'purchases' or 'expenses'

  const loadData=async()=>{
    setLoading(true);
    try{
      const days=Math.ceil((new Date(dateRange.end)-new Date(dateRange.start))/(24*60*60*1000))+1;
      const[p,e]=await Promise.all([
        api(apiUrl,'getPurchases',{branch:branch==='All'?'':branch,days}),
        api(apiUrl,'getExpenses',{branch:branch==='All'?'':branch,days})
      ]);
      setAllPurchases((p.purchases||[]).filter(x=>x.PurchaseDate>=dateRange.start&&x.PurchaseDate<=dateRange.end));
      setAllExpenses((e.expenses||[]).filter(x=>x.Date>=dateRange.start&&x.Date<=dateRange.end));
    }catch(e){showToast(e.message,'error')}
    finally{setLoading(false)}
  };

  const loadCosts=async()=>{
    setLoading(true);
    try{
      const r=await api(apiUrl,'calculateAllDishCosts',{days:30,method:'Highest',branch:branch==='All'?'':branch});
      setAllCosts(r.costs||[]);
    }catch(e){showToast(e.message,'error')}
    finally{setLoading(false)}
  };

  useEffect(()=>{loadData()},[dateRange,branch]);

  // Helper functions
  const groupBy=(arr,keyFn)=>{const m={};arr.forEach(x=>{const k=keyFn(x);if(!m[k])m[k]=[];m[k].push(x)});return m};
  const sumBy=(arr,fn)=>arr.reduce((s,x)=>s+(fn(x)||0),0);

  // Daily Summary Data
  const dailyP=groupBy(allPurchases,p=>p.PurchaseDate);
  const dailyE=groupBy(allExpenses,e=>e.Date);
  const allDates=[...new Set([...Object.keys(dailyP),...Object.keys(dailyE)])].sort().reverse();
  const dailyData=allDates.map(d=>({date:d,purchases:sumBy(dailyP[d]||[],x=>parseFloat(x.Price)),expenses:sumBy(dailyE[d]||[],x=>parseFloat(x.Amount)),pCount:(dailyP[d]||[]).length,eCount:(dailyE[d]||[]).length}));

  // Weekly/Monthly Data
  const getWeek=d=>{const dt=new Date(d);const start=new Date(dt);start.setDate(dt.getDate()-dt.getDay());return start.toISOString().split('T')[0]};
  const getMonth=d=>d.substring(0,7);
  const weeklyP=groupBy(allPurchases,p=>getWeek(p.PurchaseDate));
  const weeklyE=groupBy(allExpenses,e=>getWeek(e.Date));
  const monthlyP=groupBy(allPurchases,p=>getMonth(p.PurchaseDate));
  const monthlyE=groupBy(allExpenses,e=>getMonth(e.Date));

  // Branch Summary
  const branchP=groupBy(allPurchases,p=>p.BranchCode||p.Branch);
  const branchE=groupBy(allExpenses,e=>e.BranchCode||e.Branch);
  const branchData=branches.map(b=>({code:b.BranchCode,name:b.BranchName,purchases:sumBy(branchP[b.BranchCode]||branchP[b.BranchName]||[],x=>parseFloat(x.Price)),expenses:sumBy(branchE[b.BranchCode]||branchE[b.BranchName]||[],x=>parseFloat(x.Amount))}));

  // Top Ingredients - Enhanced
  const ingTotals={};
  const totalPurchaseCost=sumBy(allPurchases,p=>parseFloat(p.Price)||0);
  allPurchases.forEach(p=>{
    const k=p.ItemName;
    if(!ingTotals[k])ingTotals[k]={name:k,qty:0,cost:0,count:0,unit:p.BaseUnit||p.Unit,unitPrices:[],category:p.Category};
    ingTotals[k].qty+=parseFloat(p.Qty)||0;
    ingTotals[k].cost+=parseFloat(p.Price)||0;
    ingTotals[k].count++;
    if(parseFloat(p.UnitPrice)>0)ingTotals[k].unitPrices.push(parseFloat(p.UnitPrice));
  });
  // Calculate averages and conversions
  Object.values(ingTotals).forEach(ing=>{
    ing.avgPrice=ing.unitPrices.length>0?ing.unitPrices.reduce((a,b)=>a+b,0)/ing.unitPrices.length:0;
    ing.pct=totalPurchaseCost>0?(ing.cost/totalPurchaseCost*100):0;
    // Convert to kg/L for display
    if(ing.unit==='g'){ing.qtyKg=ing.qty/1000;ing.displayUnit='kg'}
    else if(ing.unit==='ml'){ing.qtyKg=ing.qty/1000;ing.displayUnit='L'}
    else{ing.qtyKg=ing.qty;ing.displayUnit=ing.unit}
  });
  const topIngByCost=Object.values(ingTotals).sort((a,b)=>b.cost-a.cost).slice(0,15);
  const topIngByQty=Object.values(ingTotals).sort((a,b)=>b.qty-a.qty).slice(0,15);

  // Price Trends
  const priceTrends={};
  allPurchases.forEach(p=>{const k=p.ItemName;if(!priceTrends[k])priceTrends[k]={name:k,unit:p.Unit,prices:[]};if(p.UnitPrice>0)priceTrends[k].prices.push({date:p.PurchaseDate,price:parseFloat(p.UnitPrice)})});
  Object.values(priceTrends).forEach(t=>{t.prices.sort((a,b)=>a.date.localeCompare(b.date));if(t.prices.length>=2){t.first=t.prices[0].price;t.last=t.prices[t.prices.length-1].price;t.change=((t.last-t.first)/t.first*100).toFixed(1)}});
  const priceAlerts=Object.values(priceTrends).filter(t=>t.change&&parseFloat(t.change)>10).sort((a,b)=>parseFloat(b.change)-parseFloat(a.change));

  // Expense by Category
  const expByCat=groupBy(allExpenses,e=>e.Category||'Other');
  const catData=Object.entries(expByCat).map(([cat,items])=>({category:cat,total:sumBy(items,x=>parseFloat(x.Amount)),count:items.length})).sort((a,b)=>b.total-a.total);

  // Expense by Payment
  const expByPay=groupBy(allExpenses,e=>e.PayMethod||'Cash');
  const payData=Object.entries(expByPay).map(([pay,items])=>({method:pay,total:sumBy(items,x=>parseFloat(x.Amount)),count:items.length})).sort((a,b)=>b.total-a.total);

  // Dish Profitability
  const profitDishes=[...allCosts].filter(d=>d.sellPrice>0).sort((a,b)=>b.marginPercent-a.marginPercent);
  const lowMarginDishes=profitDishes.filter(d=>d.marginPercent<50);

  const totalP=sumBy(allPurchases,x=>parseFloat(x.Price));
  const totalE=sumBy(allExpenses,x=>parseFloat(x.Amount));

  return(
    <div className="space-y-4 fade">
      <h2 className="text-lg font-bold text-gray-800">ğŸ“ˆ Reports</h2>

      <div className="card p-4">
        <div className="grid grid-cols-2 gap-3 mb-3">
          <div><label className="lbl">From</label><input type="date" value={dateRange.start} onChange={e=>setDateRange({...dateRange,start:e.target.value})} className="inp"/></div>
          <div><label className="lbl">To</label><input type="date" value={dateRange.end} onChange={e=>setDateRange({...dateRange,end:e.target.value})} className="inp"/></div>
        </div>
        <div className="grid grid-cols-2 gap-3 text-center">
          <div className="p-3 bg-red-50 rounded-xl"><p className="text-xs text-red-600">Total Purchases</p><p className="text-xl font-bold text-red-700">{fmt(totalP)}</p></div>
          <div className="p-3 bg-amber-50 rounded-xl"><p className="text-xs text-amber-600">Total Expenses</p><p className="text-xl font-bold text-amber-700">{fmt(totalE)}</p></div>
        </div>
      </div>

      <div className="flex gap-2 overflow-x-auto pb-2">
        {[{id:'daily',l:'ğŸ“… Daily'},{id:'weekly',l:'ğŸ“† Weekly'},{id:'branch',l:'ğŸ¢ Branch'},{id:'topIng',l:'ğŸ¥© Top Items'},{id:'priceAlert',l:'ğŸ”´ Price Alerts'},{id:'invoices',l:'ğŸ§¾ Invoices'},{id:'expCat',l:'ğŸ“‚ Exp Category'},{id:'expPay',l:'ğŸ’³ Exp Payment'},{id:'profit',l:'ğŸ’° Profitability'}].map(t=>
          <button key={t.id} onClick={()=>{setSub(t.id);if(t.id==='profit'&&allCosts.length===0)loadCosts()}} className={`px-3 py-2 rounded-lg text-sm font-medium whitespace-nowrap ${sub===t.id?'bg-red-600 text-white':'bg-gray-200'}`}>{t.l}</button>
        )}
      </div>

      {loading&&<div className="text-center py-8"><div className="w-8 h-8 border-4 border-red-200 border-t-red-600 rounded-full spin mx-auto"/></div>}

      {!loading&&sub==='daily'&&<div className="card">
        <div className="p-3 border-b bg-gray-50 font-semibold text-gray-700">ğŸ“… Daily Summary</div>
        <div className="tbl-wrap"><table className="w-full text-sm">
          <thead><tr className="border-b bg-gray-50"><th className="p-2 text-left">Date</th><th className="p-2 text-right">Purchases</th><th className="p-2 text-right">Expenses</th><th className="p-2 text-right">Net</th></tr></thead>
          <tbody>{dailyData.slice(0,30).map(d=><tr key={d.date} className="border-b"><td className="p-2">{fmtDate(d.date)}<span className="text-xs text-gray-400 ml-1">({d.pCount}p/{d.eCount}e)</span></td><td className="p-2 text-right text-red-600">{fmt(d.purchases)}</td><td className="p-2 text-right text-amber-600">{fmt(d.expenses)}</td><td className="p-2 text-right font-medium">{fmt(d.purchases+d.expenses)}</td></tr>)}</tbody>
        </table></div>
      </div>}

      {!loading&&sub==='weekly'&&<div className="space-y-4">
        <div className="card">
          <div className="p-3 border-b bg-gray-50 font-semibold text-gray-700">ğŸ“† Weekly Summary</div>
          <div className="tbl-wrap"><table className="w-full text-sm">
            <thead><tr className="border-b bg-gray-50"><th className="p-2 text-left">Week Starting</th><th className="p-2 text-right">Purchases</th><th className="p-2 text-right">Expenses</th></tr></thead>
            <tbody>{[...new Set([...Object.keys(weeklyP),...Object.keys(weeklyE)])].sort().reverse().slice(0,12).map(w=><tr key={w} className="border-b"><td className="p-2">{fmtDate(w)}</td><td className="p-2 text-right text-red-600">{fmt(sumBy(weeklyP[w]||[],x=>parseFloat(x.Price)))}</td><td className="p-2 text-right text-amber-600">{fmt(sumBy(weeklyE[w]||[],x=>parseFloat(x.Amount)))}</td></tr>)}</tbody>
          </table></div>
        </div>
        <div className="card">
          <div className="p-3 border-b bg-gray-50 font-semibold text-gray-700">ğŸ“† Monthly Summary</div>
          <div className="tbl-wrap"><table className="w-full text-sm">
            <thead><tr className="border-b bg-gray-50"><th className="p-2 text-left">Month</th><th className="p-2 text-right">Purchases</th><th className="p-2 text-right">Expenses</th></tr></thead>
            <tbody>{[...new Set([...Object.keys(monthlyP),...Object.keys(monthlyE)])].sort().reverse().slice(0,12).map(m=><tr key={m} className="border-b"><td className="p-2">{m}</td><td className="p-2 text-right text-red-600">{fmt(sumBy(monthlyP[m]||[],x=>parseFloat(x.Price)))}</td><td className="p-2 text-right text-amber-600">{fmt(sumBy(monthlyE[m]||[],x=>parseFloat(x.Amount)))}</td></tr>)}</tbody>
          </table></div>
        </div>
      </div>}

      {!loading&&sub==='branch'&&<div className="card">
        <div className="p-3 border-b bg-gray-50 font-semibold text-gray-700">ğŸ¢ Branch Comparison</div>
        <div className="tbl-wrap"><table className="w-full text-sm">
          <thead><tr className="border-b bg-gray-50"><th className="p-2 text-left">Branch</th><th className="p-2 text-right">Purchases</th><th className="p-2 text-right">Expenses</th><th className="p-2 text-right">Total</th></tr></thead>
          <tbody>{branchData.map(b=><tr key={b.code} className="border-b"><td className="p-2"><span className="font-medium">{b.code}</span><span className="text-xs text-gray-400 ml-1 hidden sm:inline">{b.name}</span></td><td className="p-2 text-right text-red-600">{fmt(b.purchases)}</td><td className="p-2 text-right text-amber-600">{fmt(b.expenses)}</td><td className="p-2 text-right font-bold">{fmt(b.purchases+b.expenses)}</td></tr>)}</tbody>
          <tfoot><tr className="bg-gray-100 font-bold"><td className="p-2">TOTAL</td><td className="p-2 text-right text-red-700">{fmt(sumBy(branchData,x=>x.purchases))}</td><td className="p-2 text-right text-amber-700">{fmt(sumBy(branchData,x=>x.expenses))}</td><td className="p-2 text-right">{fmt(sumBy(branchData,x=>x.purchases+x.expenses))}</td></tr></tfoot>
        </table></div>
      </div>}

      {!loading&&sub==='topIng'&&<div className="space-y-4">
        <div className="card">
          <div className="p-3 border-b bg-gray-50 font-semibold text-gray-700">ğŸ¥© Top Items by Cost</div>
          <div className="tbl-wrap"><table className="w-full text-sm">
            <thead><tr className="border-b bg-gray-50"><th className="p-2 text-left">#</th><th className="p-2 text-left">Item</th><th className="p-2 text-right">Total Cost</th><th className="p-2 text-right">% of Total</th><th className="p-2 text-right">Qty</th><th className="p-2 text-right">Avg Price</th><th className="p-2 text-right">Purchases</th></tr></thead>
            <tbody>{topIngByCost.map((ing,i)=><tr key={ing.name} className="border-b hover:bg-gray-50">
              <td className="p-2 text-gray-400">{i+1}</td>
              <td className="p-2"><p className="font-medium">{ing.name}</p><p className="text-xs text-gray-400">{ing.category}</p></td>
              <td className="p-2 text-right text-red-600 font-bold">{fmt(ing.cost)}</td>
              <td className="p-2 text-right"><span className="px-2 py-0.5 rounded-full text-xs bg-red-100 text-red-700">{ing.pct.toFixed(1)}%</span></td>
              <td className="p-2 text-right"><span className="font-medium">{ing.qtyKg.toFixed(2)}</span> <span className="text-gray-400">{ing.displayUnit}</span></td>
              <td className="p-2 text-right text-green-600">{ing.avgPrice>0?`â‚±${ing.avgPrice.toFixed(4)}/${ing.unit}`:'-'}</td>
              <td className="p-2 text-right text-gray-500">{ing.count}x</td>
            </tr>)}</tbody>
            <tfoot><tr className="bg-gray-100 font-bold"><td className="p-2"></td><td className="p-2">TOTAL</td><td className="p-2 text-right text-red-700">{fmt(totalPurchaseCost)}</td><td className="p-2 text-right">100%</td><td colSpan="3"></td></tr></tfoot>
          </table></div>
        </div>
        <div className="card">
          <div className="p-3 border-b bg-gray-50 font-semibold text-gray-700">ğŸ“¦ Top Items by Quantity</div>
          <div className="tbl-wrap"><table className="w-full text-sm">
            <thead><tr className="border-b bg-gray-50"><th className="p-2 text-left">#</th><th className="p-2 text-left">Item</th><th className="p-2 text-right">Total Qty</th><th className="p-2 text-right">Raw (g/ml)</th><th className="p-2 text-right">Total Cost</th><th className="p-2 text-right">Purchases</th></tr></thead>
            <tbody>{topIngByQty.map((ing,i)=><tr key={ing.name} className="border-b hover:bg-gray-50">
              <td className="p-2 text-gray-400">{i+1}</td>
              <td className="p-2"><p className="font-medium">{ing.name}</p><p className="text-xs text-gray-400">{ing.category}</p></td>
              <td className="p-2 text-right"><span className="font-bold text-lg">{ing.qtyKg.toFixed(2)}</span> <span className="text-gray-500">{ing.displayUnit}</span></td>
              <td className="p-2 text-right text-gray-400">{ing.qty.toLocaleString()} {ing.unit}</td>
              <td className="p-2 text-right text-red-600 font-medium">{fmt(ing.cost)}</td>
              <td className="p-2 text-right text-gray-500">{ing.count}x</td>
            </tr>)}</tbody>
          </table></div>
        </div>
      </div>}

      {!loading&&sub==='priceAlert'&&<div className="card">
        <div className="p-3 border-b bg-gray-50 font-semibold text-gray-700">ğŸ”´ Price Increase Alerts (&gt;10%)</div>
        {priceAlerts.length===0?<p className="p-8 text-center text-gray-400">No significant price increases</p>:
        <div className="tbl-wrap"><table className="w-full text-sm">
          <thead><tr className="border-b bg-gray-50"><th className="p-2 text-left">Item</th><th className="p-2 text-right">First Price</th><th className="p-2 text-right">Latest Price</th><th className="p-2 text-right">Change</th></tr></thead>
          <tbody>{priceAlerts.map(t=><tr key={t.name} className="border-b"><td className="p-2 font-medium">{t.name}<span className="text-xs text-gray-400 ml-1">/{t.unit}</span></td><td className="p-2 text-right text-gray-500">{t.first?.toFixed(2)}</td><td className="p-2 text-right font-medium">{t.last?.toFixed(2)}</td><td className="p-2 text-right"><span className="px-2 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700">+{t.change}%</span></td></tr>)}</tbody>
        </table></div>}
      </div>}

      {/* Photo Viewer Modal */}
      {viewPhoto&&<div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4" onClick={()=>setViewPhoto(null)}>
        <div className="max-w-2xl w-full">
          <img src={viewPhoto} alt="Invoice/Receipt" className="w-full rounded-lg"/>
          <p className="text-center text-white mt-3 text-sm">Tap anywhere to close</p>
        </div>
      </div>}

      {!loading&&sub==='invoices'&&<div className="space-y-4">
        <div className="flex gap-2">
          <button onClick={()=>setInvoiceType('purchases')} className={`flex-1 p-3 rounded-xl font-medium ${invoiceType==='purchases'?'bg-red-600 text-white':'bg-gray-200'}`}>ğŸ§¾ Purchase Invoices</button>
          <button onClick={()=>setInvoiceType('expenses')} className={`flex-1 p-3 rounded-xl font-medium ${invoiceType==='expenses'?'bg-amber-500 text-white':'bg-gray-200'}`}>ğŸ§¾ Expense Receipts</button>
        </div>
        
        {invoiceType==='purchases'&&<div className="card">
          <div className="p-3 border-b bg-gray-50 font-semibold text-gray-700">ğŸ§¾ Purchase Invoices with Photos</div>
          {(()=>{
            const withPhotos=allPurchases.filter(p=>p.InvoicePhoto);
            const grouped={};
            withPhotos.forEach(p=>{
              const key=p.PurchaseDate+'|'+p.Supplier+'|'+p.PO;
              if(!grouped[key])grouped[key]={date:p.PurchaseDate,supplier:p.Supplier,po:p.PO,photo:p.InvoicePhoto,items:[],total:0};
              grouped[key].items.push(p);
              grouped[key].total+=parseFloat(p.Price)||0;
            });
            const invoices=Object.values(grouped).sort((a,b)=>new Date(b.date)-new Date(a.date));
            return invoices.length===0?<p className="p-8 text-center text-gray-400">No invoices with photos in this period</p>:
            <div className="divide-y">
              {invoices.map((inv,i)=><div key={i} className="p-3">
                <div className="flex gap-3">
                  {inv.photo&&<button onClick={()=>setViewPhoto(inv.photo)} className="w-20 h-20 rounded-lg overflow-hidden bg-gray-200 flex-shrink-0 hover:opacity-80">
                    <img src={inv.photo} alt="Invoice" className="w-full h-full object-cover"/>
                  </button>}
                  <div className="flex-1 min-w-0">
                    <p className="font-bold text-gray-800">{inv.supplier||'(No Supplier)'}</p>
                    <p className="text-xs text-gray-500">{fmtDate(inv.date)} {inv.po&&<span>â€¢ PO: {inv.po}</span>}</p>
                    <p className="text-sm text-gray-600 mt-1">{inv.items.length} items</p>
                    <p className="font-bold text-red-600 text-lg">{fmt(inv.total)}</p>
                  </div>
                </div>
                <div className="mt-2 pl-2 border-l-2 border-gray-200 space-y-1">
                  {inv.items.slice(0,5).map((p,j)=><div key={j} className="flex justify-between text-sm">
                    <span className="text-gray-600">{p.ItemName} <span className="text-gray-400">({p.Qty} {p.ContainerType})</span></span>
                    <span className="text-red-600">{fmt(p.Price)}</span>
                  </div>)}
                  {inv.items.length>5&&<p className="text-xs text-gray-400">+{inv.items.length-5} more items</p>}
                </div>
              </div>)}
            </div>
          })()}
        </div>}
        
        {invoiceType==='expenses'&&<div className="card">
          <div className="p-3 border-b bg-gray-50 font-semibold text-gray-700">ğŸ§¾ Expense Receipts with Photos</div>
          {(()=>{
            const withPhotos=allExpenses.filter(e=>e.ReceiptPhoto);
            return withPhotos.length===0?<p className="p-8 text-center text-gray-400">No receipts with photos in this period</p>:
            <div className="divide-y">
              {withPhotos.sort((a,b)=>new Date(b.Date)-new Date(a.Date)).map((e,i)=><div key={i} className="p-3 flex gap-3">
                <button onClick={()=>setViewPhoto(e.ReceiptPhoto)} className="w-16 h-16 rounded-lg overflow-hidden bg-gray-200 flex-shrink-0 hover:opacity-80">
                  <img src={e.ReceiptPhoto} alt="Receipt" className="w-full h-full object-cover"/>
                </button>
                <div className="flex-1 min-w-0">
                  <p className="font-medium">{e.Description||e.Category}</p>
                  <p className="text-xs text-gray-500">{fmtDate(e.Date)} â€¢ {e.Category} â€¢ {e.BranchCode}</p>
                  {e.Vendor&&<p className="text-xs text-gray-400">Payee: {e.Vendor}</p>}
                </div>
                <span className="font-bold text-amber-600">{fmt(e.Amount)}</span>
              </div>)}
            </div>
          })()}
        </div>}
      </div>}

      {!loading&&sub==='expCat'&&<div className="card">
        <div className="p-3 border-b bg-gray-50 font-semibold text-gray-700">ğŸ“‚ Expenses by Category</div>
        <div className="tbl-wrap"><table className="w-full text-sm">
          <thead><tr className="border-b bg-gray-50"><th className="p-2 text-left">Category</th><th className="p-2 text-right">Amount</th><th className="p-2 text-right">%</th><th className="p-2 text-right">Count</th></tr></thead>
          <tbody>{catData.map(c=><tr key={c.category} className="border-b"><td className="p-2 font-medium">{c.category}</td><td className="p-2 text-right text-amber-600 font-bold">{fmt(c.total)}</td><td className="p-2 text-right text-gray-500">{totalE>0?(c.total/totalE*100).toFixed(1):0}%</td><td className="p-2 text-right text-gray-400">{c.count}</td></tr>)}</tbody>
          <tfoot><tr className="bg-gray-100 font-bold"><td className="p-2">TOTAL</td><td className="p-2 text-right text-amber-700">{fmt(totalE)}</td><td className="p-2 text-right">100%</td><td className="p-2 text-right">{allExpenses.length}</td></tr></tfoot>
        </table></div>
      </div>}

      {!loading&&sub==='expPay'&&<div className="card">
        <div className="p-3 border-b bg-gray-50 font-semibold text-gray-700">ğŸ’³ Expenses by Payment Method</div>
        <div className="tbl-wrap"><table className="w-full text-sm">
          <thead><tr className="border-b bg-gray-50"><th className="p-2 text-left">Method</th><th className="p-2 text-right">Amount</th><th className="p-2 text-right">%</th><th className="p-2 text-right">Count</th></tr></thead>
          <tbody>{payData.map(p=><tr key={p.method} className="border-b"><td className="p-2 font-medium">{p.method}</td><td className="p-2 text-right text-amber-600 font-bold">{fmt(p.total)}</td><td className="p-2 text-right text-gray-500">{totalE>0?(p.total/totalE*100).toFixed(1):0}%</td><td className="p-2 text-right text-gray-400">{p.count}</td></tr>)}</tbody>
        </table></div>
      </div>}

      {!loading&&sub==='profit'&&<div className="space-y-4">
        {allCosts.length===0?<div className="card p-8 text-center"><p className="text-gray-400 mb-4">Load dish costs first</p><button onClick={loadCosts} className="btn btn-p">ğŸ”„ Calculate All Dish Costs</button></div>:<>
        <div className="card">
          <div className="p-3 border-b bg-gray-50 font-semibold text-gray-700">ğŸ’° Most Profitable Dishes</div>
          <div className="tbl-wrap"><table className="w-full text-sm">
            <thead><tr className="border-b bg-gray-50"><th className="p-2 text-left">Dish</th><th className="p-2 text-right">Cost</th><th className="p-2 text-right">Price</th><th className="p-2 text-right">Margin</th></tr></thead>
            <tbody>{profitDishes.slice(0,15).map(d=><tr key={d.mcode} className="border-b"><td className="p-2"><span className="font-medium">{d.name}</span><span className="text-xs text-gray-400 ml-1">{d.mcode}</span></td><td className="p-2 text-right text-gray-500">{fmt(d.cost)}</td><td className="p-2 text-right">{fmt(d.sellPrice)}</td><td className="p-2 text-right"><span className={`px-2 py-1 rounded-full text-xs font-bold ${d.marginPercent>=60?'bg-green-100 text-green-700':d.marginPercent>=40?'bg-amber-100 text-amber-700':'bg-red-100 text-red-700'}`}>{d.marginPercent}%</span></td></tr>)}</tbody>
          </table></div>
        </div>
        {lowMarginDishes.length>0&&<div className="card">
          <div className="p-3 border-b bg-red-50 font-semibold text-red-700">âš ï¸ Low Margin Alert (&lt;50%)</div>
          <div className="tbl-wrap"><table className="w-full text-sm">
            <thead><tr className="border-b bg-gray-50"><th className="p-2 text-left">Dish</th><th className="p-2 text-right">Cost</th><th className="p-2 text-right">Price</th><th className="p-2 text-right">Margin</th></tr></thead>
            <tbody>{lowMarginDishes.map(d=><tr key={d.mcode} className="border-b bg-red-50/50"><td className="p-2"><span className="font-medium">{d.name}</span></td><td className="p-2 text-right text-gray-500">{fmt(d.cost)}</td><td className="p-2 text-right">{fmt(d.sellPrice)}</td><td className="p-2 text-right"><span className="px-2 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700">{d.marginPercent}%</span></td></tr>)}</tbody>
          </table></div>
        </div>}
        </>}
      </div>}
    </div>
  );
}

function Settings({apiUrl,setApiUrl,setReady,settings,branches,rowCounts,showToast,loadAll}){
  const[tempUrl,setTempUrl]=useState(apiUrl);
  const[archType,setArchType]=useState('Purchases');
  const[archDays,setArchDays]=useState(365);
  const[archPrev,setArchPrev]=useState(null);
  const[archiving,setArchiving]=useState(false);
  const[archLog,setArchLog]=useState([]);
  const[branchList,setBranchList]=useState([]);
  const[editBranch,setEditBranch]=useState(null);
  const[newBranch,setNewBranch]=useState(null);
  const[saving,setSaving]=useState(false);
  const[activeSessions,setActiveSessions]=useState([]);
  const[loadingSessions,setLoadingSessions]=useState(false);
  
  // Reset data state
  const[resetBranch,setResetBranch]=useState('ALL');
  const[resetOptions,setResetOptions]=useState({purchases:true,expenses:true,counters:true,sessions:false});
  const[resetting,setResetting]=useState(false);
  
  // Icon picker state
  const[showIconPicker,setShowIconPicker]=useState(null); // {type:'ingredient'|'expense', category:string}
  const[categoryIcons,setCategoryIcons]=useState({});
  const[expenseIcons,setExpenseIcons]=useState({});
  const[savingIcons,setSavingIcons]=useState(false);
  const[newCatName,setNewCatName]=useState('');
  const[addingCat,setAddingCat]=useState(null); // 'ingredient' or 'expense'

  // Parse existing icons from settings
  useEffect(()=>{
    const ingIcons={};
    const expIcons={};
    if(settings.CategoryIcons){
      settings.CategoryIcons.split(',').forEach(p=>{
        const[name,icon]=p.split(':');
        if(name&&icon)ingIcons[name.trim()]=icon.trim();
      });
    }
    if(settings.ExpenseIcons){
      settings.ExpenseIcons.split(',').forEach(p=>{
        const[name,icon]=p.split(':');
        if(name&&icon)expIcons[name.trim()]=icon.trim();
      });
    }
    setCategoryIcons(ingIcons);
    setExpenseIcons(expIcons);
  },[settings]);

  // Default icons for display
  const defaultIngIcons={'Meat':'ğŸ¥©','Seafood':'ğŸ¦','Vegetables':'ğŸ¥¬','Dairy':'ğŸ¥›','Dry Goods':'ğŸŒ¾','Spices':'ğŸŒ¶ï¸','Beverages':'ğŸ¥¤','Frozen':'ğŸ§Š','Poultry':'ğŸ—','Pork':'ğŸ·','Beef':'ğŸ„','Supplies':'ğŸ“¦','Noodles':'ğŸœ','Sauce':'ğŸ¥«','Oil':'ğŸ«’','Eggs':'ğŸ¥š','Rice':'ğŸš','Flour':'ğŸŒ¾','Sugar':'ğŸ¬','Condiments':'ğŸ§‚','Canned':'ğŸ¥«','Paper':'ğŸ“„','Cleaning':'ğŸ§¹','Packaging':'ğŸ“¦'};
  const defaultExpIcons={'Utilities':'ğŸ’¡','Rent':'ğŸ ','Salaries':'ğŸ‘¥','Supplies':'ğŸ“¦','Transportation':'ğŸš—','Repairs':'ğŸ”§','Marketing':'ğŸ“¢','Miscellaneous':'ğŸ“‹','Food':'ğŸ½ï¸','Cleaning':'ğŸ§¹','Equipment':'âš™ï¸','Communication':'ğŸ“±','Insurance':'ğŸ›¡ï¸','Taxes':'ğŸ“Š','Internet':'ğŸŒ','Water':'ğŸ’§','Electric':'âš¡','Gas':'ğŸ”¥','Fuel':'â›½','Bank Fees':'ğŸ¦'};

  // Emoji palette for picker
  const emojiPalette=['ğŸ¥©','ğŸ¦','ğŸŸ','ğŸ¦‘','ğŸ¦€','ğŸ—','ğŸ·','ğŸ„','ğŸ”','ğŸ¥¬','ğŸ¥•','ğŸ…','ğŸ§…','ğŸ¥”','ğŸ†','ğŸŒ½','ğŸ¥’','ğŸŒ¶ï¸','ğŸ§„','ğŸ¥¦','ğŸ„','ğŸ¥›','ğŸ§ˆ','ğŸ¥š','ğŸ§€','ğŸŒ¾','ğŸš','ğŸœ','ğŸ¥«','ğŸ«’','ğŸ§‚','ğŸ¬','ğŸ¥¤','ğŸ§ƒ','ğŸº','â˜•','ğŸ§Š','ğŸ“¦','ğŸ§¹','ğŸ“„','ğŸ›’','ğŸ’¡','ğŸ ','ğŸ‘¥','ğŸš—','ğŸ”§','ğŸ“¢','ğŸ“‹','ğŸ½ï¸','âš™ï¸','ğŸ“±','ğŸ›¡ï¸','ğŸ“Š','ğŸŒ','ğŸ’§','âš¡','ğŸ”¥','â›½','ğŸ¦','ğŸ’°','ğŸ’µ','ğŸ¯','âœ¨','â­','ğŸ”´','ğŸŸ ','ğŸŸ¡','ğŸŸ¢','ğŸ”µ','ğŸŸ£','âšª','âš«'];

  const getIngIcon=(cat)=>categoryIcons[cat]||defaultIngIcons[cat]||'ğŸ“¦';
  const getExpIcon=(cat)=>expenseIcons[cat]||defaultExpIcons[cat]||'ğŸ’°';

  // Get all categories
  const ingCategories=[...new Set([...Object.keys(defaultIngIcons),...Object.keys(categoryIcons),...(settings.IngredientCategories||'').split(',').filter(Boolean).map(s=>s.trim())])];
  const expCategories=[...new Set([...Object.keys(defaultExpIcons),...Object.keys(expenseIcons),...(settings.ExpenseCategories||'').split(',').filter(Boolean).map(s=>s.trim())])];

  const setIcon=(type,cat,icon)=>{
    if(type==='ingredient'){
      setCategoryIcons(prev=>({...prev,[cat]:icon}));
    }else{
      setExpenseIcons(prev=>({...prev,[cat]:icon}));
    }
    setShowIconPicker(null);
  };

  const addNewCategory=()=>{
    if(!newCatName.trim()){showToast('Enter category name','error');return}
    const cat=newCatName.trim();
    if(addingCat==='ingredient'){
      setCategoryIcons(prev=>({...prev,[cat]:'ğŸ“¦'}));
    }else{
      setExpenseIcons(prev=>({...prev,[cat]:'ğŸ’°'}));
    }
    setShowIconPicker({type:addingCat,category:cat});
    setNewCatName('');
    setAddingCat(null);
    showToast(`Added "${cat}"! Now pick an icon.`);
  };

  const saveIcons=async()=>{
    setSavingIcons(true);
    try{
      const catIconStr=Object.entries(categoryIcons).map(([k,v])=>`${k}:${v}`).join(',');
      const expIconStr=Object.entries(expenseIcons).map(([k,v])=>`${k}:${v}`).join(',');
      
      await api(apiUrl,'updateSettings',{settings:JSON.stringify({CategoryIcons:catIconStr,ExpenseIcons:expIconStr})});
      showToast('Icons saved!');
      loadAll();
    }catch(e){showToast(e.message,'error')}
    finally{setSavingIcons(false)}
  };

  const updateUrl=()=>{localStorage.setItem('dainty_api',tempUrl);setApiUrl(tempUrl);showToast('Updated!')};
  const clearData=()=>{if(confirm('Disconnect?')){localStorage.clear();setReady(false)}};

  const preview=async()=>{try{const r=await api(apiUrl,'getArchivePreview',{dataType:archType,days:archDays});setArchPrev(r)}catch(e){showToast(e.message,'error')}};
  const doArchive=async()=>{if(!archPrev||archPrev.rowsToArchive===0)return;if(!confirm(`Delete ${archPrev.rowsToArchive} rows? Download backup first!`))return;setArchiving(true);try{const r=await api(apiUrl,'archiveData',{dataType:archType,days:archDays});showToast(`Archived ${r.rowsDeleted} rows!`);setArchPrev(null);loadAll();loadArchLog()}catch(e){showToast(e.message,'error')}finally{setArchiving(false)}};
  const loadArchLog=async()=>{try{const r=await api(apiUrl,'getArchiveLog');setArchLog(r.logs||[])}catch(e){console.error(e)}};
  const exportFull=async()=>{try{const r=await api(apiUrl,'exportData',{dataType:'Full'});const blob=new Blob([JSON.stringify(r,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='dainty_backup_'+new Date().toISOString().split('T')[0]+'.json';a.click();URL.revokeObjectURL(url);showToast('Downloaded!')}catch(e){showToast(e.message,'error')}};

  const loadBranches=async()=>{try{const r=await api(apiUrl,'getBranchesAdmin');setBranchList(r.branches||[])}catch(e){console.error(e)}};
  const loadActiveSessions=async()=>{setLoadingSessions(true);try{const r=await api(apiUrl,'getAllActiveSessions');setActiveSessions(r.sessions||[])}catch(e){console.error(e)}finally{setLoadingSessions(false)}};
  const forceLogout=async(sessionID,deviceName)=>{if(!confirm(`Force logout device "${deviceName}"?`))return;try{await api(apiUrl,'logoutSession',{sessionID});showToast('Device logged out');loadActiveSessions()}catch(e){showToast(e.message,'error')}};
  const clearAllSessions=async(branchCode)=>{if(!confirm(`Logout ALL devices from ${branchCode}?`))return;try{await api(apiUrl,'clearBranchSessions',{branchCode});showToast('All sessions cleared');loadActiveSessions()}catch(e){showToast(e.message,'error')}};
  
  const doReset=async()=>{
    const branchName=resetBranch==='ALL'?'ALL BRANCHES':branchList.find(b=>b.BranchCode===resetBranch)?.BranchName||resetBranch;
    const what=[];
    if(resetOptions.purchases)what.push('Purchases');
    if(resetOptions.expenses)what.push('Expenses');
    if(resetOptions.counters)what.push('ID Counters');
    if(resetOptions.sessions)what.push('Sessions');
    
    if(what.length===0){showToast('Select what to reset','error');return}
    
    // First confirm with password
    const adminPw=prompt(`âš ï¸ DANGER ZONE!\n\nThis will permanently delete:\nâ€¢ ${what.join('\nâ€¢ ')}\n\nFor: ${branchName}\n\nEnter ADMIN PASSWORD to continue:`);
    if(!adminPw){showToast('Reset cancelled');return}
    
    // Verify admin password
    try{
      const verify=await api(apiUrl,'verifyAdminPassword',{password:adminPw});
      if(!verify.success){
        showToast('Invalid admin password','error');
        return;
      }
    }catch(e){
      showToast('Password verification failed','error');
      return;
    }
    
    // Second confirm by typing RESET
    const confirmType=prompt('Password verified.\n\nType "RESET" to confirm deletion:');
    if(confirmType!=='RESET'){showToast('Reset cancelled');return}
    
    setResetting(true);
    try{
      const r=await api(apiUrl,'resetAllData',{branchCode:resetBranch,options:JSON.stringify(resetOptions)});
      let msg='Reset complete! ';
      if(r.results?.purchases)msg+=`Purchases: ${r.results.purchases.deleted||0} deleted. `;
      if(r.results?.expenses)msg+=`Expenses: ${r.results.expenses.deleted||0} deleted. `;
      if(r.results?.counters)msg+=`Counters reset. `;
      if(r.results?.sessions)msg+=`Sessions cleared.`;
      showToast(msg);
      loadAll();
      loadActiveSessions();
    }catch(e){showToast(e.message,'error')}
    finally{setResetting(false)}
  };
  
  const saveBranch=async()=>{if(!editBranch)return;setSaving(true);try{await api(apiUrl,'updateBranch',{branchCode:editBranch.BranchCode,data:JSON.stringify({BranchName:editBranch.BranchName,Password:editBranch.Password,Active:editBranch.Active})});showToast('Saved!');setEditBranch(null);loadBranches();loadAll()}catch(e){showToast(e.message,'error')}finally{setSaving(false)}};
  const addBranch=async()=>{if(!newBranch?.BranchCode||!newBranch?.BranchName||!newBranch?.Password){showToast('Fill all fields','error');return}setSaving(true);try{await api(apiUrl,'addBranch',{data:JSON.stringify(newBranch)});showToast('Added!');setNewBranch(null);loadBranches();loadAll()}catch(e){showToast(e.message,'error')}finally{setSaving(false)}};
  const deleteBranch=async(code)=>{if(!confirm('Delete this branch?'))return;try{await api(apiUrl,'deleteBranch',{branchCode:code});showToast('Deleted!');loadBranches();loadAll()}catch(e){showToast(e.message,'error')}};

  useEffect(()=>{loadArchLog();loadBranches();loadActiveSessions()},[]);

  return(
    <div className="space-y-4 fade">
      <h2 className="text-lg font-bold text-gray-800">âš™ï¸ Settings</h2>

      {/* Edit Branch Modal */}
      {editBranch&&<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={()=>setEditBranch(null)}>
        <div className="bg-white rounded-2xl p-4 max-w-sm w-full fade" onClick={e=>e.stopPropagation()}>
          <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg">âœï¸ Edit Branch</h3><button onClick={()=>setEditBranch(null)} className="text-2xl text-gray-400">âœ•</button></div>
          <div className="space-y-3">
            <div><label className="lbl">Branch Code</label><input value={editBranch.BranchCode} disabled className="inp bg-gray-100"/></div>
            <div><label className="lbl">Branch Name</label><input value={editBranch.BranchName} onChange={e=>setEditBranch({...editBranch,BranchName:e.target.value})} className="inp"/></div>
            <div><label className="lbl">Password</label><input value={editBranch.Password||''} onChange={e=>setEditBranch({...editBranch,Password:e.target.value})} className="inp" placeholder="Enter new password"/></div>
            <div className="flex items-center gap-2"><input type="checkbox" checked={editBranch.Active==='Yes'} onChange={e=>setEditBranch({...editBranch,Active:e.target.checked?'Yes':'No'})} id="active"/><label htmlFor="active" className="text-sm">Active</label></div>
            <button onClick={saveBranch} disabled={saving} className="btn btn-p w-full">{saving?'Saving...':'ğŸ’¾ Save'}</button>
          </div>
        </div>
      </div>}

      {/* Add Branch Modal */}
      {newBranch&&<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={()=>setNewBranch(null)}>
        <div className="bg-white rounded-2xl p-4 max-w-sm w-full fade" onClick={e=>e.stopPropagation()}>
          <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg">â• Add Branch</h3><button onClick={()=>setNewBranch(null)} className="text-2xl text-gray-400">âœ•</button></div>
          <div className="space-y-3">
            <div><label className="lbl">Branch Code *</label><input value={newBranch.BranchCode||''} onChange={e=>setNewBranch({...newBranch,BranchCode:e.target.value.toUpperCase()})} className="inp" placeholder="e.g., DNM"/></div>
            <div><label className="lbl">Branch Name *</label><input value={newBranch.BranchName||''} onChange={e=>setNewBranch({...newBranch,BranchName:e.target.value})} className="inp" placeholder="e.g., Dainty New Mall"/></div>
            <div><label className="lbl">Password *</label><input value={newBranch.Password||''} onChange={e=>setNewBranch({...newBranch,Password:e.target.value})} className="inp" placeholder="Password for branch login"/></div>
            <button onClick={addBranch} disabled={saving} className="btn btn-p w-full">{saving?'Adding...':'â• Add Branch'}</button>
          </div>
        </div>
      </div>}

      <div className="card p-4">
        <h3 className="font-semibold text-gray-700 mb-3">ğŸ“Š Database Status</h3>
        <div className="space-y-2">
          {Object.entries(rowCounts.counts||{}).map(([k,v])=><div key={k} className="flex justify-between items-center"><span className="text-sm text-gray-600">{k}</span><span className="font-medium">{(v||0).toLocaleString()}</span></div>)}
          <div className="pt-2 border-t flex justify-between items-center"><span className="font-semibold">Total</span><span className="font-bold text-lg">{(rowCounts.total||0).toLocaleString()}</span></div>
          <div className="mt-2"><div className="h-3 bg-gray-200 rounded-full overflow-hidden"><div className="h-full rounded-full transition-all" style={{width:`${rowCounts.percentUsed||0}%`,background:rowCounts.status==='critical'?'#dc2626':rowCounts.status==='warning'?'#f59e0b':'#10b981'}}/></div><p className="text-xs text-gray-500 mt-1">{rowCounts.percentUsed||0}% of {(rowCounts.maxRows||100000).toLocaleString()}</p></div>
        </div>
      </div>

      <div className="card p-4">
        <div className="flex justify-between items-center mb-3">
          <h3 className="font-semibold text-gray-700">ğŸ¢ Branches & Passwords</h3>
          <button onClick={()=>setNewBranch({BranchCode:'',BranchName:'',Password:''})} className="btn btn-p btn-sm">+ Add</button>
        </div>
        {branchList.length===0?<p className="text-gray-400 text-sm">No branches yet</p>:
          branchList.map(b=>
            <div key={b.BranchCode} className="py-3 border-b flex items-center">
              <div className="flex-1">
                <div className="flex items-center gap-2">
                  <span className="font-medium">{b.BranchName}</span>
                  {b.Active==='No'&&<span className="text-xs px-2 py-0.5 rounded-full bg-red-100 text-red-600">Inactive</span>}
                </div>
                <p className="text-xs text-gray-500">{b.BranchCode} â€¢ Password: {b.Password?'â€¢â€¢â€¢â€¢â€¢â€¢':'(not set)'}</p>
              </div>
              <button onClick={()=>setEditBranch({...b})} className="text-blue-500 p-2">âœï¸</button>
              <button onClick={()=>deleteBranch(b.BranchCode)} className="text-red-500 p-2">ğŸ—‘ï¸</button>
            </div>
          )}
      </div>

      {/* Active Sessions */}
      <div className="card p-4">
        <div className="flex justify-between items-center mb-3">
          <h3 className="font-semibold text-gray-700">ğŸ“± Active Sessions</h3>
          <button onClick={loadActiveSessions} disabled={loadingSessions} className="btn btn-s btn-sm">{loadingSessions?'Loading...':'ğŸ”„ Refresh'}</button>
        </div>
        <p className="text-xs text-gray-500 mb-3">Devices currently logged into branch apps. Changing a branch password will auto-logout all its sessions.</p>
        
        {activeSessions.length===0?<p className="text-gray-400 text-sm">No active sessions</p>:
          <div className="space-y-2">
            {/* Group by branch */}
            {[...new Set(activeSessions.map(s=>s.BranchCode))].sort().map(branchCode=>{
              const branchSessions=activeSessions.filter(s=>s.BranchCode===branchCode);
              const branchInfo=branchList.find(b=>b.BranchCode===branchCode);
              const branchName=branchInfo?.BranchName||branchCode;
              return(
                <div key={branchCode} className="border rounded-xl p-3">
                  <div className="flex justify-between items-center mb-2">
                    <div>
                      <span className="font-medium text-gray-700">{branchName}</span>
                      <span className="text-xs text-gray-400 ml-2">({branchCode})</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">{branchSessions.length} device{branchSessions.length>1?'s':''}</span>
                      <button onClick={()=>clearAllSessions(branchCode)} className="text-xs text-red-500 hover:text-red-700">Logout All</button>
                    </div>
                  </div>
                  {branchSessions.map(s=>
                    <div key={s.SessionID} className="flex items-center justify-between py-2 border-t text-sm">
                      <div>
                        <span className="font-medium">{s.DeviceName||'Unknown Device'}</span>
                        <span className="text-gray-400 ml-2">({s.Browser||'Unknown'})</span>
                        <p className="text-xs text-gray-400">Login: {s.LoginTime?new Date(s.LoginTime).toLocaleString('en-PH'):'-'}</p>
                        <p className="text-xs text-gray-400">Last active: {s.LastActive?new Date(s.LastActive).toLocaleString('en-PH'):'-'}</p>
                      </div>
                      <button onClick={()=>forceLogout(s.SessionID,s.DeviceName||'device')} className="text-red-500 text-xs px-2 py-1 hover:bg-red-50 rounded">ğŸšª Logout</button>
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        }
      </div>

      <div className="card p-4">
        <h3 className="font-semibold text-gray-700 mb-3">ğŸ“¦ Archive Old Data</h3>
        <div className="grid grid-cols-2 gap-3 mb-3">
          <div><label className="lbl">Data Type</label><select value={archType} onChange={e=>{setArchType(e.target.value);setArchPrev(null)}} className="inp"><option>Purchases</option><option>Expenses</option></select></div>
          <div><label className="lbl">Older Than</label><select value={archDays} onChange={e=>{setArchDays(parseInt(e.target.value));setArchPrev(null)}} className="inp"><option value="30">30 days</option><option value="90">90 days</option><option value="180">180 days</option><option value="365">1 year</option></select></div>
        </div>
        <button onClick={preview} className="btn btn-s w-full mb-3">Preview</button>
        {archPrev&&<div className="p-3 bg-amber-50 rounded-xl mb-3"><p className="text-sm text-amber-800"><strong>{archPrev.rowsToArchive.toLocaleString()}</strong> rows will be deleted{archPrev.dateRange?.start&&<span className="block text-xs mt-1">{archPrev.dateRange.start} to {archPrev.dateRange.end}</span>}</p></div>}
        {archPrev&&archPrev.rowsToArchive>0&&<button onClick={doArchive} disabled={archiving} className="btn w-full text-white" style={{background:'#dc2626'}}>{archiving?'Archiving...':`ğŸ—‘ï¸ Delete ${archPrev.rowsToArchive} Rows`}</button>}
        {archLog.length>0&&<div className="mt-4 pt-4 border-t"><p className="text-xs font-semibold text-gray-500 mb-2">History</p>{archLog.slice(0,5).map((l,i)=><p key={i} className="text-xs text-gray-500">{fmtDate(l.ArchiveDate)}: {l.DataType} - {l.RowsArchived} rows</p>)}</div>}
      </div>

      {/* Reset Data - Danger Zone */}
      <div className="card p-4 border-2 border-red-200">
        <h3 className="font-semibold text-red-600 mb-3">âš ï¸ Reset Data (Danger Zone)</h3>
        <p className="text-xs text-gray-500 mb-3">Permanently delete purchases, expenses, and reset counters. Requires ADMIN password from BranchPasswords sheet.</p>
        
        <div className="mb-3">
          <label className="lbl">Branch</label>
          <select value={resetBranch} onChange={e=>setResetBranch(e.target.value)} className="inp">
            <option value="ALL">ğŸŒ ALL BRANCHES</option>
            {branchList.map(b=><option key={b.BranchCode} value={b.BranchCode}>{b.BranchName} ({b.BranchCode})</option>)}
          </select>
        </div>
        
        <div className="space-y-2 mb-4">
          <label className="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" checked={resetOptions.purchases} onChange={e=>setResetOptions({...resetOptions,purchases:e.target.checked})}/>
            <span className="text-sm">ğŸ›’ Purchases ({rowCounts.Purchases?.toLocaleString()||0} rows)</span>
          </label>
          <label className="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" checked={resetOptions.expenses} onChange={e=>setResetOptions({...resetOptions,expenses:e.target.checked})}/>
            <span className="text-sm">ğŸ’° Expenses ({rowCounts.Expenses?.toLocaleString()||0} rows)</span>
          </label>
          <label className="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" checked={resetOptions.counters} onChange={e=>setResetOptions({...resetOptions,counters:e.target.checked})}/>
            <span className="text-sm">ğŸ”¢ ID Counters (reset to 0)</span>
          </label>
          <label className="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" checked={resetOptions.sessions} onChange={e=>setResetOptions({...resetOptions,sessions:e.target.checked})}/>
            <span className="text-sm">ğŸ“± Active Sessions (force logout)</span>
          </label>
        </div>
        
        <button onClick={doReset} disabled={resetting} className="btn w-full text-white" style={{background:'#dc2626'}}>
          {resetting?'Resetting...':'ğŸ—‘ï¸ Reset Selected Data'}
        </button>
      </div>

      <div className="card p-4">
        <h3 className="font-semibold text-gray-700 mb-3">ğŸ“¤ Export</h3>
        <button onClick={exportFull} className="btn btn-s w-full">ğŸ“¥ Full Backup (JSON)</button>
      </div>

      <div className="card p-4">
        <h3 className="font-semibold text-gray-700 mb-3">ğŸ”— API Connection</h3>
        <input value={tempUrl} onChange={e=>setTempUrl(e.target.value)} className="inp text-xs mb-3"/>
        <button onClick={updateUrl} className="btn btn-s w-full">Update URL</button>
      </div>

      <div className="card p-4">
        <h3 className="font-semibold text-gray-700 mb-3">ğŸ”§ System Settings</h3>
        {Object.entries(settings).filter(([k])=>k!=='CategoryIcons'&&k!=='ExpenseIcons').map(([k,v])=><div key={k} className="py-2 border-b"><p className="font-medium text-sm">{k}</p><p className="text-xs text-gray-500 break-all">{v}</p></div>)}
        <p className="text-xs text-gray-400 mt-3">Edit in Google Sheet â†’ Settings tab</p>
      </div>

      {/* Category Icon Picker */}
      <div className="card p-4">
        <div className="flex justify-between items-center mb-3">
          <h3 className="font-semibold text-gray-700">ğŸ¨ Category Icons</h3>
          <button onClick={saveIcons} disabled={savingIcons} className="btn btn-p btn-sm">{savingIcons?'Saving...':'ğŸ’¾ Save'}</button>
        </div>
        
        <p className="text-xs text-gray-500 mb-3">Tap any icon to change it</p>
        
        <div className="flex justify-between items-center mb-2">
          <h4 className="text-sm font-medium text-gray-600">ğŸ¥¬ Ingredient Categories</h4>
          <button onClick={()=>setAddingCat('ingredient')} className="text-xs text-blue-600 font-medium">+ Add New</button>
        </div>
        <div className="flex flex-wrap gap-2 mb-4">
          {ingCategories.sort().map(cat=>
            <button key={cat} onClick={()=>setShowIconPicker({type:'ingredient',category:cat})} className="flex items-center gap-1 px-3 py-1.5 bg-gray-100 rounded-full hover:bg-gray-200 transition">
              <span className="text-lg">{getIngIcon(cat)}</span>
              <span className="text-xs text-gray-600">{cat}</span>
              {categoryIcons[cat]&&<span className="text-xs text-green-500">âœ“</span>}
            </button>
          )}
        </div>
        
        <div className="flex justify-between items-center mb-2">
          <h4 className="text-sm font-medium text-gray-600">ğŸ’° Expense Categories</h4>
          <button onClick={()=>setAddingCat('expense')} className="text-xs text-blue-600 font-medium">+ Add New</button>
        </div>
        <div className="flex flex-wrap gap-2">
          {expCategories.sort().map(cat=>
            <button key={cat} onClick={()=>setShowIconPicker({type:'expense',category:cat})} className="flex items-center gap-1 px-3 py-1.5 bg-amber-50 rounded-full hover:bg-amber-100 transition">
              <span className="text-lg">{getExpIcon(cat)}</span>
              <span className="text-xs text-gray-600">{cat}</span>
              {expenseIcons[cat]&&<span className="text-xs text-green-500">âœ“</span>}
            </button>
          )}
        </div>
        
        <p className="text-xs text-gray-400 mt-3">âœ“ = custom icon. Changes apply after Save.</p>
      </div>

      {/* Add New Category Modal */}
      {addingCat&&<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={()=>setAddingCat(null)}>
        <div className="bg-white rounded-2xl p-4 max-w-sm w-full fade" onClick={e=>e.stopPropagation()}>
          <div className="flex justify-between items-center mb-4">
            <h3 className="font-bold">â• New {addingCat==='ingredient'?'Ingredient':'Expense'} Category</h3>
            <button onClick={()=>setAddingCat(null)} className="text-2xl text-gray-400">âœ•</button>
          </div>
          
          <div className="mb-4">
            <label className="lbl">Category Name</label>
            <input value={newCatName} onChange={e=>setNewCatName(e.target.value)} onKeyDown={e=>e.key==='Enter'&&addNewCategory()} className="inp" placeholder="e.g. Noodles, Fuel, etc." autoFocus/>
          </div>
          
          <div className="flex gap-3">
            <button onClick={()=>setAddingCat(null)} className="flex-1 btn btn-s">Cancel</button>
            <button onClick={addNewCategory} className="flex-1 btn btn-p">Add & Pick Icon</button>
          </div>
        </div>
      </div>}

      {/* Icon Picker Modal */}
      {showIconPicker&&<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={()=>setShowIconPicker(null)}>
        <div className="bg-white rounded-2xl p-4 max-w-sm w-full max-h-[80vh] overflow-y-auto fade" onClick={e=>e.stopPropagation()}>
          <div className="flex justify-between items-center mb-4">
            <h3 className="font-bold">Pick icon for: <span className="text-red-600">{showIconPicker.category}</span></h3>
            <button onClick={()=>setShowIconPicker(null)} className="text-2xl text-gray-400">âœ•</button>
          </div>
          
          <div className="grid grid-cols-8 gap-2">
            {emojiPalette.map((emoji,i)=>
              <button key={i} onClick={()=>setIcon(showIconPicker.type,showIconPicker.category,emoji)} className="text-2xl p-2 rounded-lg hover:bg-gray-100 transition">{emoji}</button>
            )}
          </div>
          
          <div className="mt-4 pt-4 border-t">
            <p className="text-xs text-gray-500 mb-2">Or type/paste custom emoji:</p>
            <div className="flex gap-2">
              <input type="text" maxLength="2" className="inp text-center text-2xl flex-1" placeholder="ğŸ¯" onKeyDown={e=>{if(e.key==='Enter'&&e.target.value)setIcon(showIconPicker.type,showIconPicker.category,e.target.value)}}/>
              <button onClick={e=>{const inp=e.target.parentElement.querySelector('input');if(inp.value)setIcon(showIconPicker.type,showIconPicker.category,inp.value)}} className="btn btn-p">Set</button>
            </div>
          </div>
        </div>
      </div>}

      <div className="card p-4 border-2 border-red-200">
        <h3 className="font-semibold text-red-600 mb-3">âš ï¸ Danger Zone</h3>
        <button onClick={clearData} className="btn w-full border-2 border-red-300 text-red-600 bg-red-50">Disconnect & Clear Local Data</button>
        <p className="text-xs text-gray-400 mt-2">This only clears browser data. Google Sheet is safe.</p>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
