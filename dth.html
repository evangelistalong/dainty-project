<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Dainty - Branch</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    *{-webkit-tap-highlight-color:transparent;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;margin:0;background:#f5f5f5}
    input,select,button,textarea{font-size:16px!important}
    .spin{animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .fade{animation:fade .2s ease-in}
    @keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .card{background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,.08);overflow:hidden}
    .btn{border:none;border-radius:10px;padding:12px 20px;font-weight:600;cursor:pointer;transition:all .2s}
    .btn-p{background:linear-gradient(135deg,#dc2626,#b91c1c);color:#fff}
    .btn-s{background:#f3f4f6;color:#374151}
    .btn-sm{padding:8px 12px;font-size:13px}
    .inp{width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:12px;background:#fff}
    .inp:focus{outline:none;border-color:#b91c1c;box-shadow:0 0 0 3px rgba(185,28,28,.1)}
    .lbl{font-size:12px;color:#6b7280;font-weight:500;display:block;margin-bottom:4px}
    .slide-up{animation:slideUp .3s ease-out}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .btn-amber{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff}
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë  BRANCH CONFIGURATION - CHANGE THESE FOR EACH BRANCH       ‚ïë
// ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
// ‚ïë  Copy this file and change only these 2 lines:             ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

const BRANCH_CODE = 'DTH';
const BRANCH_NAME = 'Dainty Tea House';

// Optional: Hardcode API URL (leave empty to prompt user)
const API_URL = 'https://script.google.com/macros/s/AKfycbxqSdXxqCna9TvELBaN-SBR-4xTIFU8duQF3KYBq14UTjJBF_ORGUWYZZy86pH-59Iv0Q/exec';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DO NOT EDIT BELOW THIS LINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const{useState,useEffect,useCallback}=React;

async function api(url,action,params={}){
  if(!url)throw new Error('API URL not set');
  const u=new URL(url);
  u.searchParams.set('action',action);
  Object.entries(params).forEach(([k,v])=>{if(v!=null)u.searchParams.set(k,typeof v==='object'?JSON.stringify(v):v)});
  const r=await fetch(u.toString());
  const d=await r.json();
  if(d.error)throw new Error(d.error);
  return d;
}

const fmt=n=>'‚Ç±'+(parseFloat(n)||0).toLocaleString('en-PH',{minimumFractionDigits:2,maximumFractionDigits:2});
const fmtDate=d=>{
  if(!d)return'-';
  let date;
  if(typeof d==='string'&&d.includes('T')){
    date=new Date(d);
  }else if(typeof d==='string'&&d.match(/^\d{4}-\d{2}-\d{2}$/)){
    date=new Date(d+'T00:00:00');
  }else{
    date=new Date(d);
  }
  if(isNaN(date.getTime()))return'-';
  return date.toLocaleDateString('en-PH',{month:'short',day:'numeric',year:'numeric'});
};

function App(){
  const[apiUrl,setApiUrl]=useState(API_URL||localStorage.getItem('dainty_api')||'');
  const[password,setPassword]=useState('');
  const[authenticated,setAuthenticated]=useState(false);
  const[ready,setReady]=useState(false);
  const[tab,setTab]=useState('dashboard');
  const[loading,setLoading]=useState(false);
  const[toast,setToast]=useState(null);
  const[settings,setSettings]=useState({});
  const[ingredients,setIngredients]=useState([]);
  const[ingCats,setIngCats]=useState([]);
  const[purchases,setPurchases]=useState([]);
  const[expenses,setExpenses]=useState([]);
  const[loginError,setLoginError]=useState('');
  const[viewDays,setViewDays]=useState(0); // 0 = today only
  
  // UI Mode: 'form' (original) or 'shop' (shopping cart style)
  const[uiMode,setUiMode]=useState(localStorage.getItem('dainty_ui_mode')||'shop');
  
  // Shopping cart states
  const[cart,setCart]=useState([]);
  const[expenseCart,setExpenseCart]=useState([]);
  const[showCart,setShowCart]=useState(false);
  const[showExpenseCart,setShowExpenseCart]=useState(false);
  
  // AI Scanner states
  const[showScanner,setShowScanner]=useState(false);
  const[scanning,setScanning]=useState(false);
  const[scanResult,setScanResult]=useState(null);
  const[scanPhoto,setScanPhoto]=useState(null);

  const showToast=(msg,type='success')=>{setToast({msg,type});setTimeout(()=>setToast(null),3000)};

  const toggleUiMode=()=>{
    const newMode=uiMode==='form'?'shop':'form';
    setUiMode(newMode);
    localStorage.setItem('dainty_ui_mode',newMode);
    showToast(newMode==='shop'?'üõí Shopping Mode':'üìù Form Mode');
  };

  const cartTotal=cart.reduce((s,c)=>s+(parseFloat(c.extTotal)||0),0);
  const cartCount=cart.length;
  const expenseTotal=expenseCart.reduce((s,c)=>s+(parseFloat(c.Amount)||0),0);
  const expenseCount=expenseCart.length;

  // AI Scanner functions
  const handleScanPhoto=async(e)=>{
    const file=e.target.files?.[0];
    if(!file)return;
    
    const reader=new FileReader();
    reader.onload=async(ev)=>{
      const base64=ev.target.result;
      setScanPhoto(base64);
      setScanning(true);
      setScanResult(null);
      
      try{
        const r=await api(apiUrl,'scanInvoice',{
          image:base64,
          ingredients:JSON.stringify(ingredients)
        });
        
        if(r.error){
          showToast(r.error,'error');
          setScanResult(null);
        }else if(r.data){
          // Enhance items with ingredient data
          const enhanced=r.data.items?.map(item=>({
            ...item,
            selectedSKU:item.matchedSKU||'',
            selectedName:item.matchedIngredient||item.itemName||'',
            confirmed:item.confidence>=0.9
          }))||[];
          setScanResult({...r.data,items:enhanced});
        }
      }catch(err){
        showToast('Scan failed: '+err.message,'error');
      }finally{
        setScanning(false);
      }
    };
    reader.readAsDataURL(file);
  };
  
  const updateScanItem=(idx,field,value)=>{
    setScanResult(prev=>{
      const items=[...prev.items];
      items[idx]={...items[idx],[field]:value};
      
      // If selecting ingredient, update related fields
      if(field==='selectedSKU'&&value){
        const ing=ingredients.find(i=>String(i.MasterSKU)===String(value));
        if(ing){
          items[idx].selectedName=ing.Name;
          items[idx].matchedIngredient=ing.Name;
          items[idx].unit=items[idx].unit||ing.Unit;
        }
      }
      return{...prev,items};
    });
  };
  
  const addScannedToCart=async()=>{
    if(!scanResult?.items?.length)return;
    
    const validItems=scanResult.items.filter(item=>item.selectedSKU&&item.qty&&item.price);
    if(validItems.length===0){
      showToast('No valid items to add','error');
      return;
    }
    
    // Save aliases for unmatched items
    for(const item of validItems){
      if(item.rawText&&item.selectedSKU&&!item.aliasMatch){
        try{
          await api(apiUrl,'saveItemAlias',{
            alias:item.rawText,
            masterSKU:item.selectedSKU,
            ingredientName:item.selectedName
          });
        }catch(e){console.log('Alias save failed',e)}
      }
    }
    
    // Add to cart
    const newItems=validItems.map(item=>{
      const ing=ingredients.find(i=>String(i.MasterSKU)===String(item.selectedSKU))||{};
      return{
        MasterSKU:item.selectedSKU,
        ItemName:item.selectedName||item.itemName,
        Qty:parseFloat(item.qty)||1,
        ContainerType:ing.ContainerType||'',
        ContainerSize:ing.ContainerSize||item.qty,
        ContainerUnit:ing.ContainerUnit||item.unit||'kg',
        Price:parseFloat(item.unitPrice||item.price)||0,
        extTotal:parseFloat(item.price)||0,
        Unit:ing.Unit||'g',
        Category:ing.Category||'Other'
      };
    });
    
    setCart(prev=>[...prev,...newItems]);
    showToast(`Added ${newItems.length} items to cart!`);
    setShowScanner(false);
    setScanResult(null);
    setScanPhoto(null);
  };

  // Device identification
  const getDeviceID=()=>{
    let id=localStorage.getItem('dainty_device_id');
    if(!id){
      id='DEV_'+Math.random().toString(36).substr(2,9)+'_'+Date.now().toString(36);
      localStorage.setItem('dainty_device_id',id);
    }
    return id;
  };
  
  const getDeviceInfo=()=>{
    const ua=navigator.userAgent;
    let browser='Unknown';
    let device='Desktop';
    
    if(ua.includes('Chrome'))browser='Chrome';
    else if(ua.includes('Firefox'))browser='Firefox';
    else if(ua.includes('Safari'))browser='Safari';
    else if(ua.includes('Edge'))browser='Edge';
    
    if(/Mobile|Android|iPhone|iPad/.test(ua))device='Mobile';
    if(/iPad|Tablet/.test(ua))device='Tablet';
    
    const screenSize=window.screen.width+'x'+window.screen.height;
    return{
      browser:browser,
      deviceName:device+' ('+screenSize+')',
      deviceID:getDeviceID()
    };
  };

  const checkSavedAuth=useCallback(async()=>{
    const savedUrl=API_URL||localStorage.getItem('dainty_api');
    const savedAuth=localStorage.getItem('dainty_auth_'+BRANCH_CODE);
    const savedSession=localStorage.getItem('dainty_session_'+BRANCH_CODE);
    const deviceID=getDeviceID();
    
    if(savedUrl&&savedAuth){
      try{
        // First validate existing session if we have one
        if(savedSession){
          const sv=await api(savedUrl,'validateSession',{branchCode:BRANCH_CODE,sessionID:savedSession,deviceID:deviceID});
          if(sv.valid){
            setApiUrl(savedUrl);
            setAuthenticated(true);
            setReady(true);
            return true;
          }else{
            // Session invalid - clear and show message
            localStorage.removeItem('dainty_session_'+BRANCH_CODE);
            localStorage.removeItem('dainty_auth_'+BRANCH_CODE);
            if(sv.reason)setLoginError(sv.reason);
            return false;
          }
        }
        
        // No session - try to login with saved password
        const r=await api(savedUrl,'verifyBranchPassword',{branchCode:BRANCH_CODE,password:savedAuth});
        if(r.success){
          // Register new session
          const devInfo=getDeviceInfo();
          const sess=await api(savedUrl,'registerSession',{
            branchCode:BRANCH_CODE,
            deviceID:devInfo.deviceID,
            deviceName:devInfo.deviceName,
            browser:devInfo.browser,
            passwordVersion:r.passwordVersion||1
          });
          if(sess.sessionID)localStorage.setItem('dainty_session_'+BRANCH_CODE,sess.sessionID);
          
          setApiUrl(savedUrl);
          setAuthenticated(true);
          setReady(true);
          return true;
        }
      }catch(e){console.error(e)}
    }
    return false;
  },[]);

  useEffect(()=>{checkSavedAuth()},[checkSavedAuth]);
  
  // Periodic session validation (every 5 minutes)
  useEffect(()=>{
    if(!authenticated||!apiUrl)return;
    const interval=setInterval(async()=>{
      const savedSession=localStorage.getItem('dainty_session_'+BRANCH_CODE);
      if(savedSession){
        try{
          const sv=await api(apiUrl,'validateSession',{branchCode:BRANCH_CODE,sessionID:savedSession,deviceID:getDeviceID()});
          if(!sv.valid){
            showToast(sv.reason||'Session expired','error');
            logout();
          }
        }catch(e){console.error(e)}
      }
    },5*60*1000); // 5 minutes
    return()=>clearInterval(interval);
  },[authenticated,apiUrl]);

  const login=async()=>{
    if(!apiUrl){setLoginError('Enter database URL');return}
    if(!password){setLoginError('Enter password');return}
    setLoading(true);
    setLoginError('');
    try{
      const r=await api(apiUrl,'verifyBranchPassword',{branchCode:BRANCH_CODE,password});
      if(r.success){
        // Register session with device info
        const devInfo=getDeviceInfo();
        const sess=await api(apiUrl,'registerSession',{
          branchCode:BRANCH_CODE,
          deviceID:devInfo.deviceID,
          deviceName:devInfo.deviceName,
          browser:devInfo.browser,
          passwordVersion:r.passwordVersion||1
        });
        
        localStorage.setItem('dainty_api',apiUrl);
        localStorage.setItem('dainty_auth_'+BRANCH_CODE,password);
        if(sess.sessionID)localStorage.setItem('dainty_session_'+BRANCH_CODE,sess.sessionID);
        
        setAuthenticated(true);
        setReady(true);
      }else{
        setLoginError(r.error||'Login failed');
      }
    }catch(e){setLoginError(e.message)}
    finally{setLoading(false)}
  };

  const logout=()=>{
    // Clear session on server
    const savedSession=localStorage.getItem('dainty_session_'+BRANCH_CODE);
    if(savedSession&&apiUrl){
      api(apiUrl,'logoutSession',{sessionID:savedSession}).catch(()=>{});
    }
    localStorage.removeItem('dainty_auth_'+BRANCH_CODE);
    localStorage.removeItem('dainty_session_'+BRANCH_CODE);
    setAuthenticated(false);
    setReady(false);
    setPassword('');
  };

  const loadAll=useCallback(async()=>{
    if(!apiUrl)return;
    setLoading(true);
    try{
      const[s,i,ic]=await Promise.all([
        api(apiUrl,'getSettings'),
        api(apiUrl,'getIngredients'),
        api(apiUrl,'getIngredientCategories')
      ]);
      setSettings(s.settings||{});
      setIngredients(i.ingredients||[]);
      setIngCats(ic.categories||[]);
    }catch(e){showToast(e.message,'error')}
    finally{setLoading(false)}
  },[apiUrl]);

  const loadTx=useCallback(async(days=0)=>{
    if(!apiUrl)return;
    try{
      const[p,e]=await Promise.all([
        api(apiUrl,'getPurchases',{branch:BRANCH_NAME,days:days||30}),
        api(apiUrl,'getExpenses',{branch:BRANCH_NAME,days:days||30})
      ]);
      const today=new Date();
      today.setHours(0,0,0,0);
      const cutoff=new Date(today);
      cutoff.setDate(cutoff.getDate()-days);
      
      const parseDate=(d)=>{
        if(!d)return null;
        let date;
        if(typeof d==='string'&&d.includes('T')){
          date=new Date(d);
        }else if(typeof d==='string'&&d.match(/^\d{4}-\d{2}-\d{2}$/)){
          date=new Date(d+'T00:00:00');
        }else{
          date=new Date(d);
        }
        if(isNaN(date.getTime()))return null;
        date.setHours(0,0,0,0);
        return date;
      };
      
      const isInRange=(dateStr,days)=>{
        const d=parseDate(dateStr);
        if(!d)return false;
        if(days===0)return d.getTime()===today.getTime();
        return d>=cutoff;
      };
      
      setPurchases((p.purchases||[]).filter(x=>isInRange(x.PurchaseDate,days)));
      setExpenses((e.expenses||[]).filter(x=>isInRange(x.Date,days)));
    }catch(e){console.error(e)}
  },[apiUrl]);

  useEffect(()=>{if(ready)loadAll()},[ready,loadAll]);
  useEffect(()=>{if(ready)loadTx(viewDays)},[ready,loadTx,viewDays]);

  // Login Screen
  if(!ready||!authenticated)return(
    <div className="min-h-screen flex items-center justify-center p-4" style={{background:'linear-gradient(135deg,#b91c1c,#7f1d1d)'}}>
      <div className="card p-8 max-w-md w-full fade">
        <div className="text-center mb-6">
          <div className="text-6xl mb-4">üçú</div>
          <h1 className="text-2xl font-bold text-gray-800">{BRANCH_NAME}</h1>
          <p className="text-gray-500 text-sm mt-1">{BRANCH_CODE}</p>
        </div>
        
        {!API_URL&&<div className="mb-4">
          <label className="lbl">Database URL</label>
          <input value={apiUrl} onChange={e=>setApiUrl(e.target.value)} placeholder="Paste URL from admin" className="inp"/>
        </div>}
        
        <div className="mb-4">
          <label className="lbl">Branch Password</label>
          <input type="password" value={password} onChange={e=>setPassword(e.target.value)} onKeyDown={e=>e.key==='Enter'&&login()} placeholder="Enter password" className="inp"/>
        </div>
        
        {loginError&&<p className="text-red-600 text-sm mb-4 text-center">{loginError}</p>}
        
        <button onClick={login} disabled={loading} className="btn btn-p w-full">
          {loading?<span className="flex items-center justify-center gap-2"><span className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full spin"/>Checking...</span>:'üîê Login'}
        </button>
        
        <p className="text-xs text-gray-400 text-center mt-4">Ask admin for password</p>
      </div>
    </div>
  );

  const parseDate=(d)=>{
    if(!d)return null;
    let date;
    if(typeof d==='string'&&d.includes('T')){
      date=new Date(d);
    }else if(typeof d==='string'&&d.match(/^\d{4}-\d{2}-\d{2}$/)){
      date=new Date(d+'T00:00:00');
    }else{
      date=new Date(d);
    }
    if(isNaN(date.getTime()))return null;
    date.setHours(0,0,0,0);
    return date;
  };
  
  const todayDate=new Date();
  todayDate.setHours(0,0,0,0);
  const isToday=(dateStr)=>{const d=parseDate(dateStr);return d&&d.getTime()===todayDate.getTime()};
  
  const todayPurchases=purchases.filter(p=>isToday(p.PurchaseDate));
  const todayExpenses=expenses.filter(e=>isToday(e.Date));
  const todayPTotal=todayPurchases.reduce((s,p)=>s+(parseFloat(p.Price)||0),0);
  const todayETotal=todayExpenses.reduce((s,e)=>s+(parseFloat(e.Amount)||0),0);

  return(
    <div className="min-h-screen bg-gray-100 pb-24">
      {toast&&<div className="fixed top-4 left-1/2 -translate-x-1/2 z-50 px-6 py-3 rounded-xl shadow-lg text-white font-medium fade" style={{background:toast.type==='success'?'#10b981':'#ef4444'}}>{toast.msg}</div>}
      
      <header className="sticky top-0 z-40 p-4 text-white" style={{background:'linear-gradient(135deg,#dc2626,#991b1b)'}}>
        <div className="flex justify-between items-center">
          <div className="flex items-center gap-3">
            <span className="text-3xl">üçú</span>
            <div>
              <h1 className="text-lg font-bold leading-tight">{BRANCH_NAME}</h1>
              <p className="text-xs opacity-75">{BRANCH_CODE} ‚Ä¢ {new Date().toLocaleDateString('en-PH',{weekday:'short',month:'short',day:'numeric'})}</p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            {/* Mode Toggle */}
            <button onClick={toggleUiMode} className="px-3 py-1.5 rounded-lg bg-white/20 text-sm font-medium hover:bg-white/30 flex items-center gap-1" title={uiMode==='form'?'Switch to Shopping Mode':'Switch to Form Mode'}>
              {uiMode==='shop'?'üõí':'üìù'}<span className="text-xs">{uiMode==='shop'?'Shop':'Form'}</span>
            </button>
            
            {/* AI Scan Button (shopping mode purchases) */}
            {uiMode==='shop'&&tab==='purchases'&&(
              <button onClick={()=>setShowScanner(true)} className="px-3 py-1.5 rounded-lg bg-green-500/80 text-sm font-medium hover:bg-green-500 flex items-center gap-1" title="AI Invoice Scanner">
                <span>üì∑</span><span className="text-xs">Scan</span>
              </button>
            )}
            
            {/* Cart Button (shopping mode) */}
            {uiMode==='shop'&&tab==='purchases'&&(
              <button onClick={()=>setShowCart(true)} className="relative px-3 py-1 rounded-lg bg-white/20 flex items-center gap-1 hover:bg-white/30">
                <span>üõí</span>
                <span className="text-sm font-bold">‚Ç±{cartTotal.toLocaleString()}</span>
                {cartCount>0&&<span className="absolute -top-1 -right-1 bg-yellow-400 text-black text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold">{cartCount}</span>}
              </button>
            )}
            {uiMode==='shop'&&tab==='expenses'&&(
              <button onClick={()=>setShowExpenseCart(true)} className="relative px-3 py-1 rounded-lg bg-white/20 flex items-center gap-1 hover:bg-white/30">
                <span>üßæ</span>
                <span className="text-sm font-bold">‚Ç±{expenseTotal.toLocaleString()}</span>
                {expenseCount>0&&<span className="absolute -top-1 -right-1 bg-yellow-400 text-black text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold">{expenseCount}</span>}
              </button>
            )}
            
            {loading&&<div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full spin"/>}
            <button onClick={()=>{loadAll();loadTx(viewDays)}} className="p-2 rounded-lg hover:bg-white/20 text-xl">üîÑ</button>
            <button onClick={logout} className="p-2 rounded-lg hover:bg-white/20 text-sm">üö™</button>
          </div>
        </div>
      </header>

      <main className="p-4 pb-24">
        {uiMode==='form'?(
          <>
            {tab==='dashboard'&&<BranchDashboard purchases={purchases} expenses={expenses} ingredients={ingredients} todayPurchases={todayPurchases} todayExpenses={todayExpenses} todayPTotal={todayPTotal} todayETotal={todayETotal} setTab={setTab}/>}
            {tab==='purchases'&&<Purchases apiUrl={apiUrl} settings={settings} purchases={purchases} showToast={showToast} loadTx={()=>loadTx(viewDays)} ingredients={ingredients} viewDays={viewDays} setViewDays={setViewDays}/>}
            {tab==='expenses'&&<Expenses apiUrl={apiUrl} settings={settings} expenses={expenses} showToast={showToast} loadTx={()=>loadTx(viewDays)} viewDays={viewDays} setViewDays={setViewDays}/>}
            {tab==='ingredients'&&<Ingredients apiUrl={apiUrl} ingredients={ingredients} ingCats={ingCats} settings={settings} showToast={showToast} loadAll={loadAll}/>}
          </>
        ):(
          <>
            {tab==='dashboard'&&<BranchDashboard purchases={purchases} expenses={expenses} ingredients={ingredients} todayPurchases={todayPurchases} todayExpenses={todayExpenses} todayPTotal={todayPTotal} todayETotal={todayETotal} setTab={setTab}/>}
            {tab==='purchases'&&<ShopView ingredients={ingredients} settings={settings} purchases={purchases} cart={cart} setCart={setCart} showToast={showToast} apiUrl={apiUrl} loadAll={loadAll}/>}
            {tab==='expenses'&&<ExpenseShop settings={settings} expenseCart={expenseCart} setExpenseCart={setExpenseCart} showToast={showToast}/>}
            {tab==='ingredients'&&<Ingredients apiUrl={apiUrl} ingredients={ingredients} ingCats={ingCats} settings={settings} showToast={showToast} loadAll={loadAll}/>}
          </>
        )}
      </main>

      {/* Cart Modals (shopping mode) */}
      {showCart&&<PurchaseCartModal cart={cart} setCart={setCart} cartTotal={cartTotal} onClose={()=>setShowCart(false)} settings={settings} apiUrl={apiUrl} showToast={showToast} loadAll={()=>{loadAll();loadTx(viewDays)}}/>}
      {showExpenseCart&&<ExpenseCartModal cart={expenseCart} setCart={setExpenseCart} cartTotal={expenseTotal} onClose={()=>setShowExpenseCart(false)} settings={settings} apiUrl={apiUrl} showToast={showToast} loadAll={()=>{loadAll();loadTx(viewDays)}}/>}
      
      {/* AI Invoice Scanner Modal */}
      {showScanner&&<div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-2" onClick={()=>{setShowScanner(false);setScanResult(null);setScanPhoto(null)}}>
        <div className="bg-white w-full max-w-lg rounded-2xl max-h-[95vh] overflow-hidden flex flex-col" onClick={e=>e.stopPropagation()}>
          <div className="p-4 border-b bg-gradient-to-r from-green-600 to-emerald-600 text-white">
            <div className="flex justify-between items-center">
              <h3 className="font-bold text-lg">üì∑ AI Invoice Scanner</h3>
              <button onClick={()=>{setShowScanner(false);setScanResult(null);setScanPhoto(null)}} className="text-2xl">‚úï</button>
            </div>
            <p className="text-xs opacity-80 mt-1">Take a photo of receipt/invoice to auto-extract items</p>
          </div>
          
          <div className="flex-1 overflow-y-auto p-4">
            {!scanPhoto&&!scanning&&!scanResult&&(
              <label className="block border-2 border-dashed border-green-300 rounded-2xl p-8 text-center cursor-pointer hover:border-green-500 hover:bg-green-50 transition">
                <input type="file" accept="image/*" capture="environment" onChange={handleScanPhoto} className="hidden"/>
                <span className="text-6xl block mb-4">üì∏</span>
                <p className="text-lg font-medium text-gray-700">Tap to capture invoice</p>
                <p className="text-sm text-gray-500 mt-2">Works with printed & handwritten receipts</p>
              </label>
            )}
            
            {scanning&&(
              <div className="text-center py-12">
                <div className="w-16 h-16 border-4 border-green-200 border-t-green-600 rounded-full spin mx-auto mb-4"/>
                <p className="text-lg font-medium text-gray-700">ü§ñ AI is reading your invoice...</p>
                <p className="text-sm text-gray-500 mt-2">This may take a few seconds</p>
                {scanPhoto&&<img src={scanPhoto} alt="Scanning..." className="w-32 h-32 object-cover rounded-xl mx-auto mt-4 opacity-50"/>}
              </div>
            )}
            
            {scanResult&&(
              <div className="space-y-4">
                {/* Scan Preview */}
                <div className="flex gap-3">
                  {scanPhoto&&<img src={scanPhoto} alt="Invoice" className="w-20 h-20 object-cover rounded-xl"/>}
                  <div className="flex-1">
                    {scanResult.supplier&&<p className="font-medium text-gray-800">üè™ {scanResult.supplier}</p>}
                    {scanResult.date&&<p className="text-sm text-gray-500">üìÖ {scanResult.date}</p>}
                    <p className="text-sm text-green-600 font-medium">{scanResult.items?.length||0} items found</p>
                    {scanResult.notes&&<p className="text-xs text-amber-600 mt-1">‚ö†Ô∏è {scanResult.notes}</p>}
                  </div>
                  <button onClick={()=>{setScanResult(null);setScanPhoto(null)}} className="text-sm text-blue-600">‚Ü∫ Rescan</button>
                </div>
                
                {/* Items List */}
                <div className="space-y-3">
                  {scanResult.items?.map((item,idx)=>(
                    <div key={idx} className={`p-3 rounded-xl border-2 ${item.selectedSKU?'border-green-200 bg-green-50':'border-amber-200 bg-amber-50'}`}>
                      <div className="flex justify-between items-start mb-2">
                        <div>
                          <p className="text-xs text-gray-500">Read: "{item.rawText}"</p>
                          <p className="font-medium">{item.itemName||item.rawText}</p>
                        </div>
                        <span className={`text-xs px-2 py-1 rounded-full ${item.confidence>=0.9?'bg-green-200 text-green-800':item.confidence>=0.7?'bg-yellow-200 text-yellow-800':'bg-red-200 text-red-800'}`}>
                          {Math.round((item.confidence||0)*100)}%
                        </span>
                      </div>
                      
                      <div className="grid grid-cols-3 gap-2 mb-2">
                        <div>
                          <label className="text-xs text-gray-500">Qty</label>
                          <input type="number" value={item.qty||''} onChange={e=>updateScanItem(idx,'qty',e.target.value)} className="inp text-sm text-center" placeholder="0"/>
                        </div>
                        <div>
                          <label className="text-xs text-gray-500">Unit</label>
                          <input value={item.unit||''} onChange={e=>updateScanItem(idx,'unit',e.target.value)} className="inp text-sm text-center" placeholder="kg"/>
                        </div>
                        <div>
                          <label className="text-xs text-gray-500">Total ‚Ç±</label>
                          <input type="number" value={item.price||''} onChange={e=>updateScanItem(idx,'price',e.target.value)} className="inp text-sm text-center" placeholder="0"/>
                        </div>
                      </div>
                      
                      <div>
                        <label className="text-xs text-gray-500">Match to Ingredient {item.aliasMatch&&<span className="text-green-600">(remembered)</span>}</label>
                        <select value={item.selectedSKU||''} onChange={e=>{
                          const ing=ingredients.find(i=>String(i.MasterSKU)===e.target.value);
                          updateScanItem(idx,'selectedSKU',e.target.value);
                          if(ing)updateScanItem(idx,'selectedName',ing.Name);
                        }} className={`inp text-sm ${item.selectedSKU?'border-green-400':'border-amber-400'}`}>
                          <option value="">-- Select Ingredient --</option>
                          {ingredients.sort((a,b)=>a.Name.localeCompare(b.Name)).map(ing=>(
                            <option key={ing.MasterSKU} value={ing.MasterSKU}>{ing.Name} ({ing.Unit})</option>
                          ))}
                        </select>
                      </div>
                    </div>
                  ))}
                </div>
                
                {/* Total */}
                {scanResult.total&&(
                  <div className="p-3 bg-gray-100 rounded-xl text-center">
                    <p className="text-sm text-gray-500">Invoice Total</p>
                    <p className="text-2xl font-bold text-gray-800">‚Ç±{parseFloat(scanResult.total).toLocaleString()}</p>
                  </div>
                )}
              </div>
            )}
          </div>
          
          {/* Footer Actions */}
          {scanResult&&(
            <div className="p-4 border-t bg-gray-50">
              <div className="flex gap-3">
                <button onClick={()=>{setScanResult(null);setScanPhoto(null)}} className="flex-1 btn btn-s">Cancel</button>
                <button onClick={addScannedToCart} className="flex-1 btn btn-p">
                  üõí Add {scanResult.items?.filter(i=>i.selectedSKU&&i.qty&&i.price).length||0} Items to Cart
                </button>
              </div>
            </div>
          )}
        </div>
      </div>}

      <nav className="fixed bottom-0 left-0 right-0 bg-white border-t flex z-40">
        {[
          {id:'dashboard',icon:'üìä',label:'Dashboard'},
          {id:'purchases',icon:'üõí',label:'Purchases'},
          {id:'expenses',icon:'üí∞',label:'Expenses'},
          {id:'ingredients',icon:'ü•¨',label:'Ingredients'}
        ].map(t=>
          <button key={t.id} onClick={()=>setTab(t.id)} className={`flex-1 py-3 text-center ${tab===t.id?'text-red-600 bg-red-50':'text-gray-500'}`}>
            <span className="text-xl block">{t.icon}</span>
            <span className="text-xs font-medium">{t.label}</span>
          </button>
        )}
      </nav>
    </div>
  );
}


// Branch Dashboard Component
function BranchDashboard({purchases,expenses,ingredients,todayPurchases,todayExpenses,todayPTotal,todayETotal,setTab}){
  const parseDate=(d)=>{
    if(!d)return null;
    let date;
    if(typeof d==='string'&&d.includes('T')){
      date=new Date(d);
    }else if(typeof d==='string'&&d.match(/^\d{4}-\d{2}-\d{2}$/)){
      date=new Date(d+'T00:00:00');
    }else{
      date=new Date(d);
    }
    if(isNaN(date.getTime()))return null;
    date.setHours(0,0,0,0);
    return date;
  };
  
  const weekCutoff=new Date();
  weekCutoff.setDate(weekCutoff.getDate()-7);
  weekCutoff.setHours(0,0,0,0);
  
  const isInWeek=(dateStr)=>{const d=parseDate(dateStr);return d&&d>=weekCutoff};
  
  const weekPurchases=purchases.filter(p=>isInWeek(p.PurchaseDate));
  const weekExpenses=expenses.filter(e=>isInWeek(e.Date));
  const weekPTotal=weekPurchases.reduce((s,p)=>s+(parseFloat(p.Price)||0),0);
  const weekETotal=weekExpenses.reduce((s,e)=>s+(parseFloat(e.Amount)||0),0);
  
  // Recent activity (last 10 items combined) with more details
  const recentItems=[
    ...todayPurchases.slice(0,10).map(p=>({type:'purchase',name:p.ItemName,amount:p.Price,time:p.Timestamp,supplier:p.Supplier,po:p.PO,photo:p.InvoicePhoto,qty:p.Qty,unit:p.ContainerUnit||p.BaseUnit})),
    ...todayExpenses.slice(0,10).map(e=>({type:'expense',name:e.Description||e.Category,amount:e.Amount,time:e.Timestamp,payee:e.Vendor,category:e.Category,photo:e.ReceiptPhoto}))
  ].sort((a,b)=>new Date(b.time)-new Date(a.time)).slice(0,10);
  
  // Group purchases by supplier
  const purchasesBySupplier={};
  todayPurchases.forEach(p=>{
    const key=p.Supplier||'(No Supplier)';
    if(!purchasesBySupplier[key])purchasesBySupplier[key]={items:[],total:0,photo:p.InvoicePhoto};
    purchasesBySupplier[key].items.push(p);
    purchasesBySupplier[key].total+=parseFloat(p.Price)||0;
  });
  
  const[activityView,setActivityView]=useState('recent'); // 'recent' or 'grouped'
  const[viewPhoto,setViewPhoto]=useState(null);

  return(
    <div className="space-y-4 fade">
      {/* Photo Viewer Modal */}
      {viewPhoto&&<div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4" onClick={()=>setViewPhoto(null)}>
        <div className="max-w-lg w-full">
          <img src={viewPhoto} alt="Receipt/Invoice" className="w-full rounded-lg"/>
          <p className="text-center text-white mt-3 text-sm">Tap anywhere to close</p>
        </div>
      </div>}
      
      <h2 className="text-lg font-bold text-gray-800">üìä Dashboard</h2>
      
      {/* Today's Summary */}
      <div className="grid grid-cols-2 gap-3">
        <button onClick={()=>setTab('purchases')} className="card p-4 text-left hover:shadow-lg transition">
          <p className="text-gray-500 text-xs">Today's Purchases</p>
          <p className="text-2xl font-bold text-red-700">{fmt(todayPTotal)}</p>
          <p className="text-xs text-gray-400 mt-1">{todayPurchases.length} items</p>
        </button>
        <button onClick={()=>setTab('expenses')} className="card p-4 text-left hover:shadow-lg transition">
          <p className="text-gray-500 text-xs">Today's Expenses</p>
          <p className="text-2xl font-bold text-amber-600">{fmt(todayETotal)}</p>
          <p className="text-xs text-gray-400 mt-1">{todayExpenses.length} items</p>
        </button>
      </div>
      
      {/* Week Summary */}
      <div className="card p-4">
        <h3 className="font-semibold text-gray-700 mb-3">üìÖ This Week</h3>
        <div className="grid grid-cols-2 gap-4">
          <div>
            <p className="text-xs text-gray-500">Purchases</p>
            <p className="text-xl font-bold text-red-700">{fmt(weekPTotal)}</p>
            <p className="text-xs text-gray-400">{weekPurchases.length} items</p>
          </div>
          <div>
            <p className="text-xs text-gray-500">Expenses</p>
            <p className="text-xl font-bold text-amber-600">{fmt(weekETotal)}</p>
            <p className="text-xs text-gray-400">{weekExpenses.length} items</p>
          </div>
        </div>
      </div>
      
      {/* Quick Stats */}
      <div className="card p-4">
        <h3 className="font-semibold text-gray-700 mb-3">üìã Quick Stats</h3>
        <div className="grid grid-cols-3 gap-2 text-center">
          <div className="bg-gray-50 rounded-xl p-3">
            <p className="text-xl font-bold text-gray-800">{ingredients.length}</p>
            <p className="text-xs text-gray-500">Ingredients</p>
          </div>
          <div className="bg-gray-50 rounded-xl p-3">
            <p className="text-xl font-bold text-gray-800">{purchases.length}</p>
            <p className="text-xs text-gray-500">Purchases</p>
          </div>
          <div className="bg-gray-50 rounded-xl p-3">
            <p className="text-xl font-bold text-gray-800">{expenses.length}</p>
            <p className="text-xs text-gray-500">Expenses</p>
          </div>
        </div>
      </div>
      
      {/* Recent Activity - Enhanced */}
      <div className="card">
        <div className="p-3 border-b bg-gray-50 flex justify-between items-center">
          <span className="font-semibold text-gray-700">üïê Recent Activity</span>
          <div className="flex gap-1">
            <button onClick={()=>setActivityView('recent')} className={`px-2 py-1 rounded text-xs ${activityView==='recent'?'bg-red-600 text-white':'bg-gray-200'}`}>Timeline</button>
            <button onClick={()=>setActivityView('grouped')} className={`px-2 py-1 rounded text-xs ${activityView==='grouped'?'bg-red-600 text-white':'bg-gray-200'}`}>By Supplier</button>
          </div>
        </div>
        <div className="max-h-80 overflow-y-auto">
          {activityView==='recent'?(
            recentItems.length===0?<p className="p-6 text-center text-gray-400">No activity today</p>:
            recentItems.map((item,i)=>
              <div key={i} className="p-3 border-b flex items-center">
                <span className="text-xl mr-3">{item.type==='purchase'?'üõí':'üí∞'}</span>
                <div className="flex-1 min-w-0">
                  <p className="font-medium text-sm truncate">{item.name}</p>
                  <p className="text-xs text-gray-500">
                    {item.type==='purchase'?
                      <span>{item.supplier||'No supplier'} {item.qty&&<span>‚Ä¢ {item.qty} {item.unit}</span>}</span>:
                      <span>{item.category} {item.payee&&<span>‚Ä¢ {item.payee}</span>}</span>
                    }
                  </p>
                </div>
                {item.photo&&<button onClick={()=>setViewPhoto(item.photo)} className="text-blue-500 mr-2 text-lg">üì∑</button>}
                <span className={`font-bold ${item.type==='purchase'?'text-red-700':'text-amber-600'}`}>{fmt(item.amount)}</span>
              </div>
            )
          ):(
            Object.keys(purchasesBySupplier).length===0?<p className="p-6 text-center text-gray-400">No purchases today</p>:
            Object.entries(purchasesBySupplier).map(([supplier,data])=>
              <div key={supplier} className="border-b">
                <div className="p-3 bg-gray-50 flex justify-between items-center">
                  <div className="flex items-center gap-2">
                    <span className="font-medium">{supplier}</span>
                    <span className="text-xs bg-gray-200 px-2 py-0.5 rounded-full">{data.items.length} items</span>
                  </div>
                  <div className="flex items-center gap-2">
                    {data.photo&&<button onClick={()=>setViewPhoto(data.photo)} className="text-blue-500 text-lg">üì∑</button>}
                    <span className="font-bold text-red-700">{fmt(data.total)}</span>
                  </div>
                </div>
                <div className="pl-4">
                  {data.items.map((p,i)=>
                    <div key={i} className="p-2 border-b border-gray-100 flex justify-between text-sm">
                      <span className="text-gray-600">{p.ItemName} <span className="text-gray-400">({p.Qty} {p.ContainerUnit||p.BaseUnit})</span></span>
                      <span className="text-red-600">{fmt(p.Price)}</span>
                    </div>
                  )}
                </div>
              </div>
            )
          )}
        </div>
      </div>
    </div>
  );
}

function Purchases({apiUrl,settings,purchases,showToast,loadTx,ingredients,viewDays,setViewDays}){
  const[saving,setSaving]=useState(false);
  const[uploading,setUploading]=useState(false);
  const[priceWarning,setPriceWarning]=useState(null); // {item, unitPrice, avgPrice, variance, recentPrices}
  
  // Header info (shared by all items in this PO)
  const[header,setHeader]=useState({
    PurchaseDate:new Date().toISOString().split('T')[0],
    Supplier:'',
    PO:'',
    PayMethod:'Cash',
    InvoicePhoto:''
  });
  
  // Current item being entered
  const[item,setItem]=useState({ItemName:'',MasterSKU:'',BaseUnit:'g',Description:'',ContainerType:'',ContainerSize:'',ContainerUnit:'kg',Qty:'',Price:'',Notes:''});
  
  // Temporary posted items (not yet saved to server)
  const[postedItems,setPostedItems]=useState([]);
  
  const[search,setSearch]=useState('');
  const[showSearch,setShowSearch]=useState(false);
  const[photoPreview,setPhotoPreview]=useState(null);
  const[viewPhoto,setViewPhoto]=useState(null);

  // Select ingredient from search
  const selectIngredient=(ing)=>{
    setItem({
      ...item,
      ItemName:ing.Name,
      MasterSKU:ing.MasterSKU,
      BaseUnit:ing.Unit||'g',
      ContainerType:ing.ContainerType||'',
      ContainerSize:ing.ContainerSize||'',
      ContainerUnit:ing.ContainerUnit||ing.Unit||'kg'
    });
    setSearch('');
    setShowSearch(false);
  };

  // Photo handling
  const handlePhoto=async(e)=>{
    const file=e.target.files?.[0];
    if(!file)return;
    
    const reader=new FileReader();
    reader.onload=(ev)=>setPhotoPreview(ev.target.result);
    reader.readAsDataURL(file);
    
    setUploading(true);
    try{
      const base64=await new Promise((resolve)=>{
        const r=new FileReader();
        r.onload=(ev)=>resolve(ev.target.result);
        r.readAsDataURL(file);
      });
      
      const filename=BRANCH_CODE+'_'+header.PurchaseDate+'_'+Date.now()+'.jpg';
      const result=await api(apiUrl,'uploadInvoicePhoto',{base64,filename,branchCode:BRANCH_CODE});
      
      if(result.success){
        setHeader({...header,InvoicePhoto:result.viewUrl});
        showToast('Photo uploaded!');
      }else{
        showToast(result.error||'Upload failed','error');
      }
    }catch(err){
      showToast('Upload failed: '+err.message,'error');
    }finally{
      setUploading(false);
    }
  };

  // Calculate unit price (per base unit)
  const calcUnitPrice=(itm)=>{
    const price=parseFloat(itm.Price)||0;
    const qty=parseFloat(itm.Qty)||0;
    const containerSize=parseFloat(itm.ContainerSize)||0;
    if(price===0||qty===0)return 0;
    
    let totalBase=qty;
    const cu=(itm.ContainerUnit||'g').toLowerCase();
    const bu=(itm.BaseUnit||'g').toLowerCase();
    
    if(containerSize>0){
      let containerInBase=containerSize;
      if(cu==='kg'&&bu==='g')containerInBase=containerSize*1000;
      else if(cu==='l'&&bu==='ml')containerInBase=containerSize*1000;
      totalBase=qty*containerInBase;
    }else{
      if(cu==='kg'&&bu==='g')totalBase=qty*1000;
      else if(cu==='l'&&bu==='ml')totalBase=qty*1000;
    }
    
    return totalBase>0?(price/totalBase):0;
  };

  // Get price history for an ingredient
  const getPriceHistory=(sku)=>{
    const history=purchases.filter(p=>String(p.MasterSKU)===String(sku)&&parseFloat(p.UnitPrice)>0);
    if(history.length===0)return null;
    const prices=history.map(p=>parseFloat(p.UnitPrice));
    const sorted=history.sort((a,b)=>new Date(b.PurchaseDate)-new Date(a.PurchaseDate));
    return{
      avgPrice:prices.reduce((a,b)=>a+b,0)/prices.length,
      minPrice:Math.min(...prices),
      maxPrice:Math.max(...prices),
      count:history.length,
      recent:sorted.slice(0,5).map(p=>({date:p.PurchaseDate,price:parseFloat(p.UnitPrice),supplier:p.Supplier}))
    };
  };

  // Check price variance and return warning if needed
  const checkPriceVariance=(newItem)=>{
    const history=getPriceHistory(newItem.MasterSKU);
    const ing=ingredients.find(i=>String(i.MasterSKU)===String(newItem.MasterSKU));
    const marketPrice=parseFloat(ing?.MarketPrice)||0;
    
    const currentUnitPrice=newItem.unitPrice;
    
    // Compare to purchase history first, then market price
    let comparePrice=0;
    let compareSource='';
    
    if(history&&history.avgPrice>0){
      comparePrice=history.avgPrice;
      compareSource='purchase history';
    }else if(marketPrice>0){
      comparePrice=marketPrice;
      compareSource='market price';
    }else{
      return null; // No price to compare against
    }
    
    const variance=((currentUnitPrice-comparePrice)/comparePrice)*100;
    const absVariance=Math.abs(variance);
    
    // Threshold settings
    const warnThreshold=30;  // 30% = yellow warning
    const blockThreshold=50; // 50% = red warning, require confirm
    
    if(absVariance>=warnThreshold){
      return{
        item:newItem,
        currentPrice:currentUnitPrice,
        avgPrice:comparePrice,
        variance:variance.toFixed(1),
        absVariance:absVariance,
        source:compareSource,
        history:history,
        level:absVariance>=blockThreshold?'high':'medium',
        direction:variance>0?'higher':'lower'
      };
    }
    return null;
  };

  // Post item to temporary list
  const postItem=(forcePost=false)=>{
    if(!item.ItemName){showToast('Select an ingredient','error');return}
    if(!item.Qty){showToast('Enter quantity','error');return}
    if(!item.Price){showToast('Enter price','error');return}
    
    const qty=parseFloat(item.Qty)||0;
    const pricePerUnit=parseFloat(item.Price)||0;
    const extTotal=qty*pricePerUnit;  // Qty √ó Price per container
    
    const newItem={
      ...item,
      id:Date.now(),
      pricePerUnit:pricePerUnit,
      extTotal:extTotal,
      unitPrice:calcUnitPrice({...item,Price:extTotal})  // Pass total for unit price calc
    };
    
    // Check price variance (skip if force posting)
    if(!forcePost){
      const warning=checkPriceVariance(newItem);
      if(warning){
        setPriceWarning(warning);
        return;
      }
    }
    
    setPostedItems([...postedItems,newItem]);
    setItem({ItemName:'',MasterSKU:'',BaseUnit:'g',Description:'',ContainerType:'',ContainerSize:'',ContainerUnit:'kg',Qty:'',Price:'',Notes:''});
    setPriceWarning(null);
    showToast('Item added!');
  };

  // Confirm price warning and post anyway
  const confirmPriceWarning=()=>{
    if(priceWarning?.item){
      setPostedItems([...postedItems,priceWarning.item]);
      setItem({ItemName:'',MasterSKU:'',BaseUnit:'g',Description:'',ContainerType:'',ContainerSize:'',ContainerUnit:'kg',Qty:'',Price:'',Notes:''});
      setPriceWarning(null);
      showToast('Item added!');
    }
  };

  // Remove item from temp list
  const removePosted=(id)=>{
    setPostedItems(postedItems.filter(p=>p.id!==id));
  };

  // Clear all posted items
  const clearAll=()=>{
    if(postedItems.length===0)return;
    if(confirm('Clear all posted items?')){
      setPostedItems([]);
    }
  };

  // Save all items to server
  const saveAll=async()=>{
    if(postedItems.length===0){showToast('No items to save','error');return}
    
    setSaving(true);
    try{
      await api(apiUrl,'addPurchases',{data:postedItems.map(p=>({
        ItemName:p.ItemName,
        MasterSKU:p.MasterSKU,
        BaseUnit:p.BaseUnit,
        Description:p.Description,
        ContainerType:p.ContainerType,
        ContainerSize:p.ContainerSize,
        ContainerUnit:p.ContainerUnit,
        Qty:p.Qty,
        Price:p.extTotal,  // Send total price (Qty √ó Price per unit)
        Notes:p.Notes,
        Branch:BRANCH_NAME,
        BranchCode:BRANCH_CODE,
        PurchaseDate:header.PurchaseDate,
        Supplier:header.Supplier,
        PO:header.PO,
        InvoicePhoto:header.InvoicePhoto
      }))});
      
      showToast('Saved '+postedItems.length+' items!');
      setPostedItems([]);
      setPhotoPreview(null);
      setHeader({...header,Supplier:'',PO:'',InvoicePhoto:''});
      loadTx();
    }catch(e){showToast(e.message,'error')}finally{setSaving(false)}
  };

  const poTotal=postedItems.reduce((s,p)=>s+(parseFloat(p.extTotal)||0),0);
  const containerTypes=(settings.ContainerTypes||'Sack,Bottle,Can,Box,Pack,Drum,Bag,Tray,Loose').split(',');
  const containerUnits=(settings.ContainerUnits||'kg,g,L,ml,pcs').split(',');
  const payMethods=(settings.PaymentMethods||'Cash,GCash,Maya,Bank Transfer,Credit').split(',');
  const filteredIng=ingredients.filter(ing=>ing.Name?.toLowerCase().includes(search.toLowerCase()));

  return(
    <div className="space-y-4 fade">
      {/* Photo viewer modal */}
      {viewPhoto&&<div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4" onClick={()=>setViewPhoto(null)}>
        <div className="max-w-lg w-full">
          <img src={viewPhoto} alt="Invoice" className="w-full rounded-lg"/>
          <p className="text-center text-white mt-2 text-sm">Tap to close</p>
        </div>
      </div>}

      {/* Price Warning Modal */}
      {priceWarning&&<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl p-4 max-w-sm w-full fade">
          <div className={`text-center p-3 rounded-xl mb-3 ${priceWarning.level==='high'?'bg-red-100':'bg-amber-100'}`}>
            <span className="text-3xl">{priceWarning.level==='high'?'üö®':'‚ö†Ô∏è'}</span>
            <h3 className={`font-bold text-lg ${priceWarning.level==='high'?'text-red-700':'text-amber-700'}`}>Price Check Required</h3>
          </div>
          
          <div className="space-y-3">
            <div className="text-center">
              <p className="font-bold text-lg">{priceWarning.item?.ItemName}</p>
              <p className="text-2xl font-bold text-gray-800">‚Ç±{priceWarning.currentPrice?.toFixed(4)}<span className="text-sm text-gray-500">/{priceWarning.item?.BaseUnit}</span></p>
            </div>
            
            <div className={`p-3 rounded-xl text-center ${priceWarning.level==='high'?'bg-red-50':'bg-amber-50'}`}>
              <p className="text-sm">This is <span className="font-bold text-lg">{priceWarning.absVariance?.toFixed(0)}% {priceWarning.direction}</span></p>
              <p className="text-xs text-gray-600">than {priceWarning.source} (‚Ç±{priceWarning.avgPrice?.toFixed(4)})</p>
            </div>
            
            {priceWarning.history?.recent?.length>0&&<div>
              <p className="text-xs text-gray-500 mb-1">Recent purchases:</p>
              <div className="text-xs space-y-1 max-h-24 overflow-y-auto">
                {priceWarning.history.recent.map((r,i)=>
                  <div key={i} className="flex justify-between bg-gray-50 p-1 rounded">
                    <span className="text-gray-600">{r.date} ‚Ä¢ {r.supplier||'?'}</span>
                    <span className="font-medium">‚Ç±{r.price?.toFixed(4)}</span>
                  </div>
                )}
              </div>
            </div>}
            
            <div className="flex gap-2 pt-2">
              <button onClick={()=>setPriceWarning(null)} className="btn btn-s flex-1">‚úèÔ∏è Edit Entry</button>
              <button onClick={confirmPriceWarning} className={`btn flex-1 text-white ${priceWarning.level==='high'?'bg-red-600':'bg-amber-500'}`}>‚úÖ Confirm Correct</button>
            </div>
          </div>
        </div>
      </div>}

      <div className="flex justify-between items-center">
        <h2 className="text-lg font-bold text-gray-800">üõí Purchase Entry</h2>
      </div>

      {/* === HEADER SECTION === */}
      <div className="card p-4 space-y-3 bg-gradient-to-r from-red-800 to-red-700 text-white">
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label className="text-xs text-red-200">Purchase Date</label>
            <input type="date" value={header.PurchaseDate} onChange={e=>setHeader({...header,PurchaseDate:e.target.value})} className="inp bg-white/20 border-white/30 text-white"/>
          </div>
          <div>
            <label className="text-xs text-red-200">Supplier Name</label>
            <input value={header.Supplier} onChange={e=>setHeader({...header,Supplier:e.target.value})} className="inp bg-white/20 border-white/30 text-white placeholder-white/50" placeholder="Where did you buy from?"/>
          </div>
        </div>
        <div className="grid grid-cols-2 gap-3">
          <div>
            <label className="text-xs text-red-200">P.O. / Invoice #</label>
            <input value={header.PO} onChange={e=>setHeader({...header,PO:e.target.value})} className="inp bg-white/20 border-white/30 text-white placeholder-white/50" placeholder="Reference number"/>
          </div>
          <div>
            <label className="text-xs text-red-200">Payment Method</label>
            <select value={header.PayMethod} onChange={e=>setHeader({...header,PayMethod:e.target.value})} className="inp bg-white/20 border-white/30 text-white">
              {payMethods.map(m=><option key={m} value={m.trim()} className="text-black">{m.trim()}</option>)}
            </select>
          </div>
        </div>
        
        {/* Invoice Photo */}
        <div>
          <label className="text-xs text-red-200">üì∑ Invoice Photo</label>
          {photoPreview||header.InvoicePhoto?(
            <div className="relative mt-1">
              <img src={photoPreview||header.InvoicePhoto} alt="Invoice" className="w-full h-24 object-cover rounded-lg"/>
              <button onClick={()=>{setPhotoPreview(null);setHeader({...header,InvoicePhoto:''})}} className="absolute top-1 right-1 bg-black/50 text-white w-6 h-6 rounded-full text-xs">‚úï</button>
              {uploading&&<div className="absolute inset-0 bg-black/50 flex items-center justify-center rounded-lg"><div className="w-6 h-6 border-2 border-white/30 border-t-white rounded-full spin"/></div>}
            </div>
          ):(
            <label className="block border-2 border-dashed border-white/30 rounded-lg p-3 text-center cursor-pointer hover:border-white/50 mt-1">
              <input type="file" accept="image/*" capture="environment" onChange={handlePhoto} className="hidden"/>
              <span className="text-2xl">üì∑</span>
              <span className="text-xs block text-red-200">Tap to capture</span>
            </label>
          )}
        </div>

        {/* P.O. Total */}
        <div className="bg-yellow-500 text-black rounded-lg p-3 flex justify-between items-center">
          <span className="font-bold">P.O. Total:</span>
          <span className="text-2xl font-bold">‚Ç± {poTotal.toLocaleString('en-PH',{minimumFractionDigits:2})}</span>
        </div>
      </div>

      {/* === ITEM ENTRY SECTION === */}
      <div className="card p-4 space-y-3">
        <h3 className="font-bold text-gray-700 border-b pb-2">Item Entry</h3>
        
        {/* Item Name with Search */}
        <div className="grid grid-cols-3 gap-2">
          <div className="col-span-2 relative">
            <label className="text-xs text-gray-500">Ingredient Name (Search)</label>
            <input 
              value={item.ItemName} 
              onChange={e=>{setItem({...item,ItemName:e.target.value});setSearch(e.target.value);setShowSearch(true)}}
              onFocus={()=>setShowSearch(true)}
              onBlur={()=>setTimeout(()=>setShowSearch(false),200)}
              className="inp" 
              placeholder="Type to search ingredients..."
            />
            {showSearch&&search&&filteredIng.length>0&&(
              <div className="absolute top-full left-0 right-0 bg-white border rounded-lg shadow-lg z-20 max-h-48 overflow-y-auto">
                {filteredIng.slice(0,10).map(ing=>
                  <button key={ing.MasterSKU} onMouseDown={()=>selectIngredient(ing)} className="w-full p-2 text-left hover:bg-red-50 text-sm border-b">
                    <span className="font-medium">{ing.Name}</span>
                    {ing.ContainerType&&<span className="text-gray-400 text-xs ml-2">({ing.ContainerType} {ing.ContainerSize}{ing.ContainerUnit})</span>}
                  </button>
                )}
              </div>
            )}
          </div>
          <div>
            <label className="text-xs text-gray-500">SKU Code</label>
            <input value={item.MasterSKU} readOnly className="inp bg-gray-100 text-gray-500" placeholder="Auto"/>
          </div>
        </div>

        <div>
          <label className="text-xs text-gray-500">Description / Notes (Optional)</label>
          <input value={item.Description} onChange={e=>setItem({...item,Description:e.target.value})} className="inp" placeholder="Brand, variant, or special notes"/>
        </div>

        <div className="grid grid-cols-4 gap-2">
          <div>
            <label className="text-xs text-gray-500">How Many?</label>
            <input type="number" value={item.Qty} onChange={e=>setItem({...item,Qty:e.target.value})} className="inp text-center font-bold" placeholder="0"/>
          </div>
          <div>
            <label className="text-xs text-gray-500">Container Type</label>
            <select value={item.ContainerType} onChange={e=>setItem({...item,ContainerType:e.target.value})} className="inp text-sm">
              <option value="">(None)</option>
              {containerTypes.map(c=><option key={c} value={c.trim()}>{c.trim()}</option>)}
            </select>
          </div>
          <div>
            <label className="text-xs text-gray-500">Container Size</label>
            <input type="number" value={item.ContainerSize} onChange={e=>setItem({...item,ContainerSize:e.target.value})} className="inp text-center" placeholder="0" step="0.1"/>
          </div>
          <div>
            <label className="text-xs text-gray-500">Size Unit</label>
            <select value={item.ContainerUnit} onChange={e=>setItem({...item,ContainerUnit:e.target.value})} className="inp text-sm">
              {containerUnits.map(u=><option key={u} value={u.trim()}>{u.trim()}</option>)}
            </select>
          </div>
        </div>

        <div className="grid grid-cols-2 gap-2">
          <div>
            <label className="text-xs text-gray-500">Price per {item.ContainerType||'Unit'}</label>
            <div className="relative">
              <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold">‚Ç±</span>
              <input type="number" value={item.Price} onChange={e=>setItem({...item,Price:e.target.value})} className="inp pl-8 text-lg font-bold" placeholder="0.00" step="0.01"/>
            </div>
          </div>
          <div className="flex items-end">
            <button onClick={postItem} className="btn btn-p w-full py-3 text-lg">
              üì• Add to List
            </button>
          </div>
        </div>

        {/* Ext Total and Unit price preview */}
        {item.Qty&&item.Price&&(
          <div className="text-sm bg-green-50 p-2 rounded-lg space-y-1">
            <div className="flex justify-between text-green-800">
              <span>Ext Total: {item.Qty} √ó ‚Ç±{parseFloat(item.Price).toLocaleString()}</span>
              <span className="font-bold">‚Ç±{(parseFloat(item.Qty)*parseFloat(item.Price)).toLocaleString()}</span>
            </div>
            <div className="text-xs text-green-700 text-center">
              Standardized: ‚Ç±{calcUnitPrice({...item,Price:parseFloat(item.Qty)*parseFloat(item.Price)}).toFixed(4)} per {item.BaseUnit}
            </div>
          </div>
        )}
      </div>

      {/* === POSTED ITEMS TABLE === */}
      <div className="card">
        <div className="p-3 border-b bg-gray-800 text-white flex justify-between items-center rounded-t-xl">
          <span className="font-bold">üìã Posted Items ({postedItems.length})</span>
          <div className="flex gap-2">
            <button onClick={clearAll} disabled={postedItems.length===0} className="px-3 py-1 bg-gray-600 rounded text-sm disabled:opacity-50">Clear All</button>
            <button onClick={saveAll} disabled={saving||postedItems.length===0} className="px-4 py-1 bg-green-600 rounded text-sm font-bold disabled:opacity-50">
              {saving?'Saving...':'üíæ Save All'}
            </button>
          </div>
        </div>
        
        <div className="max-h-64 overflow-y-auto">
          {postedItems.length===0?(
            <p className="p-6 text-center text-gray-400">No items posted yet. Add items above and click "Post Item".</p>
          ):(
            <table className="w-full text-sm">
              <thead className="bg-gray-100 sticky top-0">
                <tr>
                  <th className="p-2 text-left">Item</th>
                  <th className="p-2 text-center">Qty</th>
                  <th className="p-2 text-right">Price/:</th>
                  <th className="p-2 text-right">Ext Total</th>
                  <th className="p-2 w-8"></th>
                </tr>
              </thead>
              <tbody>
                {postedItems.map(p=>
                  <tr key={p.id} className="border-b hover:bg-gray-50">
                    <td className="p-2">
                      <div className="font-medium">{p.ItemName}</div>
                      {p.ContainerType&&<div className="text-xs text-gray-500">{p.ContainerType} ({p.ContainerSize}{p.ContainerUnit})</div>}
                    </td>
                    <td className="p-2 text-center">{p.Qty}</td>
                    <td className="p-2 text-right text-gray-600">{fmt(p.pricePerUnit)}</td>
                    <td className="p-2 text-right font-bold text-red-700">{fmt(p.extTotal)}</td>
                    <td className="p-2">
                      <button onClick={()=>removePosted(p.id)} className="text-red-500 hover:text-red-700">‚úï</button>
                    </td>
                  </tr>
                )}
              </tbody>
              <tfoot className="bg-red-50">
                <tr>
                  <td colSpan="3" className="p-2 font-bold text-right">Total:</td>
                  <td className="p-2 text-right font-bold text-red-700 text-lg">{fmt(poTotal)}</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          )}
        </div>
      </div>

      {/* === RECENT PURCHASES (Already Saved) === */}
      <div className="card">
        <div className="p-3 border-b bg-gray-50 flex justify-between items-center">
          <span className="font-semibold text-gray-700">üìú Saved Purchases</span>
          <div className="flex items-center gap-2">
            <span className="text-sm text-gray-500">{purchases.length} items</span>
            <select value={viewDays} onChange={e=>setViewDays(parseInt(e.target.value))} className="text-sm border rounded-lg px-2 py-1 bg-white">
              <option value="0">Today</option>
              <option value="7">7 Days</option>
              <option value="30">30 Days</option>
            </select>
          </div>
        </div>
        <div className="max-h-64 overflow-y-auto">
          {purchases.length===0?<p className="p-6 text-center text-gray-400">{viewDays===0?'No purchases saved today':'No purchases'}</p>:
            purchases.slice(0,30).map(p=>
              <div key={p.UniqueID} className="p-3 border-b flex items-center">
                {p.InvoicePhoto&&<button onClick={()=>setViewPhoto(p.InvoicePhoto)} className="w-10 h-10 rounded-lg overflow-hidden mr-3 flex-shrink-0 bg-gray-200">
                  <img src={p.InvoicePhoto} alt="" className="w-full h-full object-cover"/>
                </button>}
                <div className="flex-1 min-w-0">
                  <p className="font-medium text-sm">{p.ItemName}</p>
                  <p className="text-xs text-gray-500">{p.Qty} {p.ContainerType||p.Unit}{p.WeightPerContainer?' ('+p.WeightPerContainer+')':''} ‚Ä¢ {p.Supplier||'No supplier'}</p>
                </div>
                <span className="font-bold text-red-700">{fmt(p.Price)}</span>
              </div>
            )}
        </div>
      </div>
    </div>
  );
}

function Expenses({apiUrl,settings,expenses,showToast,loadTx,viewDays,setViewDays}){
  const[saving,setSaving]=useState(false);
  const[uploading,setUploading]=useState(false);
  
  // Header info (shared by all items)
  const[header,setHeader]=useState({
    Date:new Date().toISOString().split('T')[0],
    Vendor:'',
    Reference:'',
    PayMethod:'Cash',
    ReceiptPhoto:''
  });
  
  // Current item being entered
  const[item,setItem]=useState({Category:'Utilities',Description:'',Amount:''});
  
  // Temporary posted items (not yet saved to server)
  const[postedItems,setPostedItems]=useState([]);
  
  const[photoPreview,setPhotoPreview]=useState(null);
  const[viewPhoto,setViewPhoto]=useState(null);

  // Photo handling
  const handlePhoto=async(e)=>{
    const file=e.target.files?.[0];
    if(!file)return;
    
    const reader=new FileReader();
    reader.onload=(ev)=>setPhotoPreview(ev.target.result);
    reader.readAsDataURL(file);
    
    setUploading(true);
    try{
      const base64=await new Promise((resolve)=>{
        const r=new FileReader();
        r.onload=(ev)=>resolve(ev.target.result);
        r.readAsDataURL(file);
      });
      
      const filename=BRANCH_CODE+'_EXP_'+header.Date+'_'+Date.now()+'.jpg';
      const result=await api(apiUrl,'uploadReceiptPhoto',{base64,filename,branchCode:BRANCH_CODE});
      
      if(result.success){
        setHeader({...header,ReceiptPhoto:result.viewUrl});
        showToast('Photo uploaded!');
      }else{
        showToast(result.error||'Upload failed','error');
      }
    }catch(err){
      showToast('Upload failed: '+err.message,'error');
    }finally{
      setUploading(false);
    }
  };

  // Post item to temporary list
  const postItem=()=>{
    if(!item.Description){showToast('Enter description','error');return}
    if(!item.Amount){showToast('Enter amount','error');return}
    
    const newItem={
      ...item,
      id:Date.now(),
      amount:parseFloat(item.Amount)||0
    };
    
    setPostedItems([...postedItems,newItem]);
    setItem({Category:item.Category,Description:'',Amount:''});
    showToast('Item posted!');
  };

  // Remove item from temp list
  const removePosted=(id)=>{
    setPostedItems(postedItems.filter(p=>p.id!==id));
  };

  // Clear all posted items
  const clearAll=()=>{
    if(postedItems.length===0)return;
    if(confirm('Clear all posted items?')){
      setPostedItems([]);
    }
  };

  // Save all items to server
  const saveAll=async()=>{
    if(postedItems.length===0){showToast('No items to save','error');return}
    
    setSaving(true);
    try{
      await api(apiUrl,'addExpenses',{data:postedItems.map(p=>({
        Category:p.Category,
        Description:p.Description,
        Amount:p.amount,
        Branch:BRANCH_NAME,
        BranchCode:BRANCH_CODE,
        Date:header.Date,
        Vendor:header.Vendor,
        Reference:header.Reference,
        PayMethod:header.PayMethod,
        ReceiptPhoto:header.ReceiptPhoto
      }))});
      
      showToast('Saved '+postedItems.length+' items!');
      setPostedItems([]);
      setPhotoPreview(null);
      setHeader({...header,Vendor:'',Reference:'',ReceiptPhoto:''});
      loadTx();
    }catch(e){showToast(e.message,'error')}finally{setSaving(false)}
  };

  const totalAmount=postedItems.reduce((s,p)=>s+(p.amount||0),0);
  const categories=(settings.ExpenseCategories||'Utilities,Supplies,Maintenance,Transportation,Labor,Marketing,Rent,Other').split(',');
  const payMethods=(settings.PaymentMethods||'Cash,GCash,Maya,Bank Transfer').split(',');

  return(
    <div className="space-y-4 fade">
      {/* Photo viewer modal */}
      {viewPhoto&&<div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4" onClick={()=>setViewPhoto(null)}>
        <div className="max-w-lg w-full">
          <img src={viewPhoto} alt="Receipt" className="w-full rounded-lg"/>
          <p className="text-center text-white mt-2 text-sm">Tap to close</p>
        </div>
      </div>}

      <div className="flex justify-between items-center">
        <h2 className="text-lg font-bold text-gray-800">üí∞ Expense Entry</h2>
      </div>

      {/* === HEADER SECTION === */}
      <div className="card p-4 space-y-3 bg-gradient-to-r from-amber-700 to-amber-600 text-white">
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label className="text-xs text-amber-200">Expense Date</label>
            <input type="date" value={header.Date} onChange={e=>setHeader({...header,Date:e.target.value})} className="inp bg-white/20 border-white/30 text-white"/>
          </div>
          <div>
            <label className="text-xs text-amber-200">Payee (Who was paid?)</label>
            <input value={header.Vendor} onChange={e=>setHeader({...header,Vendor:e.target.value})} className="inp bg-white/20 border-white/30 text-white placeholder-white/50" placeholder="Store, person, or company"/>
          </div>
        </div>
        <div className="grid grid-cols-2 gap-3">
          <div>
            <label className="text-xs text-amber-200">Receipt / Reference #</label>
            <input value={header.Reference} onChange={e=>setHeader({...header,Reference:e.target.value})} className="inp bg-white/20 border-white/30 text-white placeholder-white/50" placeholder="OR number, etc."/>
          </div>
          <div>
            <label className="text-xs text-amber-200">Payment Method</label>
            <select value={header.PayMethod} onChange={e=>setHeader({...header,PayMethod:e.target.value})} className="inp bg-white/20 border-white/30 text-white">
              {payMethods.map(m=><option key={m} value={m.trim()} className="text-black">{m.trim()}</option>)}
            </select>
          </div>
        </div>
        
        {/* Receipt Photo */}
        <div>
          <label className="text-xs text-amber-200">üßæ Receipt Photo</label>
          {photoPreview||header.ReceiptPhoto?(
            <div className="relative mt-1">
              <img src={photoPreview||header.ReceiptPhoto} alt="Receipt" className="w-full h-24 object-cover rounded-lg"/>
              <button onClick={()=>{setPhotoPreview(null);setHeader({...header,ReceiptPhoto:''})}} className="absolute top-1 right-1 bg-black/50 text-white w-6 h-6 rounded-full text-xs">‚úï</button>
              {uploading&&<div className="absolute inset-0 bg-black/50 flex items-center justify-center rounded-lg"><div className="w-6 h-6 border-2 border-white/30 border-t-white rounded-full spin"/></div>}
            </div>
          ):(
            <label className="block border-2 border-dashed border-white/30 rounded-lg p-3 text-center cursor-pointer hover:border-white/50 mt-1">
              <input type="file" accept="image/*" capture="environment" onChange={handlePhoto} className="hidden"/>
              <span className="text-2xl">üßæ</span>
              <span className="text-xs block text-amber-200">Tap to capture</span>
            </label>
          )}
        </div>

        {/* Total */}
        <div className="bg-yellow-500 text-black rounded-lg p-3 flex justify-between items-center">
          <span className="font-bold">Total:</span>
          <span className="text-2xl font-bold">‚Ç± {totalAmount.toLocaleString('en-PH',{minimumFractionDigits:2})}</span>
        </div>
      </div>

      {/* === ITEM ENTRY SECTION === */}
      <div className="card p-4 space-y-3">
        <h3 className="font-bold text-gray-700 border-b pb-2">Expense Item</h3>
        
        <div className="grid grid-cols-2 gap-2">
          <div>
            <label className="text-xs text-gray-500">Category</label>
            <select value={item.Category} onChange={e=>setItem({...item,Category:e.target.value})} className="inp">
              {categories.map(c=><option key={c} value={c.trim()}>{c.trim()}</option>)}
            </select>
          </div>
          <div>
            <label className="text-xs text-gray-500">Amount</label>
            <div className="relative">
              <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold">‚Ç±</span>
              <input type="number" value={item.Amount} onChange={e=>setItem({...item,Amount:e.target.value})} className="inp pl-8 font-bold" placeholder="0.00" step="0.01"/>
            </div>
          </div>
        </div>

        <div>
          <label className="text-xs text-gray-500">Description *</label>
          <input value={item.Description} onChange={e=>setItem({...item,Description:e.target.value})} className="inp" placeholder="What was this expense for?"/>
        </div>

        <button onClick={postItem} className="btn btn-p w-full py-3 text-lg">
          üì• Post Item
        </button>
      </div>

      {/* === POSTED ITEMS TABLE === */}
      <div className="card">
        <div className="p-3 border-b bg-gray-800 text-white flex justify-between items-center rounded-t-xl">
          <span className="font-bold">üìã Posted Items ({postedItems.length})</span>
          <div className="flex gap-2">
            <button onClick={clearAll} disabled={postedItems.length===0} className="px-3 py-1 bg-gray-600 rounded text-sm disabled:opacity-50">Clear All</button>
            <button onClick={saveAll} disabled={saving||postedItems.length===0} className="px-4 py-1 bg-green-600 rounded text-sm font-bold disabled:opacity-50">
              {saving?'Saving...':'üíæ Save All'}
            </button>
          </div>
        </div>
        
        <div className="max-h-64 overflow-y-auto">
          {postedItems.length===0?(
            <p className="p-6 text-center text-gray-400">No items posted yet. Add items above and click "Post Item".</p>
          ):(
            <table className="w-full text-sm">
              <thead className="bg-gray-100 sticky top-0">
                <tr>
                  <th className="p-2 text-left">Description</th>
                  <th className="p-2 text-left">Category</th>
                  <th className="p-2 text-right">Amount</th>
                  <th className="p-2 w-8"></th>
                </tr>
              </thead>
              <tbody>
                {postedItems.map(p=>
                  <tr key={p.id} className="border-b hover:bg-gray-50">
                    <td className="p-2 font-medium">{p.Description}</td>
                    <td className="p-2 text-gray-500 text-xs">{p.Category}</td>
                    <td className="p-2 text-right font-bold text-amber-700">{fmt(p.amount)}</td>
                    <td className="p-2">
                      <button onClick={()=>removePosted(p.id)} className="text-red-500 hover:text-red-700">‚úï</button>
                    </td>
                  </tr>
                )}
              </tbody>
              <tfoot className="bg-amber-50">
                <tr>
                  <td colSpan="2" className="p-2 font-bold text-right">Total:</td>
                  <td className="p-2 text-right font-bold text-amber-700 text-lg">{fmt(totalAmount)}</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          )}
        </div>
      </div>

      {/* === RECENT EXPENSES (Already Saved) === */}
      <div className="card">
        <div className="p-3 border-b bg-gray-50 flex justify-between items-center">
          <span className="font-semibold text-gray-700">üìú Saved Expenses</span>
          <div className="flex items-center gap-2">
            <span className="text-sm text-gray-500">{expenses.length} items</span>
            <select value={viewDays} onChange={e=>setViewDays(parseInt(e.target.value))} className="text-sm border rounded-lg px-2 py-1 bg-white">
              <option value="0">Today</option>
              <option value="7">7 Days</option>
              <option value="30">30 Days</option>
            </select>
          </div>
        </div>
        <div className="max-h-64 overflow-y-auto">
          {expenses.length===0?<p className="p-6 text-center text-gray-400">{viewDays===0?'No expenses saved today':'No expenses'}</p>:
            expenses.slice(0,30).map(e=>
              <div key={e.UniqueID} className="p-3 border-b flex items-center">
                {e.ReceiptPhoto&&<button onClick={()=>setViewPhoto(e.ReceiptPhoto)} className="w-10 h-10 rounded-lg overflow-hidden mr-3 flex-shrink-0 bg-gray-200">
                  <img src={e.ReceiptPhoto} alt="" className="w-full h-full object-cover"/>
                </button>}
                <div className="flex-1 min-w-0">
                  <p className="font-medium text-sm">{e.Description}</p>
                  <p className="text-xs text-gray-500">{e.Category} ‚Ä¢ {e.Vendor||'No payee'}</p>
                </div>
                <span className="font-bold text-amber-600">{fmt(e.Amount)}</span>
              </div>
            )}
        </div>
      </div>
    </div>
  );
}

function Ingredients({apiUrl,ingredients,ingCats,settings,showToast,loadAll}){
  const[show,setShow]=useState(false);
  const[saving,setSaving]=useState(false);
  const[search,setSearch]=useState('');
  const[form,setForm]=useState({Name:'',Unit:'g',Category:'Other',YieldPercent:100});

  const add=async()=>{
    if(!form.Name){showToast('Enter name','error');return}
    setSaving(true);
    try{
      await api(apiUrl,'addIngredient',{data:form});
      showToast('Added!');
      setForm({Name:'',Unit:'g',Category:'Other',YieldPercent:100});
      setShow(false);
      loadAll();
    }catch(e){showToast(e.message,'error')}finally{setSaving(false)}
  };

  const filtered=ingredients.filter(i=>i.Name?.toLowerCase().includes(search.toLowerCase()));
  const units=(settings.Units||'g,kg,ml,L,pcs,pack,box').split(',');

  return(
    <div className="space-y-4 fade">
      <div className="flex justify-between items-center">
        <h2 className="text-lg font-bold text-gray-800">ü•¨ Ingredients</h2>
        <button onClick={()=>setShow(!show)} className="btn btn-p btn-sm">{show?'‚úï Cancel':'+ Add New'}</button>
      </div>

      {show&&<div className="card p-4 fade space-y-3">
        <div><label className="lbl">Name *</label><input value={form.Name} onChange={e=>setForm({...form,Name:e.target.value})} className="inp" placeholder="e.g., Chicken Breast"/></div>
        <div className="grid grid-cols-2 gap-3">
          <div><label className="lbl">Unit</label><select value={form.Unit} onChange={e=>setForm({...form,Unit:e.target.value})} className="inp">{units.map(u=><option key={u} value={u.trim()}>{u.trim()}</option>)}</select></div>
          <div><label className="lbl">Category</label><select value={form.Category||''} onChange={e=>setForm({...form,Category:e.target.value})} className="inp">{ingCats.map(c=><option key={c.Category} value={c.Category}>{c.Category}</option>)}</select></div>
        </div>
        <button onClick={add} disabled={saving} className="btn btn-p w-full">
          {saving?'Saving...':'‚úì Add Ingredient'}
        </button>
      </div>}

      <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="üîç Search ingredients..." className="inp"/>
      
      <div className="card">
        <div className="p-3 border-b bg-gray-50">
          <span className="font-semibold text-gray-700">{filtered.length} ingredients</span>
        </div>
        <div className="max-h-96 overflow-y-auto">
          {filtered.length===0?<p className="p-8 text-center text-gray-400">No ingredients found</p>:
            filtered.map(ing=>
              <div key={ing.MasterSKU} className="p-3 border-b">
                <p className="font-medium">{ing.Name}</p>
                <p className="text-xs text-gray-500">SKU: {ing.MasterSKU} ‚Ä¢ {ing.Unit} ‚Ä¢ {ing.Category}</p>
              </div>
            )}
        </div>
      </div>
    </div>
  );
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHOPPING MODE COMPONENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function ShopView({ingredients,settings,purchases,cart,setCart,showToast,apiUrl,loadAll}){
  const[search,setSearch]=useState('');
  const[category,setCategory]=useState('All');
  const[quickAdd,setQuickAdd]=useState(null);
  const[showNewIngredient,setShowNewIngredient]=useState(false);
  const[newIng,setNewIng]=useState({Name:'',Category:'',Unit:'g',ContainerType:'',ContainerSize:'',ContainerUnit:'kg'});
  const[saving,setSaving]=useState(false);

  const categories=['All',...new Set(ingredients.map(i=>i.Category).filter(Boolean))];
  const defaultCategories=['Meat','Seafood','Vegetables','Dairy','Dry Goods','Spices','Beverages','Frozen','Poultry','Supplies'];
  const allCategories=[...new Set([...categories.filter(c=>c!=='All'),...defaultCategories])];
  
  const filtered=ingredients.filter(i=>{
    const matchSearch=!search||i.Name?.toLowerCase().includes(search.toLowerCase());
    const matchCat=category==='All'||i.Category===category;
    return matchSearch&&matchCat;
  });

  const containerTypes=(settings.ContainerTypes||'Sack,Bottle,Can,Box,Pack,Drum,Bag,Tray,Loose').split(',');
  const containerUnits=(settings.ContainerUnits||'kg,g,L,ml,pcs').split(',');

  const getRecentPrice=(sku)=>{
    const recent=purchases.filter(p=>String(p.MasterSKU)===String(sku)).sort((a,b)=>new Date(b.PurchaseDate)-new Date(a.PurchaseDate))[0];
    return recent?{price:parseFloat(recent.UnitPrice),container:recent.ContainerType,size:recent.WeightPerContainer}:null;
  };

  const calcUnitPrice=(item)=>{
    const qty=parseFloat(item.Qty)||0;
    const price=parseFloat(item.Price)||0;
    const size=parseFloat(item.ContainerSize)||0;
    const cu=(item.ContainerUnit||'kg').toLowerCase();
    const bu=(item.BaseUnit||'g').toLowerCase();
    let totalBase=qty;
    if(size>0){
      let containerInBase=size;
      if(cu==='kg'&&bu==='g')containerInBase=size*1000;
      else if(cu==='l'&&bu==='ml')containerInBase=size*1000;
      totalBase=qty*containerInBase;
    }else{
      if(cu==='kg'&&bu==='g')totalBase=qty*1000;
      else if(cu==='l'&&bu==='ml')totalBase=qty*1000;
    }
    return totalBase>0?(price/totalBase):0;
  };

  const addToCart=(item)=>{
    const qty=parseFloat(item.Qty)||0;
    const price=parseFloat(item.Price)||0;
    if(!qty||!price){showToast('Enter quantity and price','error');return}
    const extTotal=qty*price;
    const newItem={...item,id:Date.now(),extTotal,unitPrice:calcUnitPrice({...item,Price:extTotal})};
    setCart([...cart,newItem]);
    setQuickAdd(null);
    showToast(`Added ${item.ItemName}!`);
  };

  const defaultIcons={'Meat':'ü•©','Seafood':'ü¶ê','Vegetables':'ü•¨','Dairy':'ü•õ','Dry Goods':'üåæ','Spices':'üå∂Ô∏è','Beverages':'ü•§','Frozen':'üßä','Poultry':'üçó','Pork':'üê∑','Beef':'üêÑ','Supplies':'üì¶','Noodles':'üçú','Sauce':'ü•´','Oil':'ü´í','Eggs':'ü•ö','Rice':'üçö','Cleaning':'üßπ'};
  
  const getCategoryIcon=(cat)=>{
    if(settings.CategoryIcons){
      const customIcons={};
      settings.CategoryIcons.split(',').forEach(pair=>{const[name,icon]=pair.split(':');if(name&&icon)customIcons[name.trim()]=icon.trim()});
      if(customIcons[cat])return customIcons[cat];
    }
    return defaultIcons[cat]||'üì¶';
  };

  const addNewIngredient=async()=>{
    if(!newIng.Name){showToast('Enter ingredient name','error');return}
    if(!newIng.Category){showToast('Select category','error');return}
    setSaving(true);
    try{
      await api(apiUrl,'addIngredient',{data:newIng});
      showToast(`Added ${newIng.Name}!`);
      setShowNewIngredient(false);
      setNewIng({Name:'',Category:'',Unit:'g',ContainerType:'',ContainerSize:'',ContainerUnit:'kg'});
      loadAll();
    }catch(e){showToast(e.message,'error')}
    finally{setSaving(false)}
  };

  return(
    <div className="space-y-4 fade">
      <div className="flex gap-2 mb-4">
        <div className="relative flex-1">
          <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">üîç</span>
          <input value={search} onChange={e=>setSearch(e.target.value)} className="inp pl-10" placeholder="Search ingredients..."/>
        </div>
        <button onClick={loadAll} className="btn btn-s px-3">üîÑ</button>
      </div>

      <div className="flex gap-2 overflow-x-auto pb-2 -mx-4 px-4">
        {categories.map(c=><button key={c} onClick={()=>setCategory(c)} className={`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition ${category===c?'bg-red-600 text-white':'bg-white text-gray-600 shadow'}`}>{c!=='All'&&<span className="mr-1">{getCategoryIcon(c)}</span>}{c}</button>)}
      </div>

      <div className="grid grid-cols-2 gap-3">
        {filtered.map(ing=>{
          const recent=getRecentPrice(ing.MasterSKU);
          const inCart=cart.filter(c=>c.MasterSKU===ing.MasterSKU).length;
          return(
            <div key={ing.MasterSKU} className="card p-3 relative">
              {inCart>0&&<span className="absolute top-2 right-2 bg-green-500 text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center">{inCart}</span>}
              <div className="text-3xl text-center mb-2">{getCategoryIcon(ing.Category)}</div>
              <h3 className="font-semibold text-sm text-gray-800 truncate">{ing.Name}</h3>
              <p className="text-xs text-gray-400">{ing.Category}</p>
              {recent&&<p className="text-xs text-green-600 mt-1">Last: ‚Ç±{recent.price?.toFixed(4)}/{ing.Unit}</p>}
              {ing.ContainerType&&<p className="text-xs text-gray-500 mt-1">üì¶ {ing.ContainerType} {ing.ContainerSize}{ing.ContainerUnit}</p>}
              <button onClick={()=>setQuickAdd({...ing,ItemName:ing.Name,BaseUnit:ing.Unit,Qty:'',Price:'',ContainerType:ing.ContainerType||'',ContainerSize:ing.ContainerSize||'',ContainerUnit:ing.ContainerUnit||'kg'})} className="w-full mt-3 bg-red-600 text-white rounded-lg py-2 text-sm font-medium hover:bg-red-700 transition">+ Add</button>
            </div>
          );
        })}
      </div>

      {filtered.length===0&&<div className="text-center py-8"><p className="text-gray-400 mb-4">No ingredients found</p><button onClick={()=>setShowNewIngredient(true)} className="btn btn-p">+ Add New Ingredient</button></div>}
      
      {filtered.length>0&&<button onClick={()=>setShowNewIngredient(true)} className="fixed bottom-24 right-4 w-14 h-14 bg-green-600 text-white rounded-full shadow-lg text-2xl flex items-center justify-center z-30 hover:bg-green-700">+</button>}

      {showNewIngredient&&<div className="fixed inset-0 bg-black/50 z-50 flex items-end justify-center" onClick={()=>setShowNewIngredient(false)}>
        <div className="bg-white w-full max-w-lg rounded-t-3xl p-4 slide-up" onClick={e=>e.stopPropagation()}>
          <div className="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"/>
          <h3 className="font-bold text-lg text-center mb-4">‚ûï Add New Ingredient</h3>
          <div className="space-y-3 mb-4">
            <div><label className="text-xs text-gray-500">Ingredient Name *</label><input value={newIng.Name} onChange={e=>setNewIng({...newIng,Name:e.target.value})} className="inp" placeholder="e.g. Chicken Breast" autoFocus/></div>
            <div className="grid grid-cols-2 gap-3">
              <div><label className="text-xs text-gray-500">Category *</label><select value={newIng.Category} onChange={e=>setNewIng({...newIng,Category:e.target.value})} className="inp"><option value="">Select...</option>{allCategories.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
              <div><label className="text-xs text-gray-500">Base Unit</label><select value={newIng.Unit} onChange={e=>setNewIng({...newIng,Unit:e.target.value})} className="inp"><option value="g">g (grams)</option><option value="ml">ml (milliliters)</option><option value="pcs">pcs (pieces)</option></select></div>
            </div>
            <div className="grid grid-cols-3 gap-3">
              <div><label className="text-xs text-gray-500">Container</label><select value={newIng.ContainerType||''} onChange={e=>setNewIng({...newIng,ContainerType:e.target.value})} className="inp text-sm"><option value="">(None)</option>{containerTypes.map(c=><option key={c} value={c.trim()}>{c.trim()}</option>)}</select></div>
              <div><label className="text-xs text-gray-500">Size</label><input type="number" value={newIng.ContainerSize} onChange={e=>setNewIng({...newIng,ContainerSize:e.target.value})} className="inp text-center" placeholder="0"/></div>
              <div><label className="text-xs text-gray-500">Unit</label><select value={newIng.ContainerUnit||'kg'} onChange={e=>setNewIng({...newIng,ContainerUnit:e.target.value})} className="inp text-sm">{containerUnits.map(u=><option key={u} value={u.trim()}>{u.trim()}</option>)}</select></div>
            </div>
          </div>
          <div className="flex gap-3"><button onClick={()=>setShowNewIngredient(false)} className="flex-1 btn btn-s">Cancel</button><button onClick={addNewIngredient} disabled={saving} className="flex-1 btn btn-p">{saving?'Saving...':'‚úÖ Add'}</button></div>
        </div>
      </div>}

      {quickAdd&&<div className="fixed inset-0 bg-black/50 z-50 flex items-end justify-center" onClick={()=>setQuickAdd(null)}>
        <div className="bg-white w-full max-w-lg rounded-t-3xl p-4 slide-up" onClick={e=>e.stopPropagation()}>
          <div className="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"/>
          <h3 className="font-bold text-lg text-center mb-4">{quickAdd.ItemName}</h3>
          <div className="grid grid-cols-2 gap-3 mb-4">
            <div><label className="text-xs text-gray-500">How Many?</label><input type="number" value={quickAdd.Qty} onChange={e=>setQuickAdd({...quickAdd,Qty:e.target.value})} className="inp text-center text-xl font-bold" placeholder="0" autoFocus/></div>
            <div><label className="text-xs text-gray-500">Container Type</label><select value={quickAdd.ContainerType||''} onChange={e=>setQuickAdd({...quickAdd,ContainerType:e.target.value})} className="inp"><option value="">(None)</option>{containerTypes.map(c=><option key={c} value={c.trim()}>{c.trim()}</option>)}</select></div>
          </div>
          <div className="grid grid-cols-2 gap-3 mb-4">
            <div><label className="text-xs text-gray-500">Container Size</label><input type="number" value={quickAdd.ContainerSize} onChange={e=>setQuickAdd({...quickAdd,ContainerSize:e.target.value})} className="inp text-center" placeholder="0" step="0.1"/></div>
            <div><label className="text-xs text-gray-500">Size Unit</label><select value={quickAdd.ContainerUnit||'kg'} onChange={e=>setQuickAdd({...quickAdd,ContainerUnit:e.target.value})} className="inp">{containerUnits.map(u=><option key={u} value={u.trim()}>{u.trim()}</option>)}</select></div>
          </div>
          <div className="mb-4"><label className="text-xs text-gray-500">Price per {quickAdd.ContainerType||'Unit'}</label><div className="relative"><span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold text-xl">‚Ç±</span><input type="number" value={quickAdd.Price} onChange={e=>setQuickAdd({...quickAdd,Price:e.target.value})} className="inp pl-10 text-2xl font-bold text-center" placeholder="0.00" step="0.01"/></div></div>
          {quickAdd.Qty&&quickAdd.Price&&<div className="bg-green-50 rounded-xl p-3 mb-4 text-center"><p className="text-green-800 font-bold text-xl">{fmt(parseFloat(quickAdd.Qty)*parseFloat(quickAdd.Price))}</p><p className="text-xs text-green-600">{quickAdd.Qty} √ó ‚Ç±{parseFloat(quickAdd.Price).toLocaleString()}</p></div>}
          <div className="flex gap-3"><button onClick={()=>setQuickAdd(null)} className="flex-1 btn btn-s">Cancel</button><button onClick={()=>addToCart(quickAdd)} className="flex-1 btn btn-p">üõí Add to Cart</button></div>
        </div>
      </div>}
    </div>
  );
}

function ExpenseShop({settings,expenseCart,setExpenseCart,showToast}){
  const categories=(settings.ExpenseCategories||'Utilities,Rent,Salaries,Supplies,Transportation,Repairs,Marketing,Miscellaneous').split(',');
  const[quickAdd,setQuickAdd]=useState(null);

  const defaultExpenseIcons={'Utilities':'üí°','Rent':'üè†','Salaries':'üë•','Supplies':'üì¶','Transportation':'üöó','Repairs':'üîß','Marketing':'üì¢','Miscellaneous':'üìã','Food':'üçΩÔ∏è','Cleaning':'üßπ','Equipment':'‚öôÔ∏è','Fuel':'‚õΩ','Internet':'üåê','Water':'üíß','Electric':'‚ö°'};
  
  const getCategoryIcon=(cat)=>{
    if(settings.ExpenseIcons){
      const customIcons={};
      settings.ExpenseIcons.split(',').forEach(pair=>{const[name,icon]=pair.split(':');if(name&&icon)customIcons[name.trim()]=icon.trim()});
      if(customIcons[cat])return customIcons[cat];
    }
    return defaultExpenseIcons[cat]||'üí∞';
  };

  const addToCart=(item)=>{
    if(!item.Amount){showToast('Enter amount','error');return}
    setExpenseCart([...expenseCart,{...item,id:Date.now()}]);
    setQuickAdd(null);
    showToast(`Added ${item.Category} expense!`);
  };

  return(
    <div className="space-y-4 fade">
      <div className="text-center py-4"><span className="text-4xl">üí∞</span><h2 className="font-bold text-lg mt-2">Add Expenses</h2><p className="text-gray-500 text-sm">Tap a category</p></div>
      <div className="grid grid-cols-3 gap-3">
        {categories.map(cat=><button key={cat} onClick={()=>setQuickAdd({Category:cat.trim(),Amount:'',Description:''})} className="card p-4 text-center hover:shadow-lg transition"><span className="text-3xl">{getCategoryIcon(cat.trim())}</span><p className="text-sm font-medium mt-2 text-gray-700">{cat.trim()}</p></button>)}
      </div>
      {quickAdd&&<div className="fixed inset-0 bg-black/50 z-50 flex items-end justify-center" onClick={()=>setQuickAdd(null)}>
        <div className="bg-white w-full max-w-lg rounded-t-3xl p-4 slide-up" onClick={e=>e.stopPropagation()}>
          <div className="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"/>
          <div className="text-center mb-4"><span className="text-4xl">{getCategoryIcon(quickAdd.Category)}</span><h3 className="font-bold text-lg mt-2">{quickAdd.Category}</h3></div>
          <div className="mb-4"><label className="text-xs text-gray-500">Amount</label><div className="relative"><span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold text-xl">‚Ç±</span><input type="number" value={quickAdd.Amount} onChange={e=>setQuickAdd({...quickAdd,Amount:e.target.value})} className="inp pl-10 text-2xl font-bold text-center" placeholder="0.00" step="0.01" autoFocus/></div></div>
          <div className="mb-4"><label className="text-xs text-gray-500">Description</label><input value={quickAdd.Description} onChange={e=>setQuickAdd({...quickAdd,Description:e.target.value})} className="inp" placeholder="What was this expense for?"/></div>
          <div className="flex gap-3"><button onClick={()=>setQuickAdd(null)} className="flex-1 btn btn-s">Cancel</button><button onClick={()=>addToCart(quickAdd)} className="flex-1 btn btn-amber">üßæ Add Expense</button></div>
        </div>
      </div>}
    </div>
  );
}

function PurchaseCartModal({cart,setCart,cartTotal,onClose,settings,apiUrl,showToast,loadAll}){
  const[saving,setSaving]=useState(false);
  const[uploading,setUploading]=useState(false);
  const[checkout,setCheckout]=useState(false);
  const[header,setHeader]=useState({PurchaseDate:new Date().toISOString().split('T')[0],Supplier:'',PO:'',PayMethod:'Cash',InvoicePhoto:''});
  const[photoPreview,setPhotoPreview]=useState(null);

  const payMethods=(settings.PaymentMethods||'Cash,GCash,Maya,Bank Transfer,Credit').split(',');
  const removeItem=(id)=>setCart(cart.filter(c=>c.id!==id));
  const clearCart=()=>{if(confirm('Clear entire cart?'))setCart([])};

  const handlePhoto=async(e)=>{const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=(ev)=>setPhotoPreview(ev.target.result);reader.readAsDataURL(file)};

  const uploadPhoto=async(base64)=>{
    setUploading(true);
    try{const filename=`INV_${BRANCH_CODE}_${Date.now()}.jpg`;const result=await api(apiUrl,'uploadInvoicePhoto',{base64,filename,branchCode:BRANCH_CODE});return result.viewUrl||result.url;}
    catch(e){showToast('Photo upload failed','error');return null}
    finally{setUploading(false)}
  };

  const submitOrder=async()=>{
    if(cart.length===0){showToast('Cart is empty','error');return}
    setSaving(true);
    try{
      let invoiceUrl=header.InvoicePhoto;
      if(photoPreview&&!invoiceUrl)invoiceUrl=await uploadPhoto(photoPreview);
      await api(apiUrl,'addPurchases',{data:cart.map(p=>({ItemName:p.ItemName,MasterSKU:p.MasterSKU,BaseUnit:p.BaseUnit,Description:p.Description||'',ContainerType:p.ContainerType,ContainerSize:p.ContainerSize,ContainerUnit:p.ContainerUnit,Qty:p.Qty,Price:p.extTotal,Notes:'',Branch:BRANCH_NAME,BranchCode:BRANCH_CODE,PurchaseDate:header.PurchaseDate,Supplier:header.Supplier,PO:header.PO,InvoicePhoto:invoiceUrl||''}))});
      showToast(`Saved ${cart.length} items!`);
      setCart([]);setHeader({PurchaseDate:new Date().toISOString().split('T')[0],Supplier:'',PO:'',PayMethod:'Cash',InvoicePhoto:''});setPhotoPreview(null);setCheckout(false);onClose();loadAll();
    }catch(e){showToast(e.message,'error')}
    finally{setSaving(false)}
  };

  return(
    <div className="fixed inset-0 bg-black/50 z-50 flex items-end justify-center" onClick={onClose}>
      <div className="bg-white w-full max-w-lg h-[90vh] rounded-t-3xl flex flex-col slide-up" onClick={e=>e.stopPropagation()}>
        <div className="p-4 border-b flex justify-between items-center bg-gradient-to-r from-red-700 to-red-800 text-white rounded-t-3xl">
          <div><h3 className="font-bold text-lg">üõí Purchase Cart</h3><p className="text-sm text-red-200">{cart.length} items</p></div>
          <button onClick={onClose} className="text-2xl text-white/80">‚úï</button>
        </div>
        <div className="flex-1 overflow-y-auto">
          {cart.length===0?<div className="text-center py-12"><span className="text-6xl">üõí</span><p className="text-gray-400 mt-4">Your cart is empty</p><button onClick={onClose} className="btn btn-p mt-4">Start Shopping</button></div>:
          checkout?<div className="p-4 space-y-4">
            <h4 className="font-bold text-gray-700">üìù Order Details</h4>
            <div><label className="text-xs text-gray-500">Purchase Date</label><input type="date" value={header.PurchaseDate} onChange={e=>setHeader({...header,PurchaseDate:e.target.value})} className="inp"/></div>
            <div><label className="text-xs text-gray-500">Supplier Name</label><input value={header.Supplier} onChange={e=>setHeader({...header,Supplier:e.target.value})} className="inp" placeholder="Where did you buy from?"/></div>
            <div className="grid grid-cols-2 gap-3">
              <div><label className="text-xs text-gray-500">P.O. / Invoice #</label><input value={header.PO} onChange={e=>setHeader({...header,PO:e.target.value})} className="inp" placeholder="Reference #"/></div>
              <div><label className="text-xs text-gray-500">Payment Method</label><select value={header.PayMethod||''} onChange={e=>setHeader({...header,PayMethod:e.target.value})} className="inp">{payMethods.map(m=><option key={m} value={m.trim()}>{m.trim()}</option>)}</select></div>
            </div>
            <div><label className="text-xs text-gray-500">üì∑ Invoice Photo</label>
              {photoPreview?<div className="relative mt-1"><img src={photoPreview} alt="Invoice" className="w-full h-32 object-cover rounded-xl"/><button onClick={()=>setPhotoPreview(null)} className="absolute top-2 right-2 bg-black/50 text-white w-8 h-8 rounded-full">‚úï</button></div>:
              <label className="block border-2 border-dashed border-gray-300 rounded-xl p-6 text-center cursor-pointer hover:border-red-400 mt-1"><input type="file" accept="image/*" capture="environment" onChange={handlePhoto} className="hidden"/><span className="text-3xl">üì∑</span><p className="text-sm text-gray-500 mt-2">Tap to capture</p></label>}
            </div>
            <div className="bg-gray-100 rounded-xl p-3"><p className="text-sm text-gray-600 mb-2">Order Summary:</p>{cart.map((item,i)=><div key={i} className="flex justify-between text-sm py-1"><span className="truncate flex-1 mr-2">{item.ItemName} √ó {item.Qty}</span><span className="font-medium">{fmt(item.extTotal)}</span></div>)}<div className="border-t mt-2 pt-2 flex justify-between font-bold"><span>Total</span><span className="text-red-600">{fmt(cartTotal)}</span></div></div>
          </div>:
          <div className="p-4 space-y-3">{cart.map((item)=><div key={item.id} className="bg-gray-50 rounded-xl p-3 flex items-center gap-3"><div className="flex-1"><p className="font-medium">{item.ItemName}</p><p className="text-xs text-gray-500">{item.Qty} {item.ContainerType||'units'} √ó ‚Ç±{parseFloat(item.Price||0).toLocaleString()}</p></div><p className="font-bold text-red-600">{fmt(item.extTotal)}</p><button onClick={()=>removeItem(item.id)} className="text-gray-400 hover:text-red-500">‚úï</button></div>)}<button onClick={clearCart} className="w-full text-sm text-gray-400 py-2">Clear Cart</button></div>}
        </div>
        {cart.length>0&&<div className="p-4 border-t bg-white">
          <div className="flex justify-between items-center mb-3"><span className="text-gray-600">Total ({cart.length} items)</span><span className="text-2xl font-bold text-red-600">{fmt(cartTotal)}</span></div>
          {checkout?<div className="flex gap-3"><button onClick={()=>setCheckout(false)} className="flex-1 btn btn-s">‚Üê Back</button><button onClick={submitOrder} disabled={saving||uploading} className="flex-1 btn btn-p">{saving?'Saving...':uploading?'Uploading...':'‚úÖ Submit'}</button></div>:<button onClick={()=>setCheckout(true)} className="w-full btn btn-p text-lg py-4">Proceed to Checkout ‚Üí</button>}
        </div>}
      </div>
    </div>
  );
}

function ExpenseCartModal({cart,setCart,cartTotal,onClose,settings,apiUrl,showToast,loadAll}){
  const[saving,setSaving]=useState(false);
  const[uploading,setUploading]=useState(false);
  const[checkout,setCheckout]=useState(false);
  const[header,setHeader]=useState({Date:new Date().toISOString().split('T')[0],Payee:'',PayMethod:'Cash',ReceiptPhoto:''});
  const[photoPreview,setPhotoPreview]=useState(null);

  const payMethods=(settings.PaymentMethods||'Cash,GCash,Maya,Bank Transfer').split(',');
  const removeItem=(id)=>setCart(cart.filter(c=>c.id!==id));
  const clearCart=()=>{if(confirm('Clear entire cart?'))setCart([])};

  const handlePhoto=async(e)=>{const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=(ev)=>setPhotoPreview(ev.target.result);reader.readAsDataURL(file)};

  const uploadPhoto=async(base64)=>{
    setUploading(true);
    try{const filename=`RCP_${BRANCH_CODE}_${Date.now()}.jpg`;const result=await api(apiUrl,'uploadReceiptPhoto',{base64,filename,branchCode:BRANCH_CODE});return result.viewUrl||result.url;}
    catch(e){showToast('Photo upload failed','error');return null}
    finally{setUploading(false)}
  };

  const submitOrder=async()=>{
    if(cart.length===0){showToast('Cart is empty','error');return}
    setSaving(true);
    try{
      let receiptUrl=header.ReceiptPhoto;
      if(photoPreview&&!receiptUrl)receiptUrl=await uploadPhoto(photoPreview);
      await api(apiUrl,'addExpenses',{data:cart.map(e=>({Category:e.Category,Amount:e.Amount,Description:e.Description||'',Branch:BRANCH_NAME,BranchCode:BRANCH_CODE,Date:header.Date,Payee:header.Payee,PayMethod:header.PayMethod,ReceiptPhoto:receiptUrl||''}))});
      showToast(`Saved ${cart.length} expenses!`);
      setCart([]);setHeader({Date:new Date().toISOString().split('T')[0],Payee:'',PayMethod:'Cash',ReceiptPhoto:''});setPhotoPreview(null);setCheckout(false);onClose();loadAll();
    }catch(e){showToast(e.message,'error')}
    finally{setSaving(false)}
  };

  const defaultExpenseIcons={'Utilities':'üí°','Rent':'üè†','Salaries':'üë•','Supplies':'üì¶','Transportation':'üöó','Repairs':'üîß','Marketing':'üì¢','Miscellaneous':'üìã'};
  const getCategoryIcon=(cat)=>{if(settings.ExpenseIcons){const ci={};settings.ExpenseIcons.split(',').forEach(p=>{const[n,i]=p.split(':');if(n&&i)ci[n.trim()]=i.trim()});if(ci[cat])return ci[cat]}return defaultExpenseIcons[cat]||'üí∞'};

  return(
    <div className="fixed inset-0 bg-black/50 z-50 flex items-end justify-center" onClick={onClose}>
      <div className="bg-white w-full max-w-lg h-[90vh] rounded-t-3xl flex flex-col slide-up" onClick={e=>e.stopPropagation()}>
        <div className="p-4 border-b flex justify-between items-center bg-gradient-to-r from-amber-500 to-amber-600 text-white rounded-t-3xl">
          <div><h3 className="font-bold text-lg">üßæ Expense Cart</h3><p className="text-sm text-amber-200">{cart.length} items</p></div>
          <button onClick={onClose} className="text-2xl text-white/80">‚úï</button>
        </div>
        <div className="flex-1 overflow-y-auto">
          {cart.length===0?<div className="text-center py-12"><span className="text-6xl">üßæ</span><p className="text-gray-400 mt-4">No expenses yet</p><button onClick={onClose} className="btn btn-amber mt-4">Add Expenses</button></div>:
          checkout?<div className="p-4 space-y-4">
            <h4 className="font-bold text-gray-700">üìù Details</h4>
            <div><label className="text-xs text-gray-500">Date</label><input type="date" value={header.Date} onChange={e=>setHeader({...header,Date:e.target.value})} className="inp"/></div>
            <div className="grid grid-cols-2 gap-3">
              <div><label className="text-xs text-gray-500">Payee</label><input value={header.Payee} onChange={e=>setHeader({...header,Payee:e.target.value})} className="inp" placeholder="Who was paid?"/></div>
              <div><label className="text-xs text-gray-500">Payment Method</label><select value={header.PayMethod||''} onChange={e=>setHeader({...header,PayMethod:e.target.value})} className="inp">{payMethods.map(m=><option key={m} value={m.trim()}>{m.trim()}</option>)}</select></div>
            </div>
            <div><label className="text-xs text-gray-500">üì∑ Receipt Photo</label>
              {photoPreview?<div className="relative mt-1"><img src={photoPreview} alt="Receipt" className="w-full h-32 object-cover rounded-xl"/><button onClick={()=>setPhotoPreview(null)} className="absolute top-2 right-2 bg-black/50 text-white w-8 h-8 rounded-full">‚úï</button></div>:
              <label className="block border-2 border-dashed border-gray-300 rounded-xl p-6 text-center cursor-pointer hover:border-amber-400 mt-1"><input type="file" accept="image/*" capture="environment" onChange={handlePhoto} className="hidden"/><span className="text-3xl">üì∑</span><p className="text-sm text-gray-500 mt-2">Tap to capture</p></label>}
            </div>
            <div className="bg-amber-50 rounded-xl p-3"><p className="text-sm text-gray-600 mb-2">Summary:</p>{cart.map((item,i)=><div key={i} className="flex justify-between text-sm py-1"><span>{getCategoryIcon(item.Category)} {item.Category}</span><span className="font-medium">{fmt(item.Amount)}</span></div>)}<div className="border-t mt-2 pt-2 flex justify-between font-bold"><span>Total</span><span className="text-amber-600">{fmt(cartTotal)}</span></div></div>
          </div>:
          <div className="p-4 space-y-3">{cart.map((item)=><div key={item.id} className="bg-amber-50 rounded-xl p-3 flex items-center gap-3"><span className="text-2xl">{getCategoryIcon(item.Category)}</span><div className="flex-1"><p className="font-medium">{item.Category}</p><p className="text-xs text-gray-500">{item.Description||'No description'}</p></div><p className="font-bold text-amber-600">{fmt(item.Amount)}</p><button onClick={()=>removeItem(item.id)} className="text-gray-400 hover:text-red-500">‚úï</button></div>)}<button onClick={clearCart} className="w-full text-sm text-gray-400 py-2">Clear All</button></div>}
        </div>
        {cart.length>0&&<div className="p-4 border-t bg-white">
          <div className="flex justify-between items-center mb-3"><span className="text-gray-600">Total ({cart.length} items)</span><span className="text-2xl font-bold text-amber-600">{fmt(cartTotal)}</span></div>
          {checkout?<div className="flex gap-3"><button onClick={()=>setCheckout(false)} className="flex-1 btn btn-s">‚Üê Back</button><button onClick={submitOrder} disabled={saving||uploading} className="flex-1 btn btn-amber">{saving?'Saving...':uploading?'Uploading...':'‚úÖ Submit'}</button></div>:<button onClick={()=>setCheckout(true)} className="w-full btn btn-amber text-lg py-4">Checkout ‚Üí</button>}
        </div>}
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
